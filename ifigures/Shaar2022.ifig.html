<!DOCTYPE html>
 <html> 
 <head> 
<!--ifigure
{"metadata":{"platform":"ifigures","version":"2023.1.4.1","previous_version":"2022.12.7.1","modifications":"Fixed bug: in previous versions, URL could not have queries without addressing the load setup. Now it can. To achieve this, the *** load ifigure setup cell and the LoadURL() function were modified. Queries still need to be given in a JASON format. The resulting parsed object is saved in ballab.URLobj as before. If no query is provided the ballab.URLobj is an empty (but defined) object","URL_dir":"https://webhome.weizmann.ac.il/home/ifigures/","URL":"https://webhome.weizmann.ac.il/home/ifigures/ifigure.ifig.html"},"contents":[{"type":"Conteval","exp":"time //  זמן בשניות"},{"type":"Conteval","exp":"Ekc // אנר תנועה משותפת"},{"type":"Conteval","exp":"Eki // אנר תנועה פנימית"},{"type":"Conteval","exp":"Eel // סך אנרגיה אלסטית"},{"type":"Conteval","exp":"Mgh // סך אנרגית כובד "},{"type":"iscriptLibrary","iscripts":[{"name":"OnLoadIfigure","script":"initialize()\nparameters()\nsetFollowMouse()\nif(ballab.URLobj.nolines){draw_lines=false}\nswitch(ballab.URLobj.setup){\ncase \"TwoParticles\" :initializeTwoParticles();break\ncase \"Rectangle\":initializeRectangle();break\ncase \"Circle\":initializeCircle();break\ndefault: initializeRectangle()\n}\n\n\n","arguments_string":"()"},{"name":"startRectangle","script":"Nx=3\nNy=2\ny0=1 \nSlowMotion=5 \n\n\nsetupRectangle()\n\n","arguments_string":"()"},{"name":"step","script":"***\nps.map(p=>{\n if(!p.freeze){\n p.x+=p.vx*dt; p.y+=p.vy*dt}\n p.ay=-g+(p.y<0)*(-kfloor/m*p.y); p.ax=0\n})\n\nsprings.map((s,i)=>{\nlet p1=ps[s.i1]; let p2=ps[s.i2];\nlet dx=p2.x-p1.x; let dy=p2.y-p1.y;\nlet d=Math.sqrt(dx**2+dy**2);\nif(d<fmax*s.L){\n s.on=true\n let a=k/m*(d-s.L)\n let ax=a*dx/d; let ay=a*dy/d;\n p1.ax+=ax; p2.ax+=-ax;\n p1.ay+=ay; p2.ay+=-ay;\n} else {s.on=false}\n})\n\nps.map(p=>{\nif(!p.freeze){\np.vx+=p.ax*dt; p.vy+=p.ay*dt}});\n","arguments_string":"()"},{"name":"rotate","script":"ps.map(p=>{\nlet x=p.x*cos(alpha)-p.y*sin(alpha)\nlet y=p.x*sin(alpha)+p.y*cos(alpha)\np.x=x;\np.y=y;\n})","arguments_string":"(alpha)"},{"name":"calcEs","script":"calcCM()\nh=CM.y\n\ncalcEintp()\n\nEktot=0\nEintk=0\nps.map(p=>{\n Eintk+=0.5*m*((p.vx-CM.vx)**2+(p.vy-CM.vy)**2)\n Ektot+=0.5*m*(p.vx**2+p.vy**2)\n})\nEint=Eintk+Eintp\n\nEfloor=0\nps.map(p=>{Efloor+=0.5*kfloor*(p.y<0)*p.y^2})\n","arguments_string":"()"},{"name":"calcCM","script":"let x=0; let y=0; let Px=0; let Py=0;\nM=0\nps.map(p=>{x+=m*p.x; y+=m*p.y; Px+=m*p.vx; Py+=m*p.vy; M+=m})\nlet vx=Px/M; \nlet vy=Py/M;\nCM={x:x/M,y:y/M,vx:vx,vy:vy,Ek:M*(vx**2+vy**2)/2}\n","arguments_string":"()"},{"name":"parameters","script":"g=9.8 // תאוצת המשיכה\nm=0.01 // מסת חלקיק\nL0=0.4 // אורך רפוי\nangle=0 // זווית סיבוב\nkfloor=1e5 // קשיחות הרצפה\ndt_factor=0.01 // מקדם דיוק\nk=100 // קשיחות קפיצים\nCr=0.05 // גודל חלקיקים\ndraw_lines=true // ציור הקווים\nfmax=30 // מתיחה מקסימלית\nfollowMouse.followX=true\n// מעקב אחר עכבר אופקי\nfollowMouse.followY=true \n// מעקב אחר עכבר אנכי\n\nEShowNround=2 //ספרות משמעותיות אנרגיות\nEShowMin=1e-5 // אנרגיה מינימלית מוצגת\ntNround=2 //ספרות אחרי הנקודה זמן\n\n","arguments_string":"()"},{"name":"setupRectangle","script":"RepeatStop()\nt=0\nps=[]\nsprings=[]\ni1=0\n\n\nfor(let ly=0;ly<Ny;ly++){\nlet p1={x:0,y:ly*L0,vx:0,vy:0,ax:0,ay:0}\nif(ly>0){\n springs.push({i1:i1,i2:(ly-1)*Nx,L:L0,on:true})\n}\nps.push(p1);\nfor(let lx=1;lx<Nx;lx++){\n let p2={x:lx*L0,y:ly*L0,vx:0,vy:0,ax:0,ay:0}\n let i2=i1+1;\n springs.push({i1:i1,i2:i2,L:L0,on:true})\n \n if(ly>0){\n   springs.push({i1:i1,i2:(ly-1)*Nx+lx,L:sqrt(2)*L0,on:true})\n   springs.push({i1:i2,i2:(ly-1)*Nx+lx-1,L:sqrt(2)*L0,on:true})\n   springs.push({i1:i2,i2:(ly-1)*Nx+lx,L:L0,on:true})\n }\n p1=p2 \n ps.push(p1)\n i1=i2\n}\ni1+=1}\n\nrotate(angle/180*pi);\n\nps.map(p=>p.y+=y0)\ncalcCM()\nps.map(p=>p.x+=-CM.x)\n\nLlim=y0+Nx*L0+Ny*L0+0.2\nxlim(-Llim/2,Llim/2)\nylim(0,Llim)\ndraw()\n","arguments_string":"()"},{"name":"fullstep","script":"dt_refresh=0.01/SlowMotion\nlet kmax=max([k,kfloor])\ndt=1/sqrt(kmax)*dt_factor \nsteps_per_refresh=dt_refresh/dt;\nfor(let l=0;l<steps_per_refresh;l++){\n step()\n}\nt+=steps_per_refresh*dt\nupdate_fig()\n","arguments_string":"()"},{"name":"update_fig","script":"***\nif(draw_lines){\nsprings.map((s,i)=>{\nif(s.on){\nLs[i].style.display='block'\nLs[i].set_data( [ ps[s.i1].x , ps[s.i2].x ] , [ ps[s.i1].y , ps[s.i2].y ] )\n} else {Ls[i].style.display='none'}\n})}\nCs.map((C,i)=>{\nC.x=ps[i].x; C.y=ps[i].y; Csc[i].x=ps[i].x; Csc[i].y=ps[i].y;\nCsc[i].style.display=ps[i].freeze?\"block\":\"none\"\n})\nif(show_forces) {\n  Fs.map((f,i)=>f.set_data([ps[i].x, ps[i].x+ps[i].ax*m],[ps[i].y,ps[i].y+ps[i].ay*m]));\n  UpArrowHead.map((u,i)=>u.set_data([ps[i].x+ps[i].ax*m*0.8, ps[i].x+ps[i].ax*m],[ps[i].y+0.03,ps[i].y+ps[i].ay*m]));\n  DownArrowHead.map((u,i)=>u.set_data([ps[i].x+ps[i].ax*m*0.8, ps[i].x+ps[i].ax*m],[ps[i].y-0.03,ps[i].y+ps[i].ay*m]));\n}\n\ncalcEs()\ncalcForces()\ntime=round(t,tNround)\nv1=ps[0]?ERound(sqrt(ps[0].vx**2+ps[0].vy**2)):0\nv2=ps[1]?ERound(sqrt(ps[1].vx**2+ps[1].vy**2)):0\nF1=ps[0]?ERound(ps[0].ax*m):0\nF2=ps[1]?ERound(ps[1].ax*m):0\nMgh=ERound(M*g*h)\nEkc=ERound(CM.Ek)\nEki=ERound(Eintk)\nEk=ERound(Ektot)\nEel=ERound(Eintp)\nEtot=ERound(Ektot+Eintp+M*g*h+Efloor)","arguments_string":"()"},{"name":"setFollowMouse","script":"ballab.figure_current.plot_click_rect.addEventListener(\"click\",\nfunction(){\nif(ballab.figure_current.buttons.cross.down){\nfindParticleClick(false)}}\n)\n\nballab.figure_current.plot_click_rect.addEventListener(\"dblclick\",\nfunction(){if(ballab.figure_current.buttons.cross.down){\nfindParticleClick(true)}}\n)\n\n\ndocument.addEventListener('keydown', (event) => {\n  var name = event.key;\n  var code = event.code;\n  if ( name==\" \" ) {\nif(ballab.repeat_cell.isRepeating){RepeatStop()}\n else {RepeatGo()}\n}\n}, false);\n\nsetInterval(\nfunction(){\nif(followMouse.on && (!isNaN(PointingX())) ){\n if(followMouse.followX){followMouse.p.x=PointingX()}\n if(followMouse.followY){followMouse.p.y=PointingY()}\nupdate_fig()\n}\n}\n,10)\n","arguments_string":"(dbclick)"},{"name":"calcEintp","script":"***\nEintp=0\nEchem=0\nsprings.map((s,i)=>{\nif(s.on){\nlet p1=ps[s.i1]; let p2=ps[s.i2];\nlet dx=p2.x-p1.x; let dy=p2.y-p1.y;\nlet d=Math.sqrt(dx**2+dy**2)\nEintp+=0.5*k*(d-s.L)**2} else\nEchem+=0.5*k*(s.L*(fmax-1))**2\n})","arguments_string":"()"},{"name":"setupCircle","script":"RepeatStop()\nif( y0>1 || y0<0 ){ alert(\"y0 must be between 0 and 1\"); return}\nk=10000 \nN1=20\n\nt=0\nlet Nrings=Rs.length\nlet irad=2*pi/N1\nlet dinin=Math.sqrt( (cos(irad)-1)**2 + sin(irad)**2 )\nlet Linins=Rs.map(R=>R*dinin)\nlet iinout=[0:Nrings-1]\nlet Linouts=iinout.map(iR=>Math.sqrt( ( cos(irad/2)*Rs[iR+1] - Rs[iR] )**2 + (sin(irad/2)*Rs[iR+1])**2 ))\nps=[]\nsprings=[];\niring=[0:N1]\nRs.map((R,iR)=>{\n let dte = iR / 2 * irad\n iring.map(i=>ps.push({\n  x:R*cos(i*irad + dte),\n  y:R*sin(i*irad + dte),\n  vx:0,vy:0,\n  ax:0,ay:0\n }))\n iring.map(i=>{\n  springs.push({i1:iR*N1 + i, i2:iR*N1 + (i+1)%N1, L:Linins[iR],on:true})\n })\n})\n\niinout.map(iR=>{\n iring.map(i=>{\n  springs.push({\n   i1:iR*N1 + i, \n   i2:(iR+1)*N1 + i, \n   L:Linouts[iR],\n   on:true\n  })\n  springs.push({\n   i1:(iR+1)*N1 + i,\n   i2:iR*N1 + (i+1)%N1,\n   L:Linouts[iR],\n   on:true\n  })\n })\n})\n\nrotate(-pi/2)\nps.map(p=>p.y+=y0+Rs[Nrings-1])\nLlim=y0+Rs[Nrings-1]*3\nxlim(-Llim/2,Llim/2)\nylim(0,Llim)\ndraw()","arguments_string":"()"},{"name":"startCircle","script":"y0=0.5\nSlowMotion=10 \n \n\n \n\n\nsetupCircle()\n","arguments_string":"()"},{"name":"setupBonding","script":"addTriangle=function(x,y,vx,vy,L0){\nps.push({x:x-L0/2,y:y,vx:vx,vy:vy,ax:0,ay:0})\nps.push({x:x+L0/2,y:y,vx:vx,vy:vy,ax:0,ay:0})\nps.push({x:x,y:y+L0*sqrt(3/4),vx:vx,vy:vy,ax:0,ay:0})\n}\nt=0\nps=[]\nparameters()\nCr=0.02; dt_factor=0.001\ng=0; kfloor=1000; \nfmax=1.2\ny0=0.5; L0=0.1; m=1; k=100;SlowMotion=1\ndx=0.25;dvx=0.01; dy=0.05; xlim(-1,1); ylim(-1,1)\naddTriangle(-dx/2,y0-dy/2,dvx/2,0,L0)\naddTriangle(dx/2,y0+dy/2,-dvx/2,0,L0)\nN=ps.length\nsetAllSprings(L0)\ndraw()","arguments_string":"()"},{"name":"setAllSprings","script":"let N=ps.length\nsprings=[]\nfor(let i1=0; i1<N; i1++){\nfor(let i2=i1+1; i2<N; i2++){\nlet p1=ps[i1]; let p2=ps[i2];\nlet dx=p2.x-p1.x; let dy=p2.y-p1.y;\nlet d=Math.sqrt(dx**2+dy**2);\nsprings.push({i1:i1,i2:i2,L:L0,on:(d<L0*fmax)})\n}}","arguments_string":"(L0)"},{"name":"findParticle","script":"let d2min=Infinity\nlet ip=undefined\nlet hit=false\nps.map((p,i)=>{\nlet d2=(p.x-x)**2+(p.y-y)**2\nif(d2<0.25*L0**2 && d2<d2min){d2min=d2; ip=i; hit=true}\n})\nreturn {hit:hit,ip:ip}","arguments_string":"(x,y)"},{"name":"findParticleClick","script":"if((!followMouse.on) || dblclick){\nif(dblclick){followMouse.on=false}\nlet findp=findParticle(PointingX(),PointingY())\nif(findp.hit){\n let p=ps[findp.ip]\n if(dblclick){\n  p.freeze=false\n } else {\n  p.freeze=true\n  p.vx=0\n  p.vy=0\n  followMouse.p=p\n  followMouse.on=true\n }\n}\n} else {followMouse.on=false}\n\n","arguments_string":"(dblclick)"},{"name":"play","script":"","arguments_string":"()"},{"name":"initialize","script":"ContEvals=ballab.ifigure_objects.filter(obj => {\nreturn obj.type=='Conteval'\n})\nCodeCells=ballab.ifigure_objects.filter(obj => {\nreturn obj.type=='Cell_code'\n})\n\nfollowMouse={\n on:false, \n p:undefined, \n x:undefined,\n y:undefined,\n followX:true,\n followY:true,\n updatePos:function(){\n  if(!isNaN(PointingX())){this.x=PointingX()} else {this.on=false}\n  if(!isNaN(PointingY())){this.y=PointingY()} else {this.on=false}\n }\n}\n\nContEvals[0].exp.value=\"time //  זמן בשניות\"\nContEvals[1].exp.value=\"Ekc // אנר תנועה משותפת\"\nContEvals[2].exp.value=\"Eki // אנר תנועה פנימית\"\nContEvals[3].exp.value=\"Eel // סך אנרגיה אלסטית\"\nContEvals[4].exp.value=\"Mgh // סך אנרגית כובד \"\nclc()\nprint(\":יחידות\")\nprint(\"זמן: שניה\")\nprint(\"מרחק: מטר\")\nprint('מסה: ק״ג')\nprint(\"כח: ניוטון\")\nprint(\"אנרגיה: גא׳ול\")\nprint(\"קבוע אינטראקציה: ניוטון למטר\")\nballab.terminal.output_field.style.textAlign= 'right';\n\n\nCodeCells[1].loadIscript(ballab.iscriptLibrary.getIscriptByName(\"play\"))\n","arguments_string":"()"},{"name":"startTwoParticles","script":"k=1\nL0=0.5\nm=0.01\nSlowMotion=15\nshow_forces=true // true or false\n\n\n\nsetupTwoParticles()","arguments_string":"()"},{"name":"setupTwoParticles","script":"t=0\ng=0\nfollowMouse.followY=false \nps=[]\nsprings=[]\nps.push({x:-L0/2,y:1,vx:0,vy:0,ax:0,ay:0})\nps.push({x:L0/2,y:1,vx:0,vy:0,ax:0,ay:0})\nsprings.push({i1:0,i2:1,L:L0,on:true})\nLlim=3*L0+0.2\nxlim(-Llim/2,Llim/2)\nylim(1-Llim/2,1+Llim/2)\ndraw()\nCs[1].color=\"green\"\nRepeatGo()","arguments_string":"()"},{"name":"ERound","script":"if(abs(E)<EShowMin){return 0}\nreturn roundSignificant(E,EShowNround)","arguments_string":"(E)"},{"name":"initializeRectangle","script":"\nCodeCells[0].loadIscript(ballab.iscriptLibrary.getIscriptByName(\"startRectangle\"))\n\n\nstartRectangle()","arguments_string":"()"},{"name":"initializeTwoParticles","script":"ContEvals[0].exp.value=\"time // זמן\"\nContEvals[1].exp.value=\"Ek // סך אנרגיה קינטית\"\nContEvals[2].exp.value=\"Eel // אנרגיה אלסטית\"\nContEvals[3].exp.value=\"F1 // כח על חלקיק כחול\"\nContEvals[4].exp.value=\"F2 // כח על חלקיק ירוק\"\nCodeCells[0].name_input.value\n\nCodeCells[0].loadIscript(ballab.iscriptLibrary.getIscriptByName(\"startTwoParticles\"))\n\nCodeCells[1].loadIscript(ballab.iscriptLibrary.getIscriptByName(\"play\"))\n\nCr=0.05\n\nstartTwoParticles()\n","arguments_string":"()"},{"name":"initializeCircle","script":"CodeCells[0].loadIscript(ballab.iscriptLibrary.getIscriptByName(\"startCircle\"))\n\nRs=[0.125,0.15,0.175]\nCr=0.01\nstartCircle()","arguments_string":"()"},{"name":"calcForces","script":"ps.map(p=>{\n p.ay=-g+(p.y<0)*(-kfloor/m*p.y); p.ax=0\n})\n\nsprings.map((s,i)=>{\nlet p1=ps[s.i1]; let p2=ps[s.i2];\nlet dx=p2.x-p1.x; let dy=p2.y-p1.y;\nlet d=Math.sqrt(dx**2+dy**2);\nif(d<fmax*s.L){\n s.on=true\n let a=k/m*(d-s.L)\n let ax=a*dx/d; let ay=a*dy/d;\n p1.ax+=ax; p2.ax+=-ax;\n p1.ay+=ay; p2.ay+=-ay;\n} else {s.on=false}\n})","arguments_string":"()"},{"name":"draw","script":"clf()\nif(draw_lines){\nLs=springs.map(s=>Line([ps[s.i1].x,ps[s.i2].x],[ps[s.i1].y,ps[s.i2].y],'r'))\n}\nCs=ps.map(p=>Circle(p.x,p.y,Cr));\nif(show_forces){\n  Fs=ps.map(p=>Line([p.x, p.x+p.ax],[p.y,p.y+p.ay],\"black-\",3));\n  UpArrowHead=ps.map(p=>Line([p.x+0.8*p.ax, p.x+p.ax],[p.y+0.03,p.y+p.ay],\"black-\",2));\n  DownArrowHead=ps.map(p=>Line([p.x+0.8*p.ax, p.x+p.ax],[p.y-0.03,p.y+p.ay],\"black-\",2));\n}\nCsc=ps.map(p=>Circle(p.x,p.y,Cr/3,'black'));\nupdate_fig()\n","arguments_string":"()"}]},{"type":"Figure","xlabel":"  מיקום אופקי [מטרים]","ylabel":"גובה [מטרים]"},{"type":"Cell_code","iscript_name":"startTwoParticles"},{"type":"Cell_code","iscript_name":"draw"},{"type":"Cell_code_repeat","script":"fullstep()\n\n","dt_script":"0.01"},{"type":"Instructions","name":"Welcome","contents":""}]}
ifigure-->
<!-- ***** i f i g u r e s *****
ifigures Copyright (c) 2018 Boaz Katz, Weizmann Institute of Science & Schwartz/Reisman Science Education Center, Rehovot, Israel

Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<style>
	* {
	    font: 15px Arial, sans-serif;
	}
  
    /* make sure scroll bar appears when there is overflow in the list of functions start*/
    ::-webkit-scrollbar {
      -webkit-appearance: none;
      width: 7px;
    }

    ::-webkit-scrollbar-thumb {
      border-radius: 4px;
      background-color: rgba(0, 0, 0, .5);
      box-shadow: 0 0 1px rgba(255, 255, 255, .5);
    }
    /* make sure scroll bar appears when there is overflow in the list of functions end*/
  
    .codefont {
        font: 15px Courier; /* need to separately update this font in .dropdown-content a   and  .help-functions a  */
    }
	tab { padding-left: 4em; }
    html, body { 
      height: 100%; 
      margin:0; 
      display:grid;
      grid-template-rows: 10 auto;
    } /*overflow: hidden } /*overflow-y: hidden}*/
    .alert{
        position:absolute;
        left: 50px;
        top: 50px;
        width:300px;
        height:300px;
        z-index:1000;
    }
    .alert textarea{
        width:100%;
        height:100%;
    }
    .main_window{
        height: 100%;
        width:100%;
        display:grid;
        grid-template-columns: auto 230px;
        grid-gap:10px;
		}
    .cell_grid {
        display:grid;
        grid-template-columns: auto 522px;
        grid-template-rows: auto auto auto;
        grid-gap:10px;
        overflow:scroll;
        overflow-y:hidden;
        align-content:start;
        padding-left:10px;
        /*justify-items: center;
        align-items: center;*/
	}
	.sidebar{
		display: -webkit-flex; /* Safari */
		    -webkit-align-items: stretch; /* Safari 7.0+ */
		display: flex;
		flex-direction: column;
		align-items: stretch;
		padding:0px;
        margin-top:0px;
        margin-right:10px;
	}
	.sidebar > div{
		margin-top:6.2px;
	}
    .hidden{
        width:0;
        height:0;
        border:0; 
        border:none;
    }
    .terminal_output {
		margin:0;
        padding:3px;
		height:227px;
		resize:vertical;
        border:solid 0.1px #979797;
		/*border-top-style:none;
		border-left: solid 2px Black;
		border-right: solid 2px Black;
		border-bottom: solid 2px Black;*/
		/*border-style:none;*/
		background-color: #404040;
		color: #d7d7d7;
	}
    
    .top_menu{
		display: -webkit-flex; /* Safari */
		    -webkit-align-items: stretch; /* Safari 7.0+ */
		display: flex;
		flex-direction: row;
		align-items: center;
        background-color: #262626;
		padding-left:20px;
        margin-top:0;
        margin-left:0;
        height:40px;
        /*position:absolute;*/
	}
    .top_menu-list{
      position: relative;
      display: inline-block;
      padding:none;
      padding-top:0px;
      margin-top:none; 
      cursor: pointer;
    }
    .top_menu-list_name{
        color:white;
        background: none;
        border-style: none;
        text-align: center;
        font-size: 16px;
        width:5em;
        height:100%;
        margin:none;
        padding-right:20px;
    }
    .top_menu-content {
      display: none;
      position: absolute;
      z-index:1;
    }
    .top_menu-content a {
      color: white;
      background-color:#262626;
      font-size: 15px;
      white-space: nowrap;
      padding: 5px 10px;
      text-decoration: none;
      display: block;
    }
    .top_menu a:hover {color: #62BCFF} /*#ddd*/
    .dropdown {
      position: relative;
      display: inline-block;
      padding:none;
      padding-top:3px;
      background-color:#555555;
      margin:none;
      border-style:none;
    }
    .dropdown-title{
        background-color: #555555;
        color:#FFFFFF;
        /*border-style:solid 1px #979797;*/
        border-style:none;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: white;/*#f6f6f6;*/
      min-width: 230px;
      overflow: scroll;
      max-height: 250px;
      border: 1px solid #ddd;
      z-index:50;
    }
    .dropdown-content a {
      color: black;
      padding: 5px 10px;
      text-decoration: none;
      display: block;
      font: 15px Courier;
    }
    .dropdown a:hover {
        background-color: #33BAFF;
    } 
    .help-functions-container {
        padding:10px;
        background-color:#404040;
        position: absolute;
        top: 10%;
        left: 10%;
        /*margin-top: -225px;*/
        /*margin-left: -400px;*/
        /*top: 10px;
        left: 10px;*/
        border-radius: 20px;
        width: 800px;
        height: 550px;
    }
    .help-functions {
        /*border: 2px #ccc;*/
        /*background-color:#404040;
        position: absolute;
        left: 5px;
        top: 20px;
        border-radius: 20px;
        width: 480px;
        height: 500px;*/
        margin: 20px auto;
        padding: 20px;
        /*padding-top:60px;*/
        display:grid;
        grid-template-columns: auto auto auto auto;
        grid-template-rows: repeat(15, auto);
        grid-gap:10px;
        grid-auto-flow: column;
        /*overflow:scroll;*/
        align-content:start;
        cursor: pointer;
    }
    .help-functions a {
        font: 15px Courier;
    }
    .help-functions-close{
        position: absolute;
        right: 25px;
        bottom: 25px;
        border-radius: 5px;
    }
    .help-functions-close-top{
        position: absolute;
        right: 25px;
        top: 20px;
        border-radius: 5px;
    }
    .load-file-drop-area {
      border: 2px dashed #ccc;
      background: white;
      position: absolute;
      left: 5px;
      top: 5px;
      border-radius: 20px;
      width: 480px;
      margin: 100px auto;
      padding: 20px;
    }
    .load-file-drop-area.highlight {
        border-color: purple;
    }
    
    .output_field {
        background-color: #404040;
		color: #d7d7d7;
        border:solid 0.1px #979797;
        padding-left:5px;
    }
	.conteval{
		/*width:200px;*/
        display: -webkit-flex; /* Safari */
		         -webkit-align-items: stretch; /* Safari 7.0+ */
		display: flex;
		flex-direction: column;
		align-items: stretch;
		height:2em;
        border-style:none;
        margin-bottom:20px;
        
		/*margin:1em 0;*/
	}
    .conteval_exp{
        border-style:none;
        background-color: #555555;
        color:#d7d7d7;
        /*font-size: 83%;*/
        padding-left:5px;
	}
    .save {
        margin-top:0;
        padding-top:0;
    }
    .div-wrap {
        padding:none;
        margin:none;
        border-style:none;
    }
    
    .cell_group{
		display: -webkit-flex; /* Safari */
		    -webkit-align-items: stretch; /* Safari 7.0+ */
		display: flex;
		flex-direction: column;
		align-items: stretch;
		padding:0;
        margin:0;
        /*width:100%;*/
	}
	.cell {
		padding:none;
        padding-left:0;
		margin:4px 0;
		display:flex;
		flex-direction: column;
        align-items: stretch;
        min-width:200px;
	}
    .cell_main {
        border:none;
		/*border-top-style:none;
		border-left: solid 2px Black;
		border-right: solid 2px Black;
		border-bottom: solid 2px Black;*/
        margin:none;
        padding:none;
        display:flex;
		flex-direction: column;
        align-items: stretch;
	}
    .fig_div {
        margin:0;
        padding:0;
        
        border-style: none;
        position:relative;
        top:0;
        bottom:0;
    }
    .fig_background {
        background-color:white;
        position:absolute;
        height:100%;
        width:100%;
        z-index:-2;
        
    }
    
    .image_box{
        margin:0;
        padding:0;
        width:390px;
        height:390px;
        position:absolute;
        overflow:hidden;
        pointer-events: none;
        z-index: -1;
    }
    .image_stage{
        margin:0;
        padding:0;
        width:390px;
        height:390px;
        position:absolute;
        visibility:hidden;
        transform-origin:left top;
        background-color:green;
        pointer-events: none;
        z-index: -1;
    }
    .window_svg {
        position: absolute;
        top:0;
        left:0;
    }
    
	.codearea {
		margin:0px;
        padding:3px;
        height:135px;
		resize:vertical;
        /*border-style:solid 0.1px #979797;*/
        border-style:none;
        background-color: #555555;
        color:#d7d7d7;
	}
    .save_button{
        text-align:left;
        width:10px;
        font-size:25px;
        border-style:none;
		padding-left:5px;
        padding-top:5px;
		margin:none;
        color:#FFFFFF;
        /*height:27px;*/
		background-color:#555555;
    }
    .save_button:hover{
        cursor:pointer;
        color:#62BCFF}
    
    
    .show {display: block;}

	.banner {
        /*border-style:none;*/
		border-style:solid 1px #979797;
		height:27px;
        margin:3px 0;
        padding:none;
		background-color:#555555;/*#33BAFF;*/
        display:flex;
		flex-direction: row;
        align-items: stretch;
        justify-content:  space-between;
        background-color: #555555; 
        white-space: nowrap;
	}
	.banner_text {
        border-style:none;
		padding-left:5px;
		margin:none;
        color:#FFFFFF;
        /*height:27px;*/
		background-color:#555555;
	}
    .text_hover{}
    .text_hover:hover{color:#62BCFF}
    .input_hover:hover{
        cursor:pointer;
        background-color: #62BCFF}

    .axis_excess_text {
        padding:0;
		margin:0;
		border-style:none;
    }    
    .video{
        margin:0;
        padding:0;
        position:absolute;
        top:0px;
        left:0px;
        transform-origin:left top;
        transform:translate(0,0) scale(1,1);
        background-color:green;
    }
</style>
<noscript>
	<br>
	*****
	<br>
	<b>OOPS! For some reason Javascript was not able to run in the browser. This could happen if you open this file directly from an email. In such a case, first copy the file to your computer and only then open it. Alternatively, Javascript may be currently disabled in your browser</b>. <br>
	See instructions to enable Javascript in this <a href="https://www.enable-javascript.com/">link</a>.
	<br>
	*****
	<br><br><br><br><br>
</noscript>
<!-- End of head, anything else up to the </head> will be removed --></head>
<body>
<script>//<!-- internal functions -->
// *** internal libraries
function import_topMenuLib(){
    let topMenuLib={}
    class TopMenu{
        constructor(parent_div){
            let div=document.createElement("div")
            div.className="top_menu"
            parent_div.appendChild(div)
            this.div=div
            this.lists=[]
        }
        Add(list){
            this.lists.push(list)
            this.div.appendChild(list.div)
        }
            
        }
    class TopMenuList{
        constructor(name,top_menu){
            this.top_menu=top_menu
            let div=document.createElement("div")
            div.className="top_menu-list"
            let title=document.createElement("a")
            title.className="top_menu-list_name"
            title.value=name
            title.text=name
            this.on=false
            let this_list=this;
            div.appendChild(title)
            this.div=div;
            this.title=title;
            top_menu.Add(this);
            this.items=[]
            let content_div=document.createElement("div")
            content_div.className="top_menu-content"
            title.onclick=function(){this_list.Toggle()}
            div.DoOnMouseout=function(event){this_list.Off()}
            div.onmouseout=DoOnMouseout;
            this.div.appendChild(content_div)
            this.content_div=content_div;

        }
        Add(item){
            this.items.push(item)
            this.content_div.appendChild(item.a)
        }
        Off(){
            this.on=false;
            this.content_div.style.display="none";
        }
        On(){
            this.on=true;
            this.content_div.style.display="block";
        }
        Toggle(){
            if(this.on){this.Off()}
            else{this.On()}
        }

    }
    class TopMenuItem{
        constructor(name,list,fun){
            this.list=list;
            let this_item=this;
            let a=document.createElement("a");
            a.value=name;
            a.text=name;
            a.onclick=function(event){fun(event); this_item.list.Off()}
            this.a=a;
            list.Add(this);
        }
    }
    topMenuLib.TopMenu=TopMenu;
    topMenuLib.TopMenuList=TopMenuList;
    topMenuLib.TopMenuItem=TopMenuItem;
    return topMenuLib;
}
function import_cellLib(){
    let cellLib={};
    cellLib.svgLib=import_svgLib();
    cellLib.draw=import_draw();
    cellLib.magic=import_MagicSyntax();
    cellLib.main_window=document.createElement("div");
    cellLib.main_window.className="main_window";
    cellLib.cell_grid=new Cell_grid(cellLib.main_window);
    cellLib.cell_grid.cells=[[null,null],[null,null],[null,null]];
        
    function Cell_grid(parent_div){
        this.cells=[];
        this.div=document.createElement("div");
        this.parent_div=parent_div;
        this.parent_div.insertBefore(this.div, this.parent_div.childNodes[0]);
        this.div.className="cell_grid";
    }
    function Create_cell_group(row,col){
        let div=document.createElement("div");
        cellLib.cell_grid.div.appendChild(div);
        div.className="cell_group";
        cellLib.cell_grid.cells[row-1][col-1]=div;
        div.style.gridColumn=col.toString();
        div.style.gridRow=row.toString();
    }
    function Cell(){
        this.div=document.createElement("div");
        //cellLib.cell_grid.div.appendChild(this.div);
        this.div.className="cell";
        this.banner=document.createElement("div");
        this.banner.className="banner";
        this.div.appendChild(this.banner);
        this.cell_main=document.createElement("div");
        this.cell_main.className="cell_main";
        this.div.appendChild(this.cell_main);
        //this.setColRowS=function(strc,strr){
        //    this.div.style.gridColumn=strc;
        //    this.div.style.gridRow=strr;
        //}
        this.move_to=function(row,col){
            if(cellLib.cell_grid.cells[row-1][col-1]==null){Create_cell_group(row,col)}
            cellLib.cell_grid.cells[row-1][col-1].appendChild(this.div);
            //this.div.style.gridColumn=col.toString();
            //this.div.style.gridRow=row.toString();
        }
    }
    function Terminal(){// terminal for printing and preforming single tasks  
        this.div=document.createElement("div");
        this.div.className="cell";
        this.input=document.createElement("INPUT");
        this.input.value="";
        this.input.placeholder="Code + Enter";
        this.input.id="terminal_var";
        this.input.className='conteval_exp codefont'
        this.cell_main=document.createElement("div");
        this.cell_main.className="cell_main";
        this.output_field=document.createElement("textarea");
        this.output_field.className="terminal_output";
        this.output_field.readOnly=true;
        this.cell_main.appendChild(this.output_field);
        this.div.appendChild(this.input);
        this.div.appendChild(this.output_field);
        this.terminal_run=function(){
            let input=this.input;
            this.print("> "+input.value)
            try {
                let code = cellLib.magic.magic_syntax(input.value);
                eval(code);
            }
            catch(err) {
                this.ErrorPrint(err);
            }
            input.value="";
        }
        this.print=function(stuff) {
            let logp=this.output_field;
            logp.value=logp.value+stuff+"\n "
            logp.focus();
            logp.setSelectionRange(logp.value.length,logp.value.length);
        }
        this.clc=function(){
            this.output_field.value="";
        }
        let thisterminal=this;
        this.input.addEventListener("keyup", function(event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                thisterminal.terminal_run();
            }
        });
        this.input.ondblclick=function(){thisterminal.terminal_run()};
        // *** debugging
        this.ErrorPrint=function(er){this.print("ERROR: " + er.message)}
    }// terminal for printing and preforming single tasks
    function Cell_code(copy,iscriptLibrary){
        // cell general
        Cell.call(this);
        let thiscell_code=this;
        this.iscriptLibrary=iscriptLibrary;
        this.textarea=document.createElement("textarea");
        this.textarea.className="codearea codefont";
        this.textarea.placeholder=`Enter code and execute using ctrl+Enter, shift+Enter or clicking play. 
Example:
x=1; ball=Circle(x,0,1,'green'); 
plot(x,0,'k.');`
        this.textarea.addEventListener("keydown", function(event) {
                if ((event.shiftKey||event.ctrlKey) && (event.keyCode === 13)) {
                    event.preventDefault();
                    thiscell_code.Go();
                }
        });
        this.textarea.addEventListener("keyup", function(event) {
            CheckSave()
        });
        function CheckSave(){
            let input=thiscell_code.name_input;
            let iscs=thiscell_code.iscriptLibrary.iscripts;
            let name_arg=cellLib.magic.ParseName(input.value);
            let name=name_arg.name;
            let arguments_string=name_arg.arguments_string;
            let iscr=thiscell_code.iscriptLibrary.getIscriptByName(name);
            if(iscr.script!=thiscell_code.textarea.value){
                thiscell_code.not_saved_input.value='*'
            }
            else{thiscell_code.not_saved_input.value=''}
        }
        
        this.cell_main.appendChild(this.textarea);    
        this.buttons=Add_banner(this);

        this.not_saved_input=this.buttons.not_saved_input;
        this.not_saved_input.readOnly=true;
        this.not_saved_input.addEventListener("click",function(){
            try{
                thiscell_code.iscript.script=thiscell_code.textarea.value;
            }
            catch(err){
                    ErrorPrint(err)
            }
            thiscell_code.not_saved_input.value='';
            thiscell_code.textarea.focus();
        })
        this.name_input=this.buttons.name_input;
        let name_input=this.name_input;
        name_input.addEventListener("keyup",function(){if (event.keyCode === 13) {event.preventDefault(); ChangeIscriptName()}})
        name_input.addEventListener("focusout",ChangeIscriptName)
        function ChangeIscriptName() {
                let previoustring=thiscell_code.iscript.name+thiscell_code.iscript.arguments_string;
                let input=thiscell_code.name_input;
                if(input.value==previoustring){return}
                let iscs=thiscell_code.iscriptLibrary.iscripts;
                if(thiscell_code.iscript.name=='OnLoadIfigure'){
                    alert('Cannot change name of OnLoadIfigure'); thiscell_code.name_input.value=previoustring;
                    thiscell_code.name_input.focus();
                    return
                }
                let name_arg=cellLib.magic.ParseName(input.value);
                let name=name_arg.name;
                let arguments_string=name_arg.arguments_string;
                let other_iscr=thiscell_code.iscriptLibrary.getIscriptByName(name);
                if((other_iscr!=undefined)&&(other_iscr!=thiscell_code.iscript)){
                    alert('An iscript with this name already exists'); thiscell_code.name_input.value=previoustring;
                    thiscell_code.name_input.focus(); 
                    return
                }
                eval('delete ' + thiscell_code.iscript.name)
                thiscell_code.iscript.name=name;
                thiscell_code.iscript.arguments_string=arguments_string;
                thiscell_code.name_input.value=name+arguments_string;
                thiscell_code.textarea.focus()
        }
        
        this.list_div=this.buttons.list_div;
        this.list_content_div=this.buttons.list_content_div;
        this.list_input=this.buttons.list_input;
        this.list_input.placeholder="..."
        this.list_input.addEventListener("keyup",search_iscript);
        this.list_input.addEventListener("click",search_iscript);
        this.list_div.DoOnMouseout=function(event){thiscell_code.list_content_div.style.display="none"}
        this.list_div.addEventListener("mouseout",DoOnMouseout);
        function search_iscript(event) {
                let list = thiscell_code.list_content_div;
                let input=thiscell_code.list_input;
                let iscs=thiscell_code.iscriptLibrary.iscripts;
                let name_arg=cellLib.magic.ParseName(input.value);
                let name=name_arg.name;
                let arguments_string=name_arg.arguments_string;
                    while (list.firstChild) {//remove all items
                        list.removeChild(list.firstChild);
                    }//remove all items
                    let filter=name.toUpperCase();
                    let iscs_fil=iscs.filter(obj=>(obj.name.toUpperCase().indexOf(filter)>-1)).sort((obj1,obj2)=>{
                      let a=obj1.name.toUpperCase();
                      let b=obj2.name.toUpperCase();
                      if(a>b){return 1}
                      if(a<b){return -1}
                      else {return 0}
                    })
                    let names=iscs_fil.map(obj=>obj.name);
                    {
                        let a=document.createElement('a');
                        a.value='new...'
                        a.text='new...'
                        a.style.display="block"
                        a.onclick=function(){
                            let isc_name=prompt('name of new script')
                            let copy=cellLib.magic.ParseName(isc_name);
                            copy.script='';
                            let iscript=new cellLib.magic.Iscript(copy,ballab.iscriptLibrary)
                            thiscell_code.loadIscript(iscript)
                            list.style.display="none"
                            thiscell_code.list_input.value="";
                            thiscell_code.textarea.focus();
                        }
                        list.appendChild(a)
                    }
                    for(let l=0;l<names.length;l++){
                        let a=document.createElement('a');
                        a.value=names[l]
                        a.text=names[l]
                        a.style.display="block"
                        a.onclick=function(){
                            thiscell_code.list_input.value="";
                            list.style.display="none"
                            thiscell_code.loadIscript(iscs_fil[l]);
                            thiscell_code.textarea.focus();
                        }
                        a.addEventListener('contextmenu', function(ev) {
                            ev.preventDefault();
                            if(ev.shiftKey){
                                if(this.text=='OnLoadIfigure'){
                                    print('Cannot delete OnLoadIfigure');
                                    return false;
                                }
                                try{ deleteIscript(this.text) }
                                catch(err){ErrorPrint(err); return false}   
                                search_iscript();
                            } else {alert("If you want to delete an iscript, use shift+right-click")}
                            return false;
                        }, false);
                        list.appendChild(a)
                    }
                    list.style.display="block"
                
        };
        
        this.loadIscript=function(iscr){
            this.iscript=iscr;
            this.name_input.value=iscr.name+iscr.arguments_string;
            this.textarea.value=iscr.script;
            this.not_saved_input.value=''
        }
        this.loadIscript(this.iscriptLibrary.getIscriptByName(copy.iscript_name))
        this.Go=function(){
            try{
                this.iscript.script=this.textarea.value
                this.not_saved_input.value=''
                if(this.iscript.arguments_string=='()'){
                        window[this.iscript.name]()
                }
            }
            catch(err){
                    ErrorPrint(err)
            }
        }
        function Add_banner(cell_parent){ //under construction
            let banner=cell_parent.banner;
            banner.className="banner"
            banner.style.justifyContent="flex-start"
            let height=27;
            let buttons={}
            let Button_h=height;
            let Button_w=Button_h
            let Button_dx=0
            let Button_y=Button_dx
            let Banner_y=0

            buttons.play=new cellLib.svgLib.Button(banner,cellLib.draw.play,Button_dx*2,Button_y,Button_w,Button_h)
            buttons.play.cell_parent=cell_parent;
            buttons.play.onclicked=function(){
                this.updown_appearence();
                this.cell_parent.Go()
            }
            let not_saved_input=document.createElement("INPUT")
            not_saved_input.className='save_button';
            banner.appendChild(not_saved_input);
            let name_input=document.createElement("INPUT")
            name_input.className='banner_text text_hover codefont';
            name_input.style.textAlign="left"
            name_input.style.width="146px"
            banner.appendChild(name_input);
            
            let list_div=document.createElement("div");
            list_div.className="dropdown"
            let list_input=document.createElement("INPUT")
            list_input.className='dropdown-title input_hover';
            list_input.style.textAlign="left"
            list_input.style.width="50px"
            
            let list_content_div=document.createElement("div")
            list_content_div.className="dropdown-content"
            
            list_div.appendChild(list_input)
            list_div.appendChild(list_content_div)
            banner.appendChild(list_div);
            buttons.name_input=name_input
            buttons.not_saved_input=not_saved_input
            buttons.list_input=list_input
            buttons.list_div=list_div
            buttons.list_content_div=list_content_div;
            
            return buttons;
    }
        this.type='Cell_code'
        this.save=function(){
            let copy={};
            copy.type=this.type;
            copy.iscript_name=this.iscript.name;
            return copy;
        }
    }
    function Cell_code_repeat(copy){
        // cell general
        Cell.call(this);
        this.textarea=document.createElement("textarea");
        this.textarea.className="codearea codefont";
        this.textarea.value=copy.script;
        this.textarea.placeholder=`Enter code that will be execuded repeatedly with time intervals set in the banner. 
Example: 
ball.x+=0.1`
        this.cell_main.appendChild(this.textarea); 
        this.dt_pause_var=document.createElement("INPUT");
        this.dt_pause_var.className="banner_text"
        this.dt_pause_var.placeholder='Interval';
        this.dt_pause_var.style.textAlign='center'
        this.dt_pause_var.style.width = "60px";
        
        this.buttons=Add_banner(this);
        this.loop_string='';
        this.dt_pause_var.value=copy.dt_script;
        this.dt_pause=1;
        this.Repeat_every_id=null;
        this.isRepeating=false;
        function repeat(cell_parent){
        	try {
				let code = cell_parent.loop_string;
                eval(code);
			}
			catch(err) {
				Stop(cell_parent)
				ErrorPrint(err);
			}
        }
        function Go(cell_parent){
            try {
                this.Stop();
                cell_parent.dt_pause = 1000*eval(cell_parent.dt_pause_var.value);
                cell_parent.loop_string = '(function(){'+magic_syntax(cell_parent.textarea.value)+'})()';
        	    cell_parent.Repeat_every_id = setInterval(function(){repeat(cell_parent)},cell_parent.dt_pause)
                cell_parent.isRepeating=true
            }
            catch(err) {
				this.Stop();
				ErrorPrint(err);
			}
        }
		this.Stop=function(){
			clearInterval(this.Repeat_every_id);
            this.isRepeating=false
		}
        this.Go=function(){Go(this)}
        function Add_banner(cell_parent){ //under construction
            var banner=cell_parent.banner;
            banner.className="banner"
            /*banner.style.display="grid";
            banner.style.alignItems="center";
            banner.style.gridTemplateColumns="6em 6em 4em 27px 27px";*/
            //var width=500;
            var height=27;
            var buttons={}
            var Button_h=height;
            var Button_w=Button_h
            var Button_dx=0
            var Button_y=Button_dx
            var Banner_y=0
            let divtxt=document.createElement("div")
            divtxt.className="div-wrap"
            divtxt.style.marginTop="3px"
            banner.appendChild(divtxt);
            var text1=document.createElement("INPUT");
            text1.className='banner_text'
            text1.value="Repeat every";
            text1.style.width="90px"
            text1.readOnly=true;
            divtxt.appendChild(text1);
            divtxt.appendChild(cell_parent.dt_pause_var);
            var text2=document.createElement("INPUT");
            text2.value="sec";
            text2.className='banner_text'
            text2.style.width="35px"
            text2.readOnly=true;
            divtxt.appendChild(text2);
            let divbut=document.createElement("div")
            divbut.className='div-wrap';
            banner.appendChild(divbut);
            buttons.play=new cellLib.svgLib.Button(divbut,cellLib.draw.play,Button_dx*2,Button_y,Button_w,Button_h)
            buttons.play.cell_parent=cell_parent;
            buttons.play.onclicked=function(){
                this.updown_appearence();
				Go(cell_parent);
            }
            buttons.stop=new cellLib.svgLib.Button(divbut,cellLib.draw.stop,Button_dx*2,Button_y,Button_w,Button_h)
            buttons.stop.cell_parent=cell_parent;
            buttons.stop.onclicked=function(){
                this.updown_appearence()
				cell_parent.Stop();
            }
            return buttons;
    	}
        this.type='Cell_code_repeat';
        this.save=function(){
            let copy={};
            copy.type=this.type;
            copy.script=this.textarea.value;
            copy.dt_script=this.dt_pause_var.value;
            return copy;
        }
    }
    function Conteval(copy){// fields for expressions that are evaluated every 0.1 seconds 
        this.div=document.createElement("div");
        this.div.className="conteval";
        this.exp=document.createElement("INPUT");
        this.exp.value=copy.exp;
        this.exp.placeholder="Variable or expression";
        this.exp.className="conteval_exp codefont"
        this.output_field=document.createElement("INPUT");
        this.output_field.className="output_field";
        this.output_field.readOnly=true;
        this.div.appendChild(this.exp);
        this.div.appendChild(this.output_field);
        this.outNumberRound={significantDigits:12,minReg:1e-5,maxReg:1e7};
        function update(conteval){
            if(conteval.exp.value.length>0){
            try { 
                  let expr=cellLib.magic.magic_syntax(conteval.exp.value);
                  let out=eval(expr);
                  if(out===null){out='null'}
                  if(isNumber(out)){
                      conteval.output_field.value=roundDisplay(out)
                  } else {
                      conteval.output_field.value=out;
                  }
                } catch(err){conteval.output_field.value=""}}
            else {conteval.output_field.value=""}
            function isNumber(x){
                if(x==null || x==undefined){return false}
                if(x.isComplexNumber){return true}
                if(isNaN(x)){return false}
                if(x.toString()=='true' || x.toString()=='false'){return false}
                if(x.length==undefined){return true}
                else{return false}
            }
            function roundDisplayReal(x){
                let rx=roundSignificant(x,conteval.outNumberRound.significantDigits)
                if(rx==0){return '0'}
                let a=abs(rx);
                if(a>conteval.outNumberRound.minReg && a<conteval.outNumberRound.maxReg){return rx.toString()}
                else {return rx.toExponential()}
            }
            function roundDisplay(x){
                if(x.isComplexNumber){
                    return roundDisplayReal(x.Re)+' + '+roundDisplayReal(x.Im)+ ' * ii'
                } else {return roundDisplayReal(x)}
            }
        }
        let conteval=this;
        this.update_id=setInterval(function(){update(conteval)},100)//fix to 100
        this.type='Conteval';
        this.save=function(){
            let copy={};
            copy.type=this.type;
            copy.exp=this.exp.value;
            return copy;
        }
        
    }// fields for expressions that are evaluated every 0.1 seconds

    function Sidebar(){
        this.div=document.createElement("div");
        this.div.className="sidebar";
    }
    cellLib.Cell=Cell;
    cellLib.Cell_code=Cell_code;
    cellLib.Cell_code_repeat=Cell_code_repeat;
    cellLib.Conteval=Conteval;
    cellLib.Terminal=Terminal;
    cellLib.Sidebar=Sidebar;
    return cellLib;
}
function import_figureLib(){    
	var svgLib=import_svgLib()
	var draw=import_draw()

	var figureLib={}
	var figure_box_top_left_x_px=95
	var figure_box_top_left_y_px=25
	var figure_box_width_px=390
	var figure_box_height_px=390
    var figure_label_margin_x_px=20
    var figure_label_margin_y_px=10
    var figure_label_ndigit_max=4
    var figure_label_text_height=10;
    var figure_xlim_excess_text_margin_px=20
    var figure_lim_excess_text_width_px=250;
    var figure_lim_excess_text_height_px=10;
    var figure_xlim_excess_text_right_margin_px=20;
    var figure_ylim_excess_text_margin_px=12;
    var figure_excess_add_significant_digits=15;
    var figure_ylabel_margin_from_left=10;
    var figure_xlabel_margin_from_bottom=40;
    var figure_ticks_max=8;
    let figure_cursur_line_width=1;
    let figure_cursur_line_color='#777777';
    
    var window_h=500;
	var window_w=500;

	function Axis(){
		this.xmin= -5; this.xmax= 5; this.ymin= -5; this.ymax=5;
		this.xmin0= -5; this.xmax0= 5; this.ymin0= -5; this.ymax0= 5;
		this.xscale_px = function(){return figure_box_width_px/(this.xmax-this.xmin)},
		this.yscale_px = function(){return figure_box_height_px/(this.ymax-this.ymin)},
		this.x_to_xsvg = function(x){return (x-this.xmin)*this.xscale_px()},
		this.xsvg_to_x = function(xsvg){return (xsvg)/this.xscale_px()+this.xmin},
		this.ysvg_to_y = function(ysvg) {return (figure_box_height_px-ysvg)/this.yscale_px()+this.ymin},
		this.y_to_ysvg = function(y){return figure_box_height_px-(y-this.ymin)*this.yscale_px()}
		this.xsvg_to_xwindow_svg=function(xsvg){return xsvg+figure_box_top_left_x_px}
		this.ysvg_to_ywindow_svg=function(ysvg){return ysvg+figure_box_top_left_y_px}
        this.x_to_xwindow_svg=function(x){
            return this.xsvg_to_xwindow_svg(this.x_to_xsvg(x))
        }
        this.y_to_ywindow_svg=function(y){
            return this.ysvg_to_ywindow_svg(this.y_to_ysvg(y))
        }
	}
	function Figure(copy){
        cellLib.Cell.call(this)
		this.axis= new Axis();
        this.fig_div=document.createElement("div");
        this.fig_div.className='fig_div';
        this.cell_main.appendChild(this.fig_div);
        let fig_background=document.createElement("div");
        fig_background.className="fig_background"
        this.fig_div.appendChild(fig_background);
        {// *** set image box
            this.image={
                figure:this,
                box:document.createElement("div"),
                stage:document.createElement("div"),
                xmin:-5,
                xmax:5,
                ymin:-5,
                ymax:5,
                xlim:function(xmin,xmax){
                    this.xmin=xmin;this.xmax=xmax;
                    this.update_axis();
                },
                ylim:function(ymin,ymax){
                    this.ymin=ymin;this.ymax=ymax;
                    this.update_axis();
                },
                update_axis:function(){
                    axis=this.figure.axis;
                    
                    let imagew=axis.x_to_xsvg(this.xmax)-axis.x_to_xsvg(this.xmin);
                    let xscale=imagew/figure_box_width_px;
                    let xtranslate=axis.x_to_xsvg(this.xmin);
                    let xtransform=('translateX('+xtranslate+'px) scaleX('+xscale+') ');
                    
                    let imageh=axis.y_to_ysvg(this.ymin)-axis.y_to_ysvg(this.ymax);
                    let yscale=imageh/figure_box_height_px;
                    let ytranslate=axis.y_to_ysvg(this.ymax);
                    let ytransform=('translateY('+ytranslate+'px) scaleY('+yscale+') ');
                    
                    this.stage.style.transform=(xtransform+ytransform);          
                },
                clear:function(){
                    let stage=this.stage;
                    while(stage.firstChild){stage.removeChild(stage.firstChild)};
                    stage.style.visibility='hidden';
                },
            }
            this.image.box.className="image_box";
            this.image.box.style.top=figure_box_top_left_y_px+'px';
            this.image.box.style.left=figure_box_top_left_x_px+'px';
            this.image.box.style.width=figure_box_width_px+'px';
            this.image.box.style.height=figure_box_height_px+'px';
            this.image.stage.className="image_stage";
            this.image.box.appendChild(this.image.stage);
            this.fig_div.appendChild(this.image.box);
            this.image.update_axis();
            
        }// *** set image box
        {// *** set svg window
            this.window_svg=svgLib.newElement(this.fig_div,"svg",['width',520,'height',500])
            this.window_svg.className="window_svg"
        }// *** set svg window
        {// *** set object arrays
            this.svgs=[];
            this.curves=[];
        }// *** set object arrays

		var window_h=this.window_svg.getAttribute("height")
		var window_w=this.window_svg.getAttribute("width")
		// *** plot box
		this.svg=svgLib.newElement(this.window_svg,"svg",
			['width',figure_box_width_px,'height',figure_box_height_px,
			'x',figure_box_top_left_x_px,'y',figure_box_top_left_y_px])

		// *** cursor lines
		this.cursor_lines=[]
		create_cursor_lines(this)
        // *** crosshair history
        let pointings={x:[],y:[],clear:function(){this.x=[];this.y=[]}};
        let pos={x:NaN,y:NaN};
        this.crosshair_position={pos:pos,pointings:pointings};

        {// *** xlabel ylabel
            this.y_label={
                figure:this,
                input:document.createElement('INPUT'),
                initiate:function(){
                    let x=figure_ylabel_margin_from_left;
                    let y=figure_box_top_left_y_px+figure_box_height_px;
                    let w=figure_box_height_px;
                    let h=20;
                    let foreign=svgLib.newElement(this.figure.window_svg,'foreignObject',['width',w,'height',h,'x',x,'y',y]);
                    let input=this.input;
                    input.className="axis_excess_text";
                    input.setAttribute("type", "text");
                    input.value=copy.ylabel;
                    input.style.textAlign='center';
                    input.style.width=w+'px';
                    input.placeholder = "Enter ylabel";
                    foreign.appendChild(input);
                    foreign.setAttribute('transform','rotate(-90 '+x+','+y+')');
                }
            }
            this.x_label={
                figure:this,
                input:document.createElement('INPUT'),
                initiate:function(){
                    let x=figure_box_top_left_x_px;
                    let y=window_h-figure_xlabel_margin_from_bottom;
                    let w=figure_box_width_px;
                    let h=20;
                    let foreign=svgLib.newElement(this.figure.window_svg,'foreignObject',['width',w,'height',h,'x',x,'y',y]);
                    let input=this.input;
                    input.className="axis_excess_text";
                    input.setAttribute("type", "text");
                    input.value=copy.xlabel;
                    input.style.textAlign='center';
                    input.style.width=w+'px';
                    input.placeholder = "Enter xlabel";
                    foreign.appendChild(input);
                }
            }
            this.xlabel=function(str){
                this.x_label.input.value=str;
            }
            this.ylabel=function(str){
                this.y_label.input.value=str;
            }
            this.y_label.initiate();
            this.x_label.initiate();
        }// *** xlabel ylabel
        // *** excess_field
        this.lim_excess_field={
            figure:this,
            xexcess:{mul_log:0,add:0},
            yexcess:{mul_log:0,add:0},
            xlim_input:document.createElement('INPUT'),
            ylim_input:document.createElement('INPUT'),
            xlim_set:function(){
                let x=window_w-figure_xlim_excess_text_right_margin_px-figure_lim_excess_text_width_px;
                let y=figure_box_top_left_y_px+figure_box_height_px+figure_label_text_height+figure_label_margin_y_px+5;
                let w=figure_lim_excess_text_width_px;
                let h=figure_lim_excess_text_height_px;
           
                let input=this.xlim_input;
                this.figure.fig_div.appendChild(input);
                input.className="axis_excess_text";
                input.readOnly = true;
                input.setAttribute("type", "text");
                input.setAttribute("value", "");
                input.style.textAlign='right';
                input.style.position="absolute"
                input.style.width=w+'px';
                input.style.top=y+'px';
                input.style.left=x+'px';
                input.placeholder='* 1 + 0';
                
            },
            ylim_set:function(){
                let x=figure_box_top_left_x_px;
                let y=figure_box_top_left_y_px-figure_ylim_excess_text_margin_px-figure_lim_excess_text_height_px;
                let w=figure_lim_excess_text_width_px;
                let h=figure_lim_excess_text_height_px;
                let input=this.ylim_input;
                this.figure.fig_div.appendChild(input);
                input.className="axis_excess_text";
                input.readOnly = true;
                input.setAttribute("type", "text");
                input.setAttribute("value", "");
                input.placeholder='* 1 + 0';
                input.style.textAlign='left';
                input.style.width=w+'px';
                input.style.top=y+'px';
                input.style.left=x+'px';
                input.style.position="absolute";
            },
            update: function(xy,mul_log,add){
                let str='';
                if(mul_log!=0){str=str+'* 1e'+mul_log}
                if(add>0){str=str+' + '+roundSignificant(add,figure_excess_add_significant_digits)}
                if(add<0){str=str+' - '+roundSignificant(Math.abs(add),figure_excess_add_significant_digits)}
                if(xy=='x'){
                    this.xexcess.mul_log=mul_log;
                    this.xexcess.add=add;
                    this.xlim_input.value=str;
                } else {
                    this.yexcess.mul_log=mul_log;
                    this.yexcess.add=add;
                    this.ylim_input.value=str;
                };
            }
        }
        this.lim_excess_field.xlim_set();
        this.lim_excess_field.ylim_set();
        //*** ticks
        this.xticks=new Ticks(this,figure_ticks_max,'x');
        this.yticks=new Ticks(this,figure_ticks_max,'y');
        //this.ticks.initiate();

		//*** zoom (uses cursor lines)
		this.zoom={
			figure : this,
			state : 0, 
            axis : [0,0,0,0],
			clear : function(){
				this.state=0
				for (var ic=0;ic<4;ic++){
							this.figure.cursor_lines[ic].setAttributeNS(null,"visibility","hidden");
						}
				},
			reset : function(){
				if(this.state==2){this.state=1}
					fig=this.figure
					fig.cursor_lines[2].setAttributeNS(null,"visibility","hidden");
					fig.cursor_lines[3].setAttributeNS(null,"visibility","hidden");
				var axis=fig.axis
					axis.xmin=axis.xmin0;
					axis.xmax=axis.xmax0;
					axis.ymin=axis.ymin0;
					axis.ymax=axis.ymax0;
				update_figure(fig)
				}
		}     
        {//*** on plot mouse events
            this.plot_click_rect=svgLib.newElement(this.window_svg,"rect",
                ["x",figure_box_top_left_x_px,"y",figure_box_top_left_y_px,
                "width",figure_box_width_px,"height",figure_box_height_px,
                "stroke","black","stroke-width","2px","fill","none",
                "pointer-events","visible"])
            this.plot_clickable_svg=svgLib.newElement(this.window_svg,"svg",
                ['width',figure_box_width_px,'height',figure_box_height_px,
			'x',figure_box_top_left_x_px,'y',figure_box_top_left_y_px])
            
            this.plot_click_rect.figure=this
            this.plot_onclick=function(evt){
                var e = this.plot_click_rect;
                var figh=this
                var axis = this.axis;
                var dim = e.getBoundingClientRect();
                var xsvg=evt.clientX - dim.left
                var ysvg=evt.clientY - dim.top
                var x = axis.xsvg_to_x(xsvg);
                var y = axis.ysvg_to_y(ysvg);
                var xwindow_svg=axis.xsvg_to_xwindow_svg(xsvg)
                var ywindow_svg=axis.ysvg_to_ywindow_svg(ysvg)

                if (figh.zoom.state==1){
                    figh.zoom.state=2
                    var lineh=figh.cursor_lines[2]
                        lineh.setAttributeNS(null,"visibility","visible");
                        lineh.setAttributeNS(null,"y1",ywindow_svg);
                        lineh.setAttributeNS(null,"y2",ywindow_svg);
                    var linev=figh.cursor_lines[3]
                        linev.setAttributeNS(null,"visibility","visible");
                        linev.setAttributeNS(null,"x1",xwindow_svg);
                        linev.setAttributeNS(null,"x2",xwindow_svg);
                    figh.zoom.axis[0]=x;
                    figh.zoom.axis[2]=y;
                } else if (figh.zoom.state==2) {
                    figh.zoom.state=1
                    figh.cursor_lines[2].setAttributeNS(null,"visibility","hidden");
                    figh.cursor_lines[3].setAttributeNS(null,"visibility","hidden");
                    let ax=figh.zoom.axis;
                    ax[1]=x;
                    ax[3]=y;
                    if(ax[0]!=ax[1]){
                        figh.axis.xmin=Math.min(ax[0],ax[1])
                        figh.axis.xmax=Math.max(ax[0],ax[1])
                    } else {ErrorPrint({message:'attempt zoom infinetily in x direction'})}
                    if(ax[2]!=ax[3]){
                        figh.axis.ymin=Math.min(ax[2],ax[3])
                        figh.axis.ymax=Math.max(ax[2],ax[3])
                    } else {ErrorPrint({message:'attempt to zoom infinetily in y direction'})}
                    update_figure(figh)
                }
                var coor = "(" + x + "," + y + ")";
                if(this.buttons.cross.down){this.crosshair_position.pointings.x.push(x);this.crosshair_position.pointings.y.push(y)};
                figh.banner_text.value=coor;

                //NewCircleL(x,y,0.1,"blue")
                }
            this.plot_onmousemove=function(evt){
                if(!is_this_touch_device){
                var figh=this
                var e = this.plot_click_rect
                var dim = e.getBoundingClientRect();
                var axis = figh.axis;
                var xsvg=evt.clientX - dim.left
                var ysvg=evt.clientY - dim.top
                let x = axis.xsvg_to_x(xsvg);
                let y = axis.ysvg_to_y(ysvg);
                if(this.buttons.cross.down){
                  figh.crosshair_position.pos.x=x; 
                  figh.crosshair_position.pos.y=y;
                }
                var xwindow_svg=axis.xsvg_to_xwindow_svg(xsvg)
                var ywindow_svg=axis.ysvg_to_ywindow_svg(ysvg)
                var lineh=figh.cursor_lines[0]
                    lineh.setAttributeNS(null,"visibility","visible");
                    lineh.setAttributeNS(null,"y1",ywindow_svg);
                    lineh.setAttributeNS(null,"y2",ywindow_svg);
                var linev=figh.cursor_lines[1]
                    linev.setAttributeNS(null,"visibility","visible");
                    linev.setAttributeNS(null,"x1",xwindow_svg);
                    linev.setAttributeNS(null,"x2",xwindow_svg);
                }
            }
            this.plot_onmouseout=function(){
                if(!is_this_touch_device){
                var fig=this
                this.cursor_lines[0].setAttributeNS(null,"visibility","hidden");
                this.cursor_lines[1].setAttributeNS(null,"visibility","hidden");
                this.crosshair_position.pos.x=NaN; 
                this.crosshair_position.pos.y=NaN;
                }
            }
            this.plot_click_rect.addEventListener("click", function(evt){evt.currentTarget.figure.plot_onclick(evt)})
            this.plot_click_rect.addEventListener("mousemove", function(evt){evt.currentTarget.figure.plot_onmousemove(evt)})
            this.plot_click_rect.addEventListener("mouseout", function(evt){evt.currentTarget.figure.plot_onmouseout()})
        }//*** on plot mouse events
		this.buttons={};
		this.buttons=Add_banner(this)
        function Add_banner(figure_parent){
			var banner=figure_parent.banner;
            banner.className='banner'
			var width=500;
			var height=27;
			var buttons={}
			var Button_h=height;
			var Button_w=Button_h
			var Button_dx=1
			var Button_y=Button_dx
			var Banner_y=0
            
            let divbut=document.createElement("div")
            divbut.className='div-wrap'
            banner.appendChild(divbut)
			buttons.home=new svgLib.Button(divbut,draw.house,Button_dx*2,Button_y,Button_w,Button_h)
			buttons.home.figure=figure_parent
			buttons.home.onclicked=function(){
				this.updown_appearence()
				this.figure.zoom.reset()
			}
			
            buttons.zoom=new svgLib.Button(divbut,draw.magnifying_glass,Button_dx*3+Button_w,Button_y,Button_w,Button_h)
			buttons.zoom.figure=figure_parent
			buttons.zoom.onclicked=function(){
				this.down_appearence()
				buttons.cross.up_appearence()
				this.figure.zoom.clear()
				this.figure.zoom.state=1
			}
			
            buttons.cross=new svgLib.Button(divbut,draw.cross,Button_dx*4+2*Button_w,Button_y,Button_w,Button_h)
			buttons.cross.figure=figure_parent
			buttons.cross.onclicked=function(){
				this.down_appearence()
				buttons.zoom.up_appearence()
				this.figure.zoom.clear()
			}

			figure_parent.banner_text=document.createElement("input");
			figure_parent.banner_text.className="banner_text";
            figure_parent.banner_text.style.width="350px"
			figure_parent.banner_text.readOnly=true;

			banner.appendChild(figure_parent.banner_text);

			buttons.trash=new svgLib.Button(banner,draw.trash_can,width-Button_w-Button_dx,Button_y,Button_w,Button_h)
			buttons.trash.svg.style.gridColumn="5";
			//buttons.trash.svg.style.position="absolute";
			//buttons.trash.svg.style.left="200px";
			buttons.trash.figure=figure_parent;
			buttons.trash.onclicked=function(){
                this.updown_appearence()
				this.figure.clf();
            }
            buttons.cross.onclicked()
			return buttons
		}   
        this.clf=function(){
            let fig=this;
            let Nsvgs=fig.svgs.length
            for (let nsvg=0; nsvg<Nsvgs; nsvg++){
                fig.svgs[0].clear();// it is 0 since each clear, curves shortens.
            }
            fig.svgs=[];
            let Ncurves=fig.curves.length;
            for (let ncurve=0; ncurve<Ncurves; ncurve++){
                fig.curves[0].clear();// it is 0 since each clear, curves shortens.
            }
            fig.image.clear();
        }
		function create_cursor_lines(fig){
			var axis=fig.axis
			var svgElem
			for (var i=0;i<4;i++){
				svgElem = document.createElementNS(xmlns,"line")
				if (isEven(i)){
					svgElem=svgLib.newElement(fig.window_svg,"line",
					["x1",figure_box_top_left_x_px,"y1",0,"x2",figure_box_top_left_x_px+figure_box_width_px,"y2",0])
				} else {
					svgElem=svgLib.newElement(fig.window_svg,"line",
					["y1",figure_box_top_left_y_px,"x1",0,"y2",figure_box_top_left_y_px+figure_box_height_px,"x2",0])
				}

				svgElem.setAttributeNS(null,"stroke",figure_cursur_line_color);
				svgElem.setAttributeNS(null,"stroke-width",figure_cursur_line_width+'px');
				svgElem.setAttributeNS(null,"stroke-width",figure_cursur_line_width+'px');
				svgElem.setAttributeNS(null,"visibility","hidden");
				fig.cursor_lines.push(svgElem)
				}
			}
        this.xlim=function(xmin,xmax){
            if(xmin>=xmax){
                throw ({message:'xmax must be greater than xmin'})
            } else {
            var axis=this.axis;
            axis.xmin=xmin;
            axis.xmax=xmax;
            axis.xmin0=xmin;
            axis.xmax0=xmax;
            update_figure(this);
            }
        }
        this.ylim=function(ymin,ymax){
            if(ymin>=ymax){
                throw ({message:'ymax must be greater than ymin'})
            } else {
            var axis=this.axis;
            axis.ymin=ymin;
            axis.ymax=ymax;
            axis.ymin0=ymin;
            axis.ymax0=ymax;
            update_figure(this);
            }
        }
        this.type='Figure'
        this.save=function(){
            let copy={};
            copy.type=this.type;
            copy.xlabel=this.x_label.input.value;
            copy.ylabel=this.y_label.input.value;
            return copy;
        }
	}
    
    // *** svgs
    class Svg {
        constructor(fig,svg_type,svg_params){
            this.fig=fig;
            this.svgElem=svgLib.newElement(fig.svg,svg_type,svg_params)
            this.svgElem.me=this;
            fig.svgs.push(this)
            this._interactive=false
        }
        clear(){
            this.svgElem.parentNode.removeChild(this.svgElem)
            let index=this.fig.svgs.indexOf(this)
            if(index>-1){this.fig.svgs.splice(index,1)}
        }
        get style(){return this.svgElem.style}
        set interactive(flag){
            if(flag&&(!this._interactive)){
                this._interactive=true
                this.fig.plot_clickable_svg.appendChild(this.svgElem);
            }
            if((!flag)&& this._interactive){
                this._interactive=false
                this.fig.svg.appendChild(this.svgElem);
            }
        }
        get interactive(){return this._interactive}
        set onclick(fun){
            this.svgElem.onclick=fun;
            if(!this._interactive){
                this.interactive=true
            }
        }
        
    }
	class Circle extends Svg{
        constructor(fig,x,y,r,col) {
            let axis=fig.axis;
            let findcol=FindNamedColor(col);
            super(fig,"ellipse",[
            "rx",r*axis.xscale_px(),"ry",r*axis.yscale_px(),
            "cx",axis.x_to_xsvg(x),"cy",axis.y_to_ysvg(y),
            "fill",findcol.color])
            this._x=x
            this._y=y
            this._r=r
            this._color=findcol.color;
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
			svgElem.setAttribute("rx",this._r*axis.xscale_px())
			svgElem.setAttribute("ry",this._r*axis.yscale_px())
			svgElem.setAttribute("cx",axis.x_to_xsvg(this._x))
			svgElem.setAttribute("cy",axis.y_to_ysvg(this._y))
            svgElem.setAttribute("fill",this._color)
		}
        
        get x(){return this._x}
        set x(x){this._x=x;this.update()}
        
        get y(){return this._y}
        set y(y){this._y=y;this.update()}
        
        get r(){return this._r}
        set r(r){this._r=r;this.update()}
        
        get xrange(){return [this._x-this._r,this._x+this._r]}
        set xrange(xs){let sx=xs.sort((a,b)=>(a>b)); this._x=(sx[0]+sx[1])/2; this._r=(sx[1]-sx[0])/2; this.update()}
        
        get yrange(){return [this._y-this._r,this._y+this._r]}
        set yrange(ys){let sy=ys.sort((a,b)=>(a>b)); this._y=(sy[0]+sy[1])/2; this._r=(sy[1]-sy[0])/2; this.update()}
        
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
    }
    class Point extends Svg{
        constructor(fig,x,y,r,col) {
            let axis=fig.axis;
            let findcol=FindNamedColor(col);
            super(fig,"circle",[
            "r",r,
            "cx",axis.x_to_xsvg(x),"cy",axis.y_to_ysvg(y),
            "fill",findcol.color])
            this._x=x
            this._y=y
            this._r=r
            this._color=findcol.color;
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
			svgElem.setAttribute("r",this._r)
			svgElem.setAttribute("cx",axis.x_to_xsvg(this._x))
			svgElem.setAttribute("cy",axis.y_to_ysvg(this._y))
            svgElem.setAttribute("fill",this._color)
		}
        
        get x(){return this._x}
        set x(x){this._x=x;this.update()}
        
        get y(){return this._y}
        set y(y){this._y=y;this.update()}
        
        get r(){return this._r}
        set r(r){this._r=r;this.update()}
                
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
    }
    class Ellipse extends Svg{
        constructor(fig,x,y,rx,ry,col) {
            let axis=fig.axis;
            let findcol=FindNamedColor(col);
            super(fig,"ellipse",[
            "rx",rx*axis.xscale_px(),"ry",ry*axis.yscale_px(),
            "cx",axis.x_to_xsvg(x),"cy",axis.y_to_ysvg(y),
            "fill",findcol.color])
            this._x=x
            this._y=y
            this._rx=rx
            this._ry=ry
            this._color=findcol.color;
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
			svgElem.setAttribute("rx",this._rx*axis.xscale_px())
			svgElem.setAttribute("ry",this._ry*axis.yscale_px())
			svgElem.setAttribute("cx",axis.x_to_xsvg(this._x))
			svgElem.setAttribute("cy",axis.y_to_ysvg(this._y))
            svgElem.setAttribute("fill",this._color)
		}
        
        get x(){return this._x}
        set x(x){this._x=x;this.update()}
        
        get y(){return this._y}
        set y(y){this._y=y;this.update()}
        
        get rx(){return this._rx}
        set rx(rx){this._rx=rx;this.update()}
        
        get ry(){return this._ry}
        set ry(ry){this._ry=ry;this.update()}
        
        get xrange(){return [this._x-this._rx,this._x+this._rx]}
        set xrange(xs){let sx=xs.sort((a,b)=>(a>b)); this._x=(sx[0]+sx[1])/2; this._rx=(sx[1]-sx[0])/2; this.update()}
        
        get yrange(){return [this._y-this._ry,this._y+this._ry]}
        set yrange(ys){let sy=ys.sort((a,b)=>(a>b)); this._y=(sy[0]+sy[1])/2; this._ry=(sy[1]-sy[0])/2; this.update()}
        
        
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
    }
    class Rectangle extends Svg{
        constructor(fig,xs,ys,col) {
            let axis=fig.axis;
            let findcol=FindNamedColor(col);
            let xmin=min(xs)
            let ymax=max(ys)
            let height=Math.abs(ys[1]-ys[0])
            let width=Math.abs(xs[1]-xs[0])            
            super(fig,"rect",[
            "width",width*Math.abs(axis.xscale_px()),"height",height*Math.abs(axis.yscale_px()),
            "x",axis.x_to_xsvg(xmin),"y",axis.y_to_ysvg(ymax),
            "fill",findcol.color])
            this._xs=xs.sort((a,b)=>(a>b))
            this._ys=ys.sort((a,b)=>(a>b))
            this._color=findcol.color;
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
            let xs=this._xs, ys=this._ys
            let height=ys[1]-ys[0]
            let width=xs[1]-xs[0]
			svgElem.setAttribute("width",width*Math.abs(axis.xscale_px()))
			svgElem.setAttribute("height",height*Math.abs(axis.yscale_px()))
			svgElem.setAttribute("x",axis.x_to_xsvg(xs[0]))
			svgElem.setAttribute("y",axis.y_to_ysvg(ys[1]))
            svgElem.setAttribute("fill",this._color)
		}
        
        get xrange(){return this._xs}
        set xrange(xs){this._xs=xs.sort((a,b)=>(a>b));this.update()}
        
        get yrange(){return this._ys}
        set yrange(ys){this._ys=ys.sort((a,b)=>(a>b));this.update()}
        
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
    }    
    class Polygon extends Svg{
        constructor(fig,xs,ys,col) {
            let axis=fig.axis;
            let findcol=FindNamedColor(col);
            let points_str=[]; for (let l=0;l<xs.length;l++){
                points_str+=axis.x_to_xsvg(xs[l])+','+axis.y_to_ysvg(ys[l])+' '
            }
            super(fig,"polygon",["points", points_str,
            "fill",findcol.color])
            this._xs=xs
            this._ys=ys
            this._color=findcol.color;
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
            let xs=this._xs, ys=this._ys
            let points_str=[]; for (let l=0;l<xs.length;l++){
                points_str+=axis.x_to_xsvg(xs[l])+','+axis.y_to_ysvg(ys[l])+' '
            }
			svgElem.setAttribute("points",points_str)
            svgElem.setAttribute("fill",this._color)
		}      
        setPoints(xs,ys){
            if(xs.length!=ys.length){
                throw {message:'x and y must be the same length'}
            }
            else {this._xs=xs; this._ys=ys; this.update()}
        }
        setVertices(xs,ys){
            this.setPoints(xs,ys)
        }
        get xs(){return this._xs}
        get ys(){return this._ys}
        
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
    }
    class Line extends Svg{
        constructor(fig,xs,ys,type_str,line_width) {
            let axis=fig.axis;
            super(fig,"path",["d", "","fill","none"])
            this._xs=xs
            this._ys=ys
            let types=Curve.read_type(type_str);
            this._dash=types[0]
            this._color=types[2]
            this._line_width=line_width
            this.update()
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
            let xs=this._xs, ys=this._ys
            let data_string="M "+axis.x_to_xsvg(xs[0])+","+axis.y_to_ysvg(ys[0])+" L";
            for(let l=1;l<xs.length;l++){
                    data_string+=" "+axis.x_to_xsvg(xs[l])+",";
                    data_string+=axis.y_to_ysvg(ys[l]);
            }
			svgElem.setAttribute("d",data_string)
            svgElem.setAttribute("stroke",this._color)
            svgElem.setAttribute("stroke-width", this._line_width)
            switch(this._dash) {
                case '--':
                    svgElem.setAttributeNS(null,"stroke-dasharray", "4 2")
                    break;
                case '-.':
                    svgElem.setAttributeNS(null,"stroke-dasharray", "4 1 1 1");
                    break;
                case  ':':
                    svgElem.setAttributeNS(null,"stroke-dasharray", "1 4");
                    break;
                default:
                    this._dash="-";
                    svgElem.setAttributeNS(null,"stroke-dasharray","");
                }        
		}      
        setPoints(xs,ys){
            if(xs.length!=ys.length){
                throw {message:'x and y must be the same length'}
            }
            else {this._xs=xs; this._ys=ys; this.update()}
        }
        set_data(xs,ys){this.setPoints(xs,ys)}
        setData(xs,ys){this.setPoints(xs,ys)}
        
        get xs(){return this._xs}
        set xs(xs){
            if(xs.length!=this._ys.length){
                throw {message:'x and y must be the same length'}
            }
            else {this._xs=xs;this.update()}           
        }
        
        get ys(){return this._ys}
        set ys(ys){
            if(ys.length!=this._xs.length){
                throw {message:'x and y must be the same length'}
            }
            else {this._ys=ys;this.update()}           
        }
        
        get line_width(){return this._line_width}
        set line_width(line_width){this._line_width=line_width; this.update()}
        
        get lineWidth(){return this._line_width}
        get LineWidth(){return this._line_width}
        
        set lineWidth(lw){this.line_width=lw}
        set LineWidth(lw){this.line_width=lw}
        
        
        get xrange(){return this._xs}
        get yrange(){return this._ys}
        
        set xrange(xs){this.xs=xs}
        set yrange(ys){this.ys=ys}
        
        
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
        get type_str(){return this._color+this._dash}
        set type_str(type_str){
            let types=Curve.read_type(type_str);
            if(types[0]==''&&types[1]==''){
                types[1]='.';
            }
            this._dash=types[0]
            this._color=types[2]
            this.update()
        }
        get dash(){return this._dash}
        set dash(dash_str){this._dash=dash_str; this.update()}
    }
    class Text extends Svg{
        constructor(fig,str,x,y,col) {
            let axis=fig.axis;
            let findcol=FindNamedColor(col);
            super(fig,"text",[
            "x",axis.x_to_xsvg(x),"y",axis.y_to_ysvg(y),
            "fill",findcol.color])
            svg_text_set(this.svgElem,str)
            this._x=x
            this._y=y
            this._value=str
            this._color=findcol.color;
            
        }
		update(){
			let svgElem=this.svgElem
			let axis=this.fig.axis
			svgElem.setAttribute("x",axis.x_to_xsvg(this._x))
			svgElem.setAttribute("y",axis.y_to_ysvg(this._y))
            svgElem.setAttribute("fill",this._color)
            svg_text_set(svgElem,this._value)
		}
        
        get x(){return this._x}
        set x(x){this._x=x;this.update()}
        
        get y(){return this._y}
        set y(y){this._y=y;this.update()}
        
        get color(){return this._color}
        set color(col){
            let findcol=FindNamedColor(col);
            this._color=findcol.color;this.update()
        }
        
        get value(){return this._value}
        set value(str){
            this._value=str;this.update()
        }
        
    }

	function update_figure(fig) {
        fig.yticks.update_axis();
        fig.xticks.update_axis();
        fig.image.update_axis();
		for (let nsvg=0; nsvg<fig.svgs.length; nsvg++){
			fig.svgs[nsvg].update();
		}
        for (let ncurve=0; ncurve<fig.curves.length; ncurve++){
            fig.curves[ncurve].update_axis();
        }
        
        
	}
	function figure_cursor_line_id(fign,num){return "figure"+fign+"zoomline"+num}
    // *** Curves
    class Curve{
        constructor(fig,xss,yss,type_str){
        var xs,ys
        if(Array.isArray(xss)){xs=xss} else {xs=[xss]};
        if(Array.isArray(yss)){ys=yss} else {ys=[yss]};
        if(xs.length!==ys.length){throw {message:"x and y must have same length"}} 
        var types=Curve.read_type(type_str);
        if(types[0]==''&&types[1]==''){
            types[1]='.';
        }
        if(xs.length==1&&types[0].length>0){throw {message:"a line must have more than one point"}} 
        this.color=types[2];
        this.N=xs.length;
        var axis=fig.axis;
        this.line={
            curve:this,
            type:types[0],
            on:(types[0].length>0),
            svgElem:null,
            draw:function(){
                var svgElem=document.createElementNS(xmlns,"path");
                svgElem.setAttributeNS(null,"stroke",this.curve.color);
                svgElem.setAttributeNS(null,"fill","none");
                svgElem.setAttributeNS(null,"stroke-width", 2);
                if        (this.type=='--'){
                    svgElem.setAttributeNS(null,"stroke-dasharray", "4 2");
                } else if (this.type=='-.'){
                    svgElem.setAttributeNS(null,"stroke-dasharray", "4 1 1 1");
                } else if (this.type==':'){
                    svgElem.setAttributeNS(null,"stroke-dasharray", "1 4");
                } else {
                    svgElem.setAttributeNS(null,"stroke-dasharray","");
                }
                this.curve.fig.svg.appendChild(svgElem);
                this.svgElem=svgElem;
                this.update();
            },
            update:function(){
                var curve=this.curve;
                var data_string="M "+axis.x_to_xsvg(curve.xs[0])+","+axis.y_to_ysvg(curve.ys[0])+" L";
                for(var l=1;l<curve.N;l++){
                    data_string+=" "+axis.x_to_xsvg(curve.xs[l])+",";
                    data_string+=axis.y_to_ysvg(curve.ys[l]);
                }
                this.svgElem.setAttributeNS(null,"d",data_string);  
            },
            clear:function(){
                this.svgElem.parentNode.removeChild(this.svgElem);
                this.on=false;
            },
            set_width:function(line_width){
                if(!this.on){throw {message:'using set_width: this curve has no line'}}
                else{this.svgElem.setAttributeNS(null,"stroke-width", line_width)}
            },
            get_width:function(){
                if(!this.on){throw {message:'using get_width: this curve has no line'}}
                return this.svgElem.getAttribute("stroke-width")
            }
        };
        this.markers={
            curve:this,
            type:types[1],
            on:(types[1].length>0),
            markers:[],
            svgElems:[],
            size:5,
            draw:function(){
                var curve=this.curve;
                var axis=curve.fig.axis;
                var marker;
                for(var l=0;l<this.curve.N;l++){
                    marker=new Marker(curve.fig,this.type,
                                      curve.xs[l],
                                      curve.ys[l],
                                      this.size,curve.color);
                    this.markers.push(marker);
                }
            },
            update_axis:function(){
                for(var l=0;l<this.markers.length;l++){
                    this.markers[l].update_axis();
                }
            },
            clear:function(){
                for(var l=0;l<this.markers.length;l++){
                    this.markers[l].clearSvg();
                }
                this.markers=[];
                this.on=false;
            },
            set_data:function(_newxs,_newys){
                let newxs=_newxs, newys=_newys;
                if(!Array.isArray(newxs)){newxs=[newxs]}
                if(!Array.isArray(newys)){newys=[newys]}
                let Nnew=newxs.length;
                let Nold=this.markers.length;
                let curve=this.curve;
                if(Nnew<=Nold){
                    for(let l=0;l<Nnew;l++){
                        this.markers[l].set_pos(newxs[l],newys[l])
                    }
                    for(let l=Nnew;l<Nold;l++){
                        this.markers[l].clearSvg()
                    }
                    this.markers=this.markers.slice(0,Nnew)
                } else {
                    for(var l=0;l<Nold;l++){
                        this.markers[l].set_pos(newxs[l],newys[l])
                    }
                    for(var l=Nold;l<Nnew;l++){
                        let marker=new Marker(curve.fig,this.type,newxs[l],newys[l],this.size,curve.color);
                        this.markers.push(marker);
                    }
                        
                }
            }
        };
        this.fig=fig;
        this.xs=xs;
        this.ys=ys;
        if(this.line.on){this.line.draw()};
        if(this.markers.on){this.markers.draw()};
        fig.curves.push(this);
        }
        update_axis(){
            if(this.line.on){
                this.line.update();
            }
            if(this.markers.on){
                this.markers.update_axis();
            }
        }
        
        set_data(newxs,newys){
            if(newxs.length!==newys.length){
                throw {message:"x and y must have the same length"};
            } else {
            if(this.markers.on){
                this.markers.set_data(newxs,newys);
            }
            this.N=newxs.length;
            this.xs=newxs;
            this.ys=newys;
            if(this.line.on){this.line.update()};
            }
        }
        SetData(newxs,newys){set_data(newxs,newys)}
        setData(newxs,newys){set_data(newxs,newys)}
        setdata(newxs,newys){set_data(newxs,newys)}
        
        add_data(newxss,newyss){
            var newxs,newys
            if(Array.isArray(newxss)){newxs=this.xs.concat(newxss)} else {newxs=this.xs.concat([newxss])};
            if(Array.isArray(newyss)){newys=this.ys.concat(newyss)} else {newys=this.ys.concat([newyss])};
            this.set_data(newxs,newys)
        }
        AddData(newxss,newyss){add_data(newxss,newyss)}
        addData(newxss,newyss){add_data(newxss,newyss)}
        adddata(newxss,newyss){add_data(newxss,newyss)}
        
        set data(newxsnewys){
            this.set_data(newxsnewys[0],newxsnewys[1])
        }
        get data(){
            return [this.xs,this.ys]
        }
        
        set_line_width(line_width){
            this.line.set_width(line_width)
        }
        SetLineWidth(line_width){set_line_width(line_width)}
        
        set line_width(line_width){this.set_line_width(line_width)}
        set LineWidth(line_width){this.set_line_width(line_width)}
        get line_width(){return this.line.get_width()}
        get LineWidth(){return this.line.get_width()}
        
        clear(){
            if(this.line.on){this.line.clear()};
            if(this.markers.on){this.markers.clear()};
            let index=this.fig.curves.indexOf(this);
            if(index>-1){this.fig.curves.splice(index,1)}
        }
        static read_type(type_str){
            let str=type_str;
            let strn
            let line_types=['--',':','-.','-'];
            let marker_types=['+','o','*','.','x','s','d','^','>','<','v'];
            let marker_type='';
            let line_type='';
            let col='blue';

            let findcolor=FindNamedColor(str);
            if(findcolor.found){col=findcolor.color; str=findcolor.newstr}
            
            for(let l=0;l<line_types.length;l++){
                strn=str.split(line_types[l]).join('');
                if(strn.length<str.length){
                    line_type=line_types[l];
                    str=strn;
                }
            }
                        
            for(let l=0;l<marker_types.length;l++){
                strn=str.split(marker_types[l]).join('');
                if(strn.length<str.length){
                    marker_type=marker_types[l];
                    str=strn;
                }
            }
            
            if(str.length>0){col=str}
            return [line_type,marker_type,col]          
        }
    }
    function Marker(fig,type,x,y,size,col){
        this.fig=fig;
        var svgElem
        var s=' '
        var L='L'
        var M='M'
        var Z='Z'
        var l='l'
        var s2=Math.sqrt(2)
        var s34=Math.sqrt(3/4)
        if(type=="."){
            this.r=size/3;
            svgElem=document.createElementNS(xmlns,"circle")
            svgElem.setAttributeNS(null,'fill',col)
            svgElem.setAttributeNS(null,'r',this.r)
        } 
        else {
            svgElem=document.createElementNS(xmlns,"path")
            svgElem.setAttributeNS(null,'fill','none')
            this.r=size;
            svgElem.setAttributeNS(null,'stroke-width',1.5)
            svgElem.setAttributeNS(null,'stroke',col)
        }
        
        this.svgElem=svgElem;
        this.type=type;
        this.x=x;
        this.y=y;
        fig.svg.appendChild(svgElem);
        if     (type=='+'){this.pathfun=plusPath}
        else if(type=='x'){this.pathfun=crossPath}
        else if(type=='o'){this.pathfun=circlePath}
        else if(type=='d'){this.pathfun=diamondPath}
        else if(type=='s'){this.pathfun=squarePath}
        else if(type=='^'){this.pathfun=triangleupPath}
        else if(type=='v'){this.pathfun=triangledownPath}
        else if(type=='>'){this.pathfun=trianglerightPath}
        else if(type=='<'){this.pathfun=triangleleftPath}
        else if(type=='*'){this.pathfun=asteriskPath}
        else {this.pathfun=null}
        this.update_axis=function(){
            var axis=this.fig.axis;
            var cx=axis.x_to_xsvg(this.x);
            var cy=axis.y_to_ysvg(this.y);
            if(this.type=="."){
                svgElem.setAttributeNS(null,"cx",cx)
                svgElem.setAttributeNS(null,"cy",cy)
            } else {
                svgElem.setAttributeNS(null,"d",this.pathfun(cx,cy,this.r))
            }
        }
        this.set_pos=function(x,y){
            this.x=x;
            this.y=y;
            this.update_axis();
        }
        this.set_size=function(size){
            var axis=this.fig.axis;
            var cx=axis.x_to_xsvg(this.x);
            var cy=axis.y_to_ysvg(this.y);
            if(type=="."){
                this.r=size/3
                svgElem.setAttributeNS(null,"r",this.r)
            } 
            else {
                this.r=size
                svgElem.setAttributeNS(null,"d",this.pathfun(cx,cy,this.r))
            }
        }
        this.get_size=function(){
            let size=this.r
            if(type=="."){size=3*this.r}
            return size
        }
        
        this.update_axis();
        
        this.clearSvg=function(){
            this.svgElem.parentNode.removeChild(this.svgElem);
        }

        function circlePath(cx, cy, r){
            return M+cx+' '+cy+' m -'+r+', 0 a '+r+','+r+' 0 1,0 '+(r*2)+',0 a '+r+','+r+' 0 1,0 -'+(r*2)+',0';
        }
        function plusPath(cx,cy,r){
            return M+(cx-r)+s+cy+L+(cx+r)+s+cy+M+cx+s+(cy-r)+L+cx+s+(cy+r)
        }
        function crossPath(cx,cy,r){
            return M+(cx-r/s2)+s+(cy-r/s2)+l+(2*r/s2)+s+(2*r/s2)+M+(cx-r/s2)+s+(cy+r/s2)+l+(2*r/s2)+s+(-2*r/s2)
        }
        function asteriskPath(cx,cy,r){
            return plusPath(cx,cy,r)+crossPath(cx,cy,r)
        }
        function squarePath(cx,cy,r){
	       var d=2*r/s2;
	       return M+(cx-r/s2)+s+(cy-r/s2)+l+d+s+0+l+0+s+d+l+(-d)+s+0+Z
        }     
        function triangleupPath(cx,cy,r){
            return M+(cx-r*s34)+s+(cy+r/2)+L+cx+s+(cy-r)+L+(cx+r*s34)+s+(cy+r/2)+Z
        }
        function triangledownPath(cx,cy,r){
            return M+(cx-r*s34)+s+(cy-r/2)+L+cx+s+(cy+r)+L+(cx+r*s34)+s+(cy-r/2)+Z
        }
        function trianglerightPath(cx,cy,r){
            return M+(cx-r/2)+s+(cy-r*s34)+L+(cx+r)+s+cy+L+(cx-r/2)+s+(cy+r*s34)+Z
        }
        function triangleleftPath(cx,cy,r){
            return M+(cx+r/2)+s+(cy-r*s34)+L+(cx-r)+s+cy+L+(cx+r/2)+s+(cy+r*s34)+Z
        }
        function diamondPath(cx,cy,r){
            return M+(cx-r)+s+cy+L+cx+s+(cy-r)+L+(cx+r)+s+cy+L+cx+s+(cy+r)+Z
        }
    }    
    // *** ticks and labels
    function Ticks(fig,Nmax,xy){
        this.figure=fig;
        this.xy=xy;
        this.Nmax=Nmax;
        this.ticks=[]
        var tick;
        var axis=fig.axis;
        for(var l=0;l<this.Nmax;l++){
            tick=new Tick(fig,xy,0)
            this.ticks.push(tick);
        }                 
        this.update_axis=function(){
            fig=this.figure
            var axis=fig.axis;
            var posmax,posmin;
            if(xy=='x'){posmax=axis.xmax;posmin=axis.xmin} else {posmax=axis.ymax; posmin=axis.ymin};
            var pos=TickPos(posmin,posmax,this.Nmax)
            fig.lim_excess_field.update(xy,pos.mul_log,pos.add)
            for(var l=0;l<this.Nmax;l++){
                tick=this.ticks[l];
                if(l<pos.length){
                    tick.set_pos(pos[l]); 
                    tick.show()} 
                else {
                    tick.hide();
                }
            }
        }
        this.update_axis();
    }
    function Tick(fig,xy,pos){
        var tick_length=5;
        var tick_width=2;
        this.figure=fig;
        this.xy=xy;
        var axis=fig.axis;
        this.pos=pos;
        if(xy=='x'){
            this.x1=function(){
                return axis.x_to_xwindow_svg(this.pos)
            }
            this.y1=function(){return axis.ysvg_to_ywindow_svg(figure_box_height_px)}
            this.x2=function(){return this.x1()}
            this.y2=function(){return this.y1()-tick_length}    
        } else {
            this.y1=function(){
                return axis.y_to_ywindow_svg(this.pos);
            }
            this.x1=function(){return axis.xsvg_to_xwindow_svg(0)}
            this.x2=function(){return this.x1()+tick_length}
            this.y2=function(){return this.y1()}
        }
        this.svgElem=svgLib.newElement(fig.window_svg,'line',['stroke','black','stroke-width',tick_width,'visibility','hidden']);
        this.show=function(){
            this.update_pos();
            this.svgElem.setAttributeNS(null,'visibility','visible')
            this.label.show();
        }
        this.hide=function(){
            this.svgElem.setAttributeNS(null,'visibility','hidden')
            this.label.hide();
        }
        this.update_pos=function(){
            this.svgElem.setAttributeNS(null,'x1',this.x1());
            this.svgElem.setAttributeNS(null,'y1',this.y1());
            this.svgElem.setAttributeNS(null,'x2',this.x2());
            this.svgElem.setAttributeNS(null,'y2',this.y2());
            this.label.update_pos();
        }
        
        this.set_pos=function(pos){
            this.pos=pos;
            this.update_pos();
        }
        this.label=new Tick_label(this);
    }
    function Tick_label(tick){
            this.tick=tick;
            var fig=tick.figure;
            var axis=fig.axis;
            this.svgElem=svgLib.newElement(fig.window_svg,'text',['fill','black','visibility','hidden']);
            this.on=false;
            this.value=''
            this.length_px=function(){return this.svgElem.getComputedTextLength()};
            if(tick.xy=='x'){
                this.x=function(){
                    return axis.x_to_xwindow_svg(tick.pos)-this.length_px()/2;
                }
                this.y=function(){return axis.ysvg_to_ywindow_svg(figure_box_height_px)+figure_label_margin_x_px} 
                this.excess=fig.lim_excess_field.xexcess;
            } 
            else {
                this.y=function(){
                    return axis.y_to_ywindow_svg(tick.pos)+figure_label_text_height/2;
                }
                this.x=function(){return axis.xsvg_to_xwindow_svg(0)-figure_label_margin_y_px-this.length_px()}
                this.excess=fig.lim_excess_field.yexcess;
            }
            this.update_value=function(){
                let pos_ajdusted=((tick.pos-this.excess.add)/10**this.excess.mul_log);
                var str=round(pos_ajdusted,figure_label_ndigit_max).toString();
                this.value=str;
                svg_text_set(this.svgElem,str);
            }
            this.update_pos=function(){
                var svgElem=this.svgElem;
                svgElem.setAttributeNS(null,'x',this.x())
                svgElem.setAttributeNS(null,'y',this.y())
                this.update_value()
            }
            this.show=function(){
                this.on=true;
                this.svgElem.setAttributeNS(null,'visibility','visible')
                this.update_pos();
            }
            this.hide=function(){
                this.on=false;
                this.svgElem.setAttributeNS(null,'visibility','hidden')
            }
            
    }
    function TickPos(xmin,xmax,Nticksmax){
        let jumps=[0.0001,0.0002,0.0005,0.001,0.002,0.005,0.01,0.015,0.02,0.025,0.05,0.1,0.2,0.25,0.3,0.4,0.5,1,1.5,2,2.5,3,4,5,10,15,20,25,50,100,150,200,250,500,1000,1500,2000,2500,5000,10000];
        
        let Dx=xmax-xmin;
        let xmid=(xmin+xmax)/2;
        
        let Dx_min_split=0.2;
        let min_Dx_over_xmid_add=0.02;
        
        let mul_mills;
        if(Dx>0.001 && Dx<10000){mul_mills=0} else {
          mul_mills=Math.floor(Math.log10(Dx/Dx_min_split)/3);  
        }
      
        let mul_log=3*mul_mills;
        let mul_factor=10**mul_log;

        
        let max_Dx_fac=10**3*Dx_min_split;
        let min_Dx_fac=Dx_min_split;
        if(max_Dx_fac/max(jumps)>Nticksmax){ErrorPrint({message:'problem with tick setting - largest allowed interval not big enough'})}
        
        let add_number=0;

        if(Dx/Math.abs(xmid)<min_Dx_over_xmid_add){
            let add_decs=0; 
            let xmids=(xmid+xmin)/2;
            let nlog=Math.floor(Math.log10(Dx/mul_factor))+1;
            if (xmin<0&&xmax<0){add_decs=Math.ceil(xmax/(10**nlog*mul_factor))}
            else {add_decs=Math.floor(xmin/(10**nlog*mul_factor))}    
            add_number=add_decs*10**nlog*mul_factor;
        }
        
        let xminc=(xmin-add_number)/mul_factor, xmaxc=(xmax-add_number)/mul_factor;
        
        
        let nbest=0,lbest=0;
      
        jumps.map((jump,l)=>{
            let nmin=Math.ceil(xminc/jump), nmax=Math.floor(xmaxc/jump);
            let n=nmax-nmin+1;
            if(n>nbest&&n<Nticksmax){
                nbest=nmax-nmin;
                lbest=l;
            }
        });
        
        let jump=jumps[lbest], nmin=Math.ceil(xminc/jump), nmax=Math.floor(xmaxc/jump), n=nmax-nmin+1;
        
        let pos=linspace(nmin*jump*mul_factor+add_number,nmax*jump*mul_factor+add_number,n);
      
        pos.mul_log=mul_log;
        pos.add=add_number;
        return pos
    }
        
    // *** svg text
    function svg_text_set(txtSvgElem,str){
        if(txtSvgElem.childNodes.length>0){
            let textNode = txtSvgElem.childNodes[0];
            textNode.nodeValue = str;
        } else {
            let textNode = document.createTextNode(str);
            txtSvgElem.appendChild(textNode);
        }
    }
    // *** rounding and math
    function round0(z){
            if(typeof z=='number'){return Math.round(z)}
            if(Array.isArray(z)){return z.map(round0)}
            else {throw {message:'argument should be array or number'}}
    }
    function round(z, decimals){
        if(arguments.length==1){return round0(z)}
        if(typeof z=='number'){return Number(z.toFixed(decimals))}
        if(Array.isArray(z)){return z.map(v=>round(v,decimals))}
        else {throw {message:'argument should be array or number'}}
    }
    function roundSignificant(x,n){
        return Number(x.toPrecision(n));
    }
    function isEven(n){
      return n == parseFloat(n)? !(n%2) : void 0;
    }
    function linspace(xi,xf,N){
        let x=[xi];
        let dx=(xf-xi)/(N-1);
        for(let l=1;l<(N-1);l++){
            x.push(xi+l*dx)
        }
        x.push(xf);
        return x;
    }
    function max(x){
        let maxx
        if(Array.isArray(x)){
        maxx=x[0];
        for(var l=1;l<x.length;l++){
            if(x[l]>maxx){maxx=x[l]}
        }
        } else {maxx=x}
        return maxx;
    }
    function min(x){
        let minx
        if(Array.isArray(x)){
        minx=x[0];
        for(var l=1;l<x.length;l++){
            if(x[l]<minx){minx=x[l]}
        }
        } else {minx=x}
        return minx;
    }
        
    // *** colors
    function AllNamedColors() {// from https://stackoverflow.com/questions/1573053/javascript-function-to-convert-color-names-to-hex-codes Answer 85
        return {"aliceblue":"#f0f8ff","antiquewhite":"#faebd7","aqua":"#00ffff","aquamarine":"#7fffd4","azure":"#f0ffff", "beige":"#f5f5dc","bisque":"#ffe4c4","black":"#000000","blanchedalmond":"#ffebcd","blue":"#0000ff","blueviolet":"#8a2be2","brown":"#a52a2a","burlywood":"#deb887","cadetblue":"#5f9ea0","chartreuse":"#7fff00","chocolate":"#d2691e","coral":"#ff7f50","cornflowerblue":"#6495ed","cornsilk":"#fff8dc","crimson":"#dc143c","cyan":"#00ffff","darkblue":"#00008b","darkcyan":"#008b8b","darkgoldenrod":"#b8860b","darkgray":"#a9a9a9","darkgreen":"#006400","darkkhaki":"#bdb76b","darkmagenta":"#8b008b","darkolivegreen":"#556b2f","darkorange":"#ff8c00","darkorchid":"#9932cc","darkred":"#8b0000","darksalmon":"#e9967a","darkseagreen":"#8fbc8f","darkslateblue":"#483d8b","darkslategray":"#2f4f4f","darkturquoise":"#00ced1","darkviolet":"#9400d3","deeppink":"#ff1493","deepskyblue":"#00bfff","dimgray":"#696969","dodgerblue":"#1e90ff","firebrick":"#b22222","floralwhite":"#fffaf0","forestgreen":"#228b22","fuchsia":"#ff00ff","gainsboro":"#dcdcdc","ghostwhite":"#f8f8ff","gold":"#ffd700","goldenrod":"#daa520","gray":"#808080","green":"#008000","greenyellow":"#adff2f","honeydew":"#f0fff0","hotpink":"#ff69b4","indianred":"#cd5c5c","indigo":"#4b0082","ivory":"#fffff0","khaki":"#f0e68c","lavender":"#e6e6fa","lavenderblush":"#fff0f5","lawngreen":"#7cfc00","lemonchiffon":"#fffacd","lightblue":"#add8e6","lightcoral":"#f08080","lightcyan":"#e0ffff","lightgoldenrodyellow":"#fafad2","lightgrey":"#d3d3d3","lightgreen":"#90ee90","lightpink":"#ffb6c1","lightsalmon":"#ffa07a","lightseagreen":"#20b2aa","lightskyblue":"#87cefa","lightslategray":"#778899","lightsteelblue":"#b0c4de","lightyellow":"#ffffe0","lime":"#00ff00","limegreen":"#32cd32","linen":"#faf0e6","magenta":"#ff00ff","maroon":"#800000","mediumaquamarine":"#66cdaa","mediumblue":"#0000cd","mediumorchid":"#ba55d3","mediumpurple":"#9370d8","mediumseagreen":"#3cb371","mediumslateblue":"#7b68ee","mediumspringgreen":"#00fa9a","mediumturquoise":"#48d1cc","mediumvioletred":"#c71585","midnightblue":"#191970","mintcream":"#f5fffa","mistyrose":"#ffe4e1","moccasin":"#ffe4b5","navajowhite":"#ffdead","navy":"#000080","oldlace":"#fdf5e6","olive":"#808000","olivedrab":"#6b8e23","orange":"#ffa500","orangered":"#ff4500","orchid":"#da70d6","palegoldenrod":"#eee8aa","palegreen":"#98fb98","paleturquoise":"#afeeee","palevioletred":"#d87093","papayawhip":"#ffefd5","peachpuff":"#ffdab9","peru":"#cd853f","pink":"#ffc0cb","plum":"#dda0dd","powderblue":"#b0e0e6","purple":"#800080","rebeccapurple":"#663399","red":"#ff0000","rosybrown":"#bc8f8f","royalblue":"#4169e1","saddlebrown":"#8b4513","salmon":"#fa8072","sandybrown":"#f4a460","seagreen":"#2e8b57","seashell":"#fff5ee","sienna":"#a0522d","silver":"#c0c0c0","skyblue":"#87ceeb","slateblue":"#6a5acd","slategray":"#708090","snow":"#fffafa","springgreen":"#00ff7f","steelblue":"#4682b4","tan":"#d2b48c","teal":"#008080","thistle":"#d8bfd8","tomato":"#ff6347","turquoise":"#40e0d0","violet":"#ee82ee","wheat":"#f5deb3","white":"#ffffff","whitesmoke":"#f5f5f5","yellow":"#ffff00","yellowgreen":"#9acd32"}
    }
    function FindNamedColor(strr){
        let str=strr.toLowerCase();
        {// *** search for Named color
            let named_colors=Object.keys(AllNamedColors());
            named_colors=named_colors.sort(function(a, b){
              return b.length - a.length;
            }) // sort by name length, so darkblue is found before blue
            for(let l=0;l<named_colors.length;l++){// search for named color
                    let newstr=str.split(named_colors[l]).join('');
                    if(newstr.length<str.length){
                        return {found:true,color:named_colors[l],newstr:newstr}
                    }
            }
        }// *** search for Named color
        {// *** search for hex color
            let lhex=str.indexOf('#'); 
            if(lhex>-1){
                return {found:true,color:str.slice(lhex),newstr:str.slice(0,lhex)}
            }
        }// *** search for hex color
        {// *** search for basic color symbol
            let basic_cols_s=['r','g','b','c','m','y','k','w']
            let basic_cols_c=['red','green','blue','cyan','magenta','yellow','black','white']
            for(let l=0;l<basic_cols_s.length;l++){ // search for basic color symbol
                let newstr=str.split(basic_cols_s[l]).join('');
                if(newstr.length<str.length){
                    return {found:true,color:basic_cols_c[l],newstr:newstr}
                }
            }
        }// *** search for basic color symbol   
        return {found:false,color:null,newstr:str}
    }
    
    figureLib.Marker=Marker;
    figureLib.Circle=Circle;
    figureLib.Point=Point;
    figureLib.Rectangle=Rectangle;
    figureLib.Ellipse=Ellipse;
    figureLib.Polygon=Polygon;
    figureLib.Line=Line;
    figureLib.Text=Text;
    figureLib.Curve=Curve;
    figureLib.Tick=Tick;
    figureLib.Figure=Figure;
	return figureLib
}
function import_svgLib(){
	var xmlns = "http://www.w3.org/2000/svg"
	var svgLib={}
    let down_color='#3A749E';
    let up_color='#62BCFF';
    let hover_color='#57AEED';
    
	svgLib.newElement=function(svg_parent,type,parameter_list){
		var svgElem = document.createElementNS(xmlns,type)
		for (var i=0;i+1<parameter_list.length;i=i+2){
			svgElem.setAttributeNS(null,parameter_list[i],parameter_list[i+1]);
			}
		svg_parent.appendChild(svgElem);
		return svgElem
	}
	svgLib.Button=function(svg_parent,pic,x,y,width,height){
		var svg=document.createElementNS(xmlns,"svg")
        svg.setAttributeNS(null,'x','0px')
        svg.setAttributeNS(null,'y','0px')
		this.svg=svg
        let this_button=this;
		this.width=width
		this.height=height
		this.x=x
		this.y=y
        this.down=false;
		svg.setAttributeNS(null,'width',width);
		svg.setAttributeNS(null,'height',height);
		this.square=svgLib.newElement(svg,"rect",["x",0,"y",0,"width",width,"height",height,
		"fill",up_color,"stroke","DarkGrey","stroke-width",0.5])
        let this_square=this.square;
        svg.addEventListener('mouseover',function(){this_square.setAttributeNS(null,'fill',hover_color)})
        svg.addEventListener('mouseout',function(){
            if(this_button.down==false){this_square.setAttributeNS(null,'fill',up_color)}
            else{this_square.setAttributeNS(null,'fill',down_color)}
        })
		this.pic=pic
		pic(svg)
		svg.button=this
		this.down_appearence=function(){
        this.down=true;
		this.square.setAttributeNS(null,'fill',down_color);
		}
		this.up_appearence=function(){
        this.down=false;
		this.square.setAttributeNS(null,'fill',up_color);
		}
		this.updown_appearence=function(){
		this.down_appearence()
		var _this=this
		setTimeout(function(){_this.up_appearence()},100)
		}
		this.onclicked=null
		svg.addEventListener("click", function(evt){evt.currentTarget.button.onclicked()})
		svg_parent.appendChild(svg);
	}
	return svgLib
}
function import_draw(){
	var svgLib=import_svgLib()
	var draw={}
	draw.house=function(svg){
		var svgw=svg.getAttribute("width")
		var svgh=svg.getAttribute("height")
        let factor=0.8;
		var boxy=0.25*svgh
		var boxh=0.3*svgh*factor
		var roofhw=0.35*svgw*factor
		var roofh=0.3*svgw*factor
		var boxhw=0.25*svgw*factor
        let srokewidth=0.05*svgh
		var boxcol="white"
		var roofcol="white"

		svgLib.newElement(svg,"polygon",
		["points",[
        svgw/2-roofhw,svgh-(boxy+boxh),svgw/2,svgh-(boxy+boxh+roofh),svgw/2+roofhw,svgh-(boxy+boxh),
        svgw/2-boxhw+boxhw*2,svgh-(boxy+boxh),svgw/2-boxhw+boxhw*2,svgh-(boxy+boxh)+boxh,
        svgw/2-boxhw,svgh-(boxy+boxh)+boxh,svgw/2-boxhw,svgh-(boxy+boxh)
        ],
		"fill","none","stroke",boxcol,"stroke-width",srokewidth])
	}
    draw.play=function(svg){
		var svgw=svg.getAttribute("width")
		var svgh=svg.getAttribute("height")
		var xL=0.25*svgh
		var w=svgw-2*xL;
        var h=0.6*svgh
		var col="white"
		svgLib.newElement(svg,"polygon",
		["points",[xL,svgh/2+h/2,xL,svgh/2-h/2,xL+w,svgh/2],
		"fill",col])
	}
    draw.stop=function(svg){
		var svgw=svg.getAttribute("width")
		var svgh=svg.getAttribute("height")
        var w=0.5*svgw;
		var col="white"
		svgLib.newElement(svg,"rect",
		["x",(svgw-w)/2,"y",(svgh-w)/2,"width",w,"height",w,
		"fill",col])
	}
	draw.magnifying_glass=function(svg){
		var svgw=svg.getAttribute("width")
		var svgh=svg.getAttribute("height")
		var cx=0.4*svgw
		var cy=0.4*svgh
		var r=0.18*svgw
		var srokewidth=0.05*svgw
		var L=r*1.8
		var xi=cx+r/Math.sqrt(2)
		var yi=cy+r/Math.sqrt(2)
		var xf=xi+L/Math.sqrt(2)
		var yf=yi+L/Math.sqrt(2)
		var col="white"
		var sw=0.03*svgw
		svgLib.newElement(svg,"circle",
		["cx",cx,"cy",cy,"r",r,"fill","none","stroke",col,"stroke-width",srokewidth])
		svgLib.newElement(svg,"line",
		["x1",xi,"y1",yi,"x2",xf,"y2",yf,"stroke",col,"stroke-width",srokewidth])
	}
	draw.trash_can=function(svg){
		var svgw=svg.getAttribute("width")
		var svgh=svg.getAttribute("height")
		var tcx=0.5*svgw; var tcy=0.3*svgh
		var trx=0.22*svgw; var tpry=0.05*svgh
		var h=0.4*svgh
		var bcx=0.5*svgw; var bcy=tcy+h
		var brx=0.18*svgw; var bry=0.05*svgh
		var srokewidth=0.02*svgw

		var x1=bcx-brx; var y1=bcy
		var x2=bcx+brx; var y2=bcy
		var x3=tcx+trx; var y3=tcy
		var x4=tcx-trx; var y4=tcy


		svgLib.newElement(svg,"ellipse",
		["cx",bcx,"cy",bcy,"rx",brx,"ry",bry,"fill","white","stroke","none"])
		svgLib.newElement(svg,"polygon",
		["points",[x1,y1,x2,y2,x3,y3,x4,y4],
		"fill","white","stroke","none"])
		svgLib.newElement(svg,"ellipse",
		["cx",tcx,"cy",tcy,"rx",trx,"ry",tpry,"fill","white","stroke","grey","stroke-width",srokewidth])

	}
	draw.cross=function(svg){
		var svgw=svg.getAttribute("width")
		var svgh=svg.getAttribute("height")
		var marginw=0.05*svgw
		var marginh=0.05*svgh
		var x=0.6*svgw
		var y=0.7*svgh
		var srokewidth=0.05*svgw
		var col="white"
		svgLib.newElement(svg,"line",
		["x1",marginw,"y1",y,"x2",svgw-marginw,"y2",y,"stroke",col,"stroke-width",srokewidth])
		svgLib.newElement(svg,"line",
		["x1",x,"y1",marginh,"x2",x,"y2",svgh-marginh,"stroke",col,"stroke-width",srokewidth])
	}
	return draw
}
function import_MagicSyntax(){
    let Lib={};
    //** default operators, new global variable that contains the arithmetic operations. Can be modified directly by the user.
    function OperatorFun2args(as,bs,funs){
        let aisA=Array.isArray(as),bisA=Array.isArray(bs);
        if(!aisA&&!bisA){
            return funs(as,bs)
        }
        if(aisA&&!bisA){return as.map(a=>OperatorFun2args(a,bs,funs))}
        if(!aisA&&bisA){return bs.map(b=>OperatorFun2args(as,b,funs))}
        if(aisA&&bisA){
            if(as.length!=bs.length){throw {message:'array lengths must be the same'}}
            else {return as.map((a,i)=>OperatorFun2args(a,bs[i],funs))}
        }
    }
    Operators={
        concat:{str:'[+]',args:[-1,1],type:'Matrix',
                fun:function(as,bs){try{
                    if(typeof as=='undefined'||typeof bs=='undefined'){return undefined}
                    let aisA=Array.isArray(as),bisA=Array.isArray(bs);
                    if(!aisA&&!bisA){return [as,bs]}
                    if(aisA&&!bisA){return as.concat([bs])}
                    if(!aisA&&bisA){return [as].concat(bs)}
                    if(aisA&&bisA){return as.concat(bs)}}
                    catch(err){err.message="using [+], "+err.message; throw(err) } }
                ,newline:true
              },
        power:{str:'**',args:[-1,1],type:'Arithmetic',
                funs:function(a,b){
                    if(typeof a=='undefined'||typeof b=='undefined'){return undefined}
                    if(!a.isComplexNumber&&!b.isComplexNumber&&(a>0||Number.isInteger(b))){return a**b}
                            else {
                                return exp(Operators.multiply.fun(log(a),b));
                            }
                },
                fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                newline:true
              },
        multiply:{str:'*',args:[-1,1],type:'Arithmetic',
                    funs:function(a,b){
                        if(typeof a=='undefined'||typeof b=='undefined'){return undefined}
                        if(!a.isComplexNumber&&!b.isComplexNumber){return a*b}
                            else {
                                return ComplexNumber(a.Re*b.Re-a.Im*b.Im,a.Re*b.Im+a.Im*b.Re)
                            }
                    },
                    fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true
        },
        divide:{str:'/',args:[-1,1],type:'Arithmetic',
                funs:function(a,b){
                    if(typeof a=='undefined'||typeof b=='undefined'){return undefined}
                    if(!a.isComplexNumber&&!b.isComplexNumber){return a/b}
                        else {
                                let denum=b.Im**2+b.Re**2;
                                return ComplexNumber(
                                    (a.Re*b.Re+a.Im*b.Im)/denum,
                                    (a.Im*b.Re-a.Re*b.Im)/denum
                                )
                            }
                    },
                fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true
        },
        add:{str:'+',args:[-1,1],type:'Arithmetic',
            funs:function(a,b){
                if(typeof a=='undefined'||typeof b=='undefined'){return undefined}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a+b}
                    else {
                        return ComplexNumber(a.Re+b.Re,a.Im+b.Im)
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true
        },
        subtract:{str:'-',args:[-1,1],type:'Arithmetic',
                    funs:function(a,b){
                        if(typeof a=='undefined'||typeof b=='undefined'){return undefined}
                        if(!a.isComplexNumber&&!b.isComplexNumber){return a-b}
                            else {
                                return ComplexNumber(a.Re-b.Re,a.Im-b.Im)
                            }
                    },
                    fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true
                 },
        modulus:{str:'%',args:[-1,1],type:'Arithmetic',
                 funs:function(a,b){
                     if(typeof a=='undefined'||typeof b=='undefined'){return undefined}
                     if(!a.isComplexNumber&&!b.isComplexNumber){return a%b}
                            else {
                                throw {message:"arguments must be real"}
                            }
                 },
                 fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true
                 },
        increment:{str:'++',args:[-1],type:'ArithmeticChange',fun:null,newline:true},
        decrement:{str:'--',args:[-1],type:'ArithmeticChange',fun:null,newline:true},
        equal:{str:'=',args:[-1,'toeol'],type:'Assignment',fun:null,newline:true},
        addequal:{str:'+=',args:[-1,'toeol'],type:'ArithmeticAssignment',fun:'add',newline:true},
        subtractequal:{str:'-=',args:[-1,'toeol'],type:'ArithmeticAssignment',fun:'subtract',newline:true},
        multiplyequal:{str:'*=',args:[-1,'toeol'],type:'ArithmeticAssignment',fun:'multiply',newline:true},
        divideequal:{str:'/=',args:[-1,'toeol'],type:'ArithmeticAssignment',fun:'divide',newline:true},
        modulusequal:{str:'%=',args:[-1,'toeol'],type:'ArithmeticAssignment',fun:'modulus',newline:true},
        powerequal:{str:'**=',args:[-1,'toeol'],type:'ArithmeticAssignment',fun:'power',newline:true},
        equalto:{str:'==',args:[2],type:'Comparison',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a==b}
                    else {
                        return a.Re==b.Re && a.Im==b.Im
                    }
            },
            fun:function(as,bs){
                if(typeof as=='undefined' && typeof bs=='undefined'){return true}
                try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        equaltovaluetype:{str:'===',args:[2],type:'Comparison',fun:null,newline:true},
        notequalto:{str:'!=',args:[2],type:'Comparison',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a!=b}
                    else {
                        return a.Re!=b.Re || a.Im!=b.Im
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        notequaltovaluetype:{str:'!==',args:[2],type:'Comparison',fun:null,newline:true},
        greaterthan:{str:'>',args:[2],type:'Comparison',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a>b}
                    else {
                        throw {message:'arguments must be real'}
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        lessthan:{str:'<',args:[2],type:'Comparison',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a<b}
                    else {
                        throw {message:'arguments must be real'}
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        greaterorequalto:{str:'>=',args:[2],type:'Comparison',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a>=b}
                    else {
                        throw {message:'arguments must be real'}
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        lessthanorequalto:{str:'<=',args:[2],type:'Comparison',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a<=b}
                    else {
                        throw {message:'arguments must be real'}
                    }
            },              
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        ternary:{str:'?',args:[3],type:'Comparison:',fun:null,newline:true},
        and:{str:'&&',args:[2],type:'Logical',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a&&b}
                    else {
                        throw {message:'arguments must be real'}
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        or:{str:'||',args:[2],type:'Logical',
            funs:function(a,b){
                if(typeof a=='undefined' || typeof b=='undefined'){return false}
                if(!a.isComplexNumber&&!b.isComplexNumber){return a||b}
                    else {
                        throw {message:'arguments must be real'}
                    }
            },
            fun:function(as,bs){try{return OperatorFun2args(as,bs,this.funs)}catch(err){err.message="using "+this.str+", "+err.message; throw(err)}},
                  newline:true},
        not:{str:'!',args:[1],type:'Logical',fun:null,newline:true},
        funassign:{str:'=>',args:[2],type:'Function',fun:null,newline:false},
        andBit:{str:'&',args:[2],type:'Bitwise',fun:null,newline:true},
        orBit:{str:'|',args:[2],type:'Bitwise',fun:null,newline:true},
        notBit:{str:'~',args:[1],type:'Bitwise',fun:null,newline:true},
        xorBit:{str:'^',args:[2],type:'Bitwise',fun:null,newline:true},
        zerofillleftshift:{str:'<<',args:[2],type:'Bitwise',fun:null,newline:true},
        signedrightshift:{str:'>>',args:[2],type:'Bitwise',fun:null,newline:true},
        zerofillrightshift:{str:'>>>',args:[2],type:'Bitwise',fun:null,newline:true}
    }
    let Commands={
        return:{str:'return ',ignore_newline:{before:false,after:0}},
        function:{str:'function ',ignore_newline:{before:false,after:2}},
        else:{str:'else ',ignore_newline:{before:true,after:1}},
        new:{str:'new ',ignore_newline:{before:false,after:1}},
        let:{str:'let ',ignore_newline:{before:false,after:1}},
        const:{str:'const ',ignore_newline:{before:false,after:1}},
        typeof:{str:'typeof ',ignore_newline:{before:false,after:1}},
        var:{str:'var ',ignore_newline:{before:false,after:1}},
        if:{str:'if ',ignore_newline:{before:false,after:2}},
        while:{str:'while ',ignore_newline:{before:false,after:2}},
        for:{str:'for ',ignore_newline:{before:false,after:2}},
        class:{str:'class ',ignore_newline:{before:false,after:2}}
    }
    let string_paranthesis=['"','`',"'"];
    function replace_external(string,str1,str2){
        let i=0; let str=string;
        while(i<str.length){
            if(isNextStr(str.slice(i),str1)){
                str=str.slice(0,i)+str2+str.slice(i+str1.length);
                i+=str2.length;
            } else {
                let lp=string_paranthesis.indexOf(str[i]);
                if(lp>-1){
                    let par_str=string_paranthesis[lp];
                    let iclose=str.slice(i+1).indexOf(par_str);
                    if(iclose==-1){throw {message:"problem with replace_external: unclosed "+par_str}; return str.slice(i+1)}
                    else{i=i+iclose+2}
                } else {i++};
            }
        }
        return str;
    }
    function isNextStr(string,str){
        if(str.length==0){return false}
        else {return string.slice(0,str.length)==str}
    }
    let operator_keys=Object.keys(Operators);
    let operator_strings=operator_keys.map((v,i)=>Operators[operator_keys[i]].str);
    let operator_groups_by_order=[['concat'],['power'],['multiply','divide','modulus'],['add','subtract'],['greaterthan','lessthan','greaterorequalto','lessthanorequalto'],['equalto','notequalto'],['and','or']];
    let operator_arithmetic_assignments=['addequal','subtractequal','multiplyequal','divideequal','modulusequal'];
    let command_keys=Object.keys(Commands);
    let command_strings=command_keys.map((v,i)=>Commands[command_keys[i]].str);
    function NoSemiCol(str){
        if(str==':'||str==','||str==';'){return true}
        let lop=operator_strings.indexOf(str);
        if(lop==-1){return false}
        return Operators[operator_keys[lop]].newline;
    }
    function IgnoreNewline(exps,i){
        let prev=exps.strs[i-1], next=exps.strs[i+1];
        if(NoSemiCol(prev)||NoSemiCol(next)){return true}
        let lcnext=lCommand(next); if(lcnext>-1){if(Commands[command_keys[lcnext]].ignore_newline.before){return true}}
        let lcprev=lCommand(prev); if(lcprev>-1){if(Commands[command_keys[lcprev]].ignore_newline.after>0){return true}}
        if(i>1){
            let prev2=exps.strs[i-2]; let lcprev2=lCommand(prev2); 
            if(lcprev2>-1){if(Commands[command_keys[lcprev2]].ignore_newline.after>1){return true}}
        }
        return false
    }
    function OperatorsIndexOfNext(string){
        let OpStrLmax=Math.max(...Object.keys(Operators).map(v=>Operators[v].str.length));
        for(let l=OpStrLmax;l>0;l--){
            let str=string.slice(0,l);
            let i=operator_strings.indexOf(str);
            if(i>-1){return i}
        }
        return -1;
    }
    //*** string manipulation
    function sumStr(x){
        let s;
        if(Array.isArray(x)){
            if(x.length>0){
                s=x[0]
                for(var l=1;l<x.length;l++){
                    s=s+x[l];
                }
            } else {s=0};
        } else {s=x}
        return s;
    }
    function next_non_eol_space_comment(str,i){//Under construction
        while(i<str.length){
            if(str[i]==' '||str[i]=='\n'){i++}
            else if(str[i]=='/'&&str[i+1]=='/'){ // comment of type //
                let ieol=indexOf_after_index(str,'\n',i+1);
                if(ieol==-1){return null}
                else {i=ieol+1}                
            }
            else if(str[i]=='/'&&str[i+1]=='*'){ // comment of type /* */
                let ieol=indexOf_after_index(str,'*/',i+1);
                if(ieol==-1){return null}
                else {i=ieol+2}           
            }
            else{return i}
        } 
        return null
    }
    function indexOf_closing_parenthesis(str,parL,parR,iL){
        let i=iL;
        let depth=1;
        while (depth>0&&i<str.length){
            i=i+1;
            let c=str[i];
            if (c=="'"){
                let i2=str.slice(i+1).indexOf("'");
                if(i2==-1){throw {message:err_str+"unclosed '"}; return -1}
                else{i=i2+i+1};
            } 
            else if (c=='"'){
                let i2=str.slice(i+1).indexOf('"');
                if(i2==-1){throw {message:err_str+'unclosed "'};return -1}
                else{i=i2+i+1};
            } 
            else if (c=='`'){
                let i2=str.slice(i+1).indexOf('`');
                if(i2==-1){throw {message:err_str+'unclosed `'};return -1}
                else{i=i2+i+1}
            }
            if (c==parL){depth=depth+1};
            if (c==parR){depth=depth-1};
        }
        if(depth==0){return i} else {return -1};
    }
    function indexOf_after_index(xs,x,i0){
        let i=xs.slice(i0+1).indexOf(x);
        if(i==-1){return -1}
        else {return i+i0+1}
    }
    function isWhiteSpaceOrEmpty(str){
        if(str.length==0){return true}
        else {
            let l=0;
            while(l<str.length){
                if((str[l]!=' ')&&(str[l]!='\t')){return false};
                l++;
            }
            return true;
        }
    }
    function isNextNumber(string){
        let isNum,len;
        if(!isNaN(string[0])){isNum=true;len=1}
        else if (!isNaN(string.slice(0,2))){isNum=true;len=2}
        else {return {is:false,numstr:'',strnext:string}}
        while(!isNaN(string.slice(0,len))||!isNaN(string.slice(0,len+1))||!isNaN(string.slice(0,len+2))){
            if(len==string.length||string[len]=='\n'||string[len]==' '||string[len]=='\t'){return {is:true,numstr:string.slice(0,len),strnext:string.slice(len)}}
            len++;
        }
        return {is:true,numstr:string.slice(0,len-1),strnext:string.slice(len-1)}
    }
    function lCommand(string){
        let lc=command_strings.indexOf(string)
        return lc;
    }
    
    // *** parsing 
    function magic_syntax(code_str){
        if(code_str.slice(0,3)=='***'){return code_str.slice(3)}
        magic_replace_operators=1;
        let parsed=magic_parse(code_str);
        return parsed;
    }
    function magic_parse(string){
        if(string.slice(0,2)=='**'){return string.slice(2)}
        let str; let exps={strs:[],types:[]}
        {// deal with setting magic_replace_operators off, remove tabs, find exps.strs
            if(string[0]=='*'){
                magic_replace_operators=0;
                str=string.slice(1);
            } else {str=string}
            str=replace_external(str,'\t',' '); //replace tabs with spaces.
            str=replace_external(str,'^','**'); //replace common power simbol ^ with javascript power **.
            while(str.length>0){//find exps.strs this is needed even if magic_replace_operators is off, in case user set it to off by adding * at different depths.
                let expr=magic_next_exp(str);
                exps.strs.push(expr.str);
                exps.types.push(magic_exp_type(expr.str));
                str=expr.strnext;
            }//find exps.strs 
            if (!magic_replace_operators){return sumStr(exps.strs)}
        }// deal with setting magic_replace_operators off, remove tabs, find exps.strs
        //** operations strings and functions
        while(exps.types[0]=='\n'||exps.types[0]==''){//remove empty space and new lines in the beggining
                exps.types=exps.types.slice(1);
                exps.strs=exps.strs.slice(1);
        }//remove empty space and new lines in the beggining
        {//remove \n or replace them with ; when needed.
            let i_newline=exps.types.indexOf('\n');
            while(i_newline>-1){
                while(exps.types[i_newline+1]=='\n'||exps.types[i_newline+1]==''){//remove empty space and new lines after newline
                    exps.types=array_remove_item(exps.types,i_newline+1);
                    exps.strs=array_remove_item(exps.strs,i_newline+1);
                }//remove empty space and new lines after newline
                while(exps.types[i_newline-1]==''){//remove empty space before newline
                    exps.types=array_remove_item(exps.types,i_newline-1);
                    exps.strs=array_remove_item(exps.strs,i_newline-1);
                    i_newline+=-1;
                }//remove empty space before newline
                if(i_newline==0){
                    exps.types=exps.types.slice(1);
                    exps.strs=exps.strs.slice(1);
                }
                if(i_newline==exps.types.length-1){
                    exps.types=exps.types.slice(0,i_newline);
                    exps.strs=exps.strs.slice(0,i_newline);
                } 
                else {
                    if(IgnoreNewline(exps,i_newline)){
                        exps.types=array_remove_item(exps.types,i_newline);
                        exps.strs=array_remove_item(exps.strs,i_newline);
                    } 
                    else {
                        exps.types[i_newline]=';';
                        exps.strs[i_newline]=';';
                    }
                }
                i_newline=exps.types.indexOf('\n');         
            } 
        }//remove \n or replace them with ; when needed.
        {// make detached + into (+1)*
            let i=exps.types.indexOf('+');
            while(i>-1){ 
                if(i==0){
                    exps.types=['exp','*'].concat(exps.types.slice(1));
                    exps.strs=['(+1)','*'].concat(exps.strs.slice(1));
                    i=exps.types.indexOf('+');
                } else if (i==exps.types.length){
                    throw ({message:'expected expression after +'})
                    i=-1;
                } else {
                    let prev_type=exps.types[i-1], next_type=exps.types[i+1]
                    if (prev_type=='**'&&next_type=='exp'){
                        exps.types=exps.types.slice(0,i).concat(['exp']).concat(exps.types.slice(i+2));
                        exps.strs=exps.strs.slice(0,i).concat(['Operators.add.fun(0,'+exps.strs[i+1]+')']).concat(exps.strs.slice(i+2));
                    } else if(prev_type!='exp'&&next_type=='exp'){
                        exps.types=exps.types.slice(0,i).concat(['exp','*']).concat(exps.types.slice(i+1));
                        exps.strs=exps.strs.slice(0,i).concat(['(+1)','*']).concat(exps.strs.slice(i+1));
                    } 
                    i=indexOf_after_index(exps.types,'+',i); 
                }      
            }
        }// make detached + into (+1)*
        {// make detached - into (-1)*
            let i=exps.types.indexOf('-');
            while(i>-1){ 
                if(i==0){
                    exps.types=['exp','*'].concat(exps.types.slice(1));
                    exps.strs=['(-1)','*'].concat(exps.strs.slice(1));
                    i=exps.types.indexOf('-');
                } else if (i==exps.types.length){
                    throw ({message:'expected expression after -'})
                    i=-1;
                } else {
                    let prev_type=exps.types[i-1], next_type=exps.types[i+1]
                    if (prev_type=='**'&&next_type=='exp'){
                        exps.types=exps.types.slice(0,i).concat(['exp']).concat(exps.types.slice(i+2));
                        exps.strs=exps.strs.slice(0,i).concat(['Operators.subtract.fun(0,'+exps.strs[i+1]+')']).concat(exps.strs.slice(i+2));
                    } else if(prev_type!='exp'&&next_type=='exp'){
                        exps.types=exps.types.slice(0,i).concat(['exp','*']).concat(exps.types.slice(i+1));
                        exps.strs=exps.strs.slice(0,i).concat(['(-1)','*']).concat(exps.strs.slice(i+1));
                    } 
                    i=indexOf_after_index(exps.types,'-',i); 
                }        
            }
        }// make detached - into (-1)*
        operator_groups_by_order.forEach((group,igroup)=>{//replace operators with functions
            let group_types=group.map(v=>magic_exp_type(Operators[v].str))
            let iexp=0;
            while(iexp<exps.types.length){
                let type=exps.types[iexp];
                let iop=group_types.indexOf(type);
                if(iop>-1){
                    opkey=group[iop];
                    op=Operators[opkey];
                    if(!(exps.types[iexp-1]=='exp'&&exps.types[iexp+1]=='exp')){
                        throw ({message:'problem with'+op.str})
                        return} else {
                        let exp_op='Operators.'+opkey+'.fun('+exps.strs[iexp-1]+','+exps.strs[iexp+1]+')';
                        exps.strs=exps.strs.slice(0,iexp-1).concat([exp_op]).concat(exps.strs.slice(iexp+2));
                        exps.types=exps.types.slice(0,iexp-1).concat(['exp']).concat(exps.types.slice(iexp+2));
                    }
                } else {
                    iexp++;
                }
            }    
        })//replace operators with functions
        {//replace arithmetic assignments with functions
            let group=operator_arithmetic_assignments;
            let group_types=group.map(v=>magic_exp_type(Operators[v].str))
            let iexp=exps.types.length;
            while(iexp>0){
                let type=exps.types[iexp];
                let iop=group_types.indexOf(type);
                if(iop>-1){
                    opkey=group[iop];
                    op=Operators[opkey];
                    if(!(exps.types[iexp-1]=='exp'&&exps.types[iexp+1]=='exp')){
                        throw ({message:'problem with'+op.str})
                        return} else {
                        let exp_op='('+exps.strs[iexp-1]+'=Operators.'+op.fun+'.fun('+exps.strs[iexp-1]+','+exps.strs[iexp+1]+'))';
                        exps.strs=exps.strs.slice(0,iexp-1).concat([exp_op]).concat(exps.strs.slice(iexp+2));
                        exps.types=exps.types.slice(0,iexp-1).concat(['exp']).concat(exps.types.slice(iexp+2));
                        iexp-=2;
                    }
                } else {
                    iexp--;
                }
            }    
        }//replace arithmetic assignments with functions
        if(exps.strs.length>0){return sumStr(exps.strs)} else {return ''}
    }
    function magic_exp_type(string){
        if(isWhiteSpaceOrEmpty(string)){return ''}
        if(lCommand(string)>-1){return 'command'}
        let types=['\n',';',',',':'].concat(operator_strings);
        let iop=types.indexOf(string);
        if(iop>-1){return types[iop]} else {return 'exp'} 
    }
    function magic_next_exp(string){
        if(isWhiteSpaceOrEmpty(string)){return {str:'',strnext:''}};
        let i=0;
        let str=string;
        let failed={str:null,strnext:null};
        let err_str='failed parser: ';
        function str0toi(){
            let strr=str.slice(0,i);
            if(lCommand(strr+' ')>-1){strr+=' '}
            return strr      
        }
        while(i<str.length){
            let c=str[i];
            if(c==' '){
                if(i==0){
                    while(str[i]==' '){i++}
                    str=str.slice(i); i=0; c=str[i]; 
                } else {return {str:str0toi(),strnext:str.slice(i)}}
            }
            if (i==0&&(str.slice(0,5)=='TABLE'||str.slice(0,5)=='Table')){
                let i0=next_non_eol_space_comment(str,5)
                if (str[i0]=='{'){
                    let i1=indexOf_closing_parenthesis(str,'{','}',i0)
                    if(i1==-1){throw {message:err_str+'table missing }'};return failed}
                    else {
                        return {str:magic_table(str.slice(i0+1,i1)),strnext:str.slice(i1+1)}}
                }
            }
            if(c=='\n'){
                if(i==0){return {str:'\n',strnext:str.slice(1)}}
                else {return {str:str0toi(),strnext:str.slice(i)}}
            }
            else if(c==';'){
                if(i==0){return {str:';',strnext:str.slice(1)}}
                else {return {str:str0toi(),strnext:str.slice(i)}}
            }
            else if(c==','){
                if(i==0){return {str:',',strnext:str.slice(1)}}
                else {return {str:str0toi(),strnext:str.slice(i)}}
            }
            else if(c==':'){
                if(i==0){return {str:':',strnext:str.slice(1)}}
                else {return {str:str0toi(),strnext:str.slice(i)}}
            }
            else if(str[i]=='/'&&str[i+1]=='/'){ // comment of type //
                let ieol=indexOf_after_index(str,'\n',i+1);
                if(ieol==-1){return {str:str.slice(0,i),strnext:''}}
                else {return {str:str0toi(),strnext:str.slice(ieol)}}                
            }
            else if(str[i]=='/'&&str[i+1]=='*'){ // comment of type /* */
                let ieol=indexOf_after_index(str,'*/',i+1);
                if(ieol==-1){return {str:str.slice(0,i),strnext:''}}
                else {return {str:str0toi(),strnext:str.slice(ieol+2)}}           
            }
            
            let iop=OperatorsIndexOfNext(str.slice(i));
            if(iop>-1){
                let Opkey=operator_keys[iop];
                let Op=Operators[Opkey];
                if(i==0){return {str:Op.str,strnext:str.slice(Op.str.length)}} 
                else {return {str:str0toi(),strnext:str.slice(i)}}
            }
            if(i==0){ //if number
               let isnum=isNextNumber(str)
                if(isnum.is){return {str:isnum.numstr,strnext:isnum.strnext}}
            }//if number
            if(c=='('){
                if(lCommand(str.slice(0,i)+' ')>-1){return {str:str.slice(0,i)+' ',strnext:str.slice(i)}}
                let i1=indexOf_closing_parenthesis(str,'(',')',i)
                if(i1==-1){throw {message:err_str+'unclosed ('};return failed}
                else {
                    let str_parsed=magic_parse(str.slice(i+1,i1))
                    str=str.slice(0,i+1)+str_parsed+str.slice(i1);
                    i=i+str_parsed.length+1;
                }
            } 
            else if (c==')'){throw {message:err_str+'unclosed )'};return failed}
            else if (c=='['){
                if(lCommand(str.slice(0,i)+' ')>-1){return {str:str.slice(0,i)+' ',strnext:str.slice(i)}}
                let i1=indexOf_closing_parenthesis(str,'[',']',i)
                if(i1==-1){throw {message:err_str+'unclosed ['};return failed}
                else {
                    let str_parsed=magic_square_brackets_parse(str.slice(i+1,i1))
                    str=str.slice(0,i)+str_parsed+str.slice(i1+1);
                    i=i+str_parsed.length-1;
                }
            }
            else if (c==']'){throw {message:err_str+'unclosed ]'};return failed}
            else if (c=='{'){
                if(i>0){return {str:str0toi(),strnext:str.slice(i)}}
                let i1=indexOf_closing_parenthesis(str,'{','}',i)
                if(i1==-1){throw {message:err_str+'unclosed {'};return failed}
                else {
                    let str_parsed=magic_parse(str.slice(i+1,i1))
                    return {str:'{'+str_parsed+'}',strnext:str.slice(i1+1)}
                }
            } 
            else if (c=='}'){throw {message:err_str+'unclosed }'};return failed}
            else if (c=="'"){
                if(i>0){return {str:str0toi(),strnext:str.slice(i)}}
                let i2=str.slice(i+1).indexOf("'");
                if(i2==-1){throw {message:err_str+"unclosed '"}; return failed}
                else{i=i2+i+1};
            } 
            else if (c=='"'){
                if(i>0){return {str:str0toi(),strnext:str.slice(i)}}
                let i2=str.slice(i+1).indexOf('"');
                if(i2==-1){throw {message:err_str+'unclosed "'};return failed}
                else{i=i2+i+1}
            } 
            else if (c=='`'){
                if(i>0){return {str:str0toi(),strnext:str.slice(i)}}
                let i2=str.slice(i+1).indexOf('`');
                if(i2==-1){throw {message:err_str+'unclosed `'};return failed}
                else{i=i2+i+1}
            }
            i=i+1;
        }
        return {str:str0toi(),strnext:''}
}
    function magic_square_brackets_parse(string){
        let expr=magic_next_exp(string);
        let exp1='',exp2='',exp3='',strnext='';
        while(magic_exp_type(expr.str)!=':'){
            exp1=exp1+expr.str;
            if(expr.strnext==''){return '['+magic_parse(exp1)+']'}
            expr=magic_next_exp(expr.strnext);
        }
        expr=magic_next_exp(expr.strnext);
        while(magic_exp_type(expr.str)!=':'){
            exp2=exp2+expr.str;
            if(expr.strnext==''){return 'arange('+magic_parse(exp1)+','+magic_parse(exp2)+','+'1)'};
            expr=magic_next_exp(expr.strnext);
        }
        return 'arange('+magic_parse(exp1)+','+magic_parse(expr.strnext)+','+magic_parse(exp2)+')';
    }
    function magic_table(string){
        let str=string;
        let exps={strs:[],types:[]};
        {//extract expressions 
            while(str.length>0){
                let expr=magic_next_exp(str);
                let type=magic_exp_type(expr.str);
                exps.strs.push(expr.str);
                exps.types.push(type);
                str=expr.strnext;
            }
        }//extract expressions 
        {//make sure last line ends with newline
            exps.strs.push('\n')
            exps.types.push('\n')
        }//make sure last line ends with newline
        {//remove empty space and new lines in the beggining
            while(exps.types[0]=='\n'||exps.types[0]==''||exps.types[0]=='\t'){
                exps.types=exps.types.slice(1);
                exps.strs=exps.strs.slice(1);}
        }//remove empty space and new lines in the beggining
        {//remove extra newlines and spaces at ends and begginings of lines
            let i_newline=exps.types.indexOf('\n');
            while(i_newline>-1){
                while(exps.types[i_newline+1]=='\n'||exps.types[i_newline+1]==''||exps.types[i_newline+1]=='\t'){//remove empty space and new lines after newline
                    exps.types=array_remove_item(exps.types,i_newline+1);
                    exps.strs=array_remove_item(exps.strs,i_newline+1);
                }//remove empty space and new lines after newline
                
                while(exps.types[i_newline-1]==''||exps.types[i_newline-1]=='\t'){//remove empty space before newline
                    exps.types=array_remove_item(exps.types,i_newline-1);
                    exps.strs=array_remove_item(exps.strs,i_newline-1);
                    i_newline+=-1;
                }//remove empty space before newline
               
                i_newline=indexOf_after_index(exps.types,'\n',i_newline);         
            } 
        }//remove extra newlines and spaces at ends and begginings of lines
        let iexp=0;
        let varnames=[],rows=[];
        {// read headline
            let ind_eol=exps.types.indexOf('\n');
            if(ind_eol<1){
                throw ({message:'problem reading the headline of the table'})
                return table;
            } 
            for(let l=0;l<ind_eol;l++){
                if(exps.types[l]=='exp'){
                    varnames.push(exps.strs[l]);
                }
            }
            if(varnames.length==0){
                throw ({message:'headline seems to have no column names'})
                return ' ';
            }
            iexp=ind_eol;
        }// read headline
        {// read data
            let ind_eol=indexOf_after_index(exps.types,'\n',iexp);
            while(ind_eol!=-1){
                let row=[];
                for(let l=iexp+1;l<ind_eol;l++){
                    if(exps.types[l]=='-'){
                        if(exps.types[l+1]=='exp'){
                            row.push(exps.strs[l]+exps.strs[l+1]);
                            l++;
                        } else {throw {message:'problem with TABLE with - without following expression'}; return ' '}
                    } 
                    else if(exps.types[l]=='exp'){
                        let str=exps.strs[l];
                        if(isNextNumber(str).is || str[0]=="'" || str[0]=='"' || str[0]=='`' || str[0]=='('){
                            row.push(exps.strs[l]);
                        }
                        else {row.push("'"+exps.strs[l]+"'")}
                    }
                }
                rows.push(row);
                iexp=ind_eol;
                ind_eol=indexOf_after_index(exps.types,'\n',ind_eol);
            }
        }// read data
        let varsvals=[];
        for(let l=0;l<varnames.length;l++){
            varsvals.push('[');
        }
        for(let lr=0;lr<rows.length;lr++){
            let row=rows[lr];
            for(let lexp=0;lexp<row.length;lexp++){
                varsvals[lexp]+=row[lexp]+',';
            }
        }
        for(let l=0;l<varnames.length;l++){
            let len=varsvals[l].length;
            if(len==1){varsvals[l]='[]'}
            else{varsvals[l]=varsvals[l].slice(0,len-1)+']'};
        }
        let return_str=[];
        for(let l=0;l<varnames.length;l++){
            return_str=return_str+varnames[l]+'='+varsvals[l]+';';
        }
        return return_str;
    }
    function magic_function(name,arguments_string,script){
        try{
            let parsed=magic_syntax(script)
            let code = name+'=function'+arguments_string+'{try{'+parsed+'} catch(err){err.message="in '+ name +', "+err.message; throw(err) } }';
            eval(code);        }
        catch(err){
            let code = name + '=function(){}';
            eval(code);
            throw(err)
        }
    }
    function ParseName(str){
        let str_ns = str.replace(/\s+/g, '');
        let iL=str_ns.indexOf('(');
        if(iL==-1){return {name:str_ns,arguments_string:"()"}}
        else {
            let iR=indexOf_closing_parenthesis(str_ns,'(',')',iL)
            if(iR==-1){iR=str_ns.length; str_ns+=')'}
            return {name:str_ns.slice(0,iL),arguments_string:str_ns.slice(iL,iR+1)}
        }
    }
             
    //*** iscripts
    class Iscript {
        constructor(copy,iscriptLibrary){
            this.name=copy.name;
            this._script=copy.script;
            this._arguments_string=copy.arguments_string;
            this.iscriptLibrary=iscriptLibrary;
            this.AddMe();
        }
        Parse(){
            try {magic_function(this.name,this._arguments_string,this._script)}
            catch(err) {
                err.message="in " + this.name + ", "+err.message;
                ErrorPrint(err);
            }
        }

        AddMe(){this.iscriptLibrary.Add(this)}
        RemoveMe(){this.iscriptLibrary.Remove(this)}

        get script(){return this._script}
        set script(str){this._script=str; this.Parse()}
        get arguments_string(){return this._arguments_string}
        set arguments_string(str){this._arguments_string=str; this.Parse()}

        save(){
            let copy={}
            copy.name=this.name;
            copy.script=this._script;
            copy.arguments_string=this._arguments_string;
            return copy;
        }
    }
    class IscriptLibrary {
        constructor(copy){
            this.type='IscriptLibrary'
            this.iscripts=[]
            if(!(copy==undefined)){
                let isc_copies=copy.iscripts;
                for(let l=0;l<isc_copies.length;l++){
                    let iscr=new Iscript(isc_copies[l],this)
                }
            }
            this.selectElements=[] 
        }
        Add(iscript){
            let iscri=this.iscripts.findIndex(isc=>(isc.name==iscript.name));
            if(iscri==-1){
                this.iscripts.push(iscript);
            }
            else {
                this.iscripts[iscri]=iscript;
            }
            iscript.Parse()
        }
        Remove(iscript){
            let iisc=this.iscripts.indexOf(iscript)
            if(iisc>-1){this.iscripts.splice(iisc,1)}
        }
        Clear(){
            this.iscripts=[]
        }
        getIscriptByName(name){
            let iscri=this.iscripts.findIndex(isc=>(isc.name==name))
            if(iscri==-1){
                return undefined;
            }
            else {
                return this.iscripts[iscri]
            }
        }
        save(){
                let copy={};
                copy.type='iscriptLibrary';
                copy.iscripts=this.iscripts.map(obj=>obj.save());
                return copy;
        }    
    }
        
    //*** ifunctions
    class Ifunction {
        constructor(copy){
            this.fun=copy.fun;
            this.name=copy.name;
            this.help=copy.help;
            this.category=copy.category;
            window[copy.name]=function(){try {return copy.fun.apply(null,arguments)} catch(err) {err.message='in '+copy.name+', '+err.message; throw(err)}};
        }
    }
    
    //*** return functions
    Lib.magic_syntax=magic_syntax;
    Lib.magic_parse=magic_parse;
    Lib.magic_exp_type=magic_exp_type;
    Lib.magic_next_exp=magic_next_exp;
    Lib.magic_table=magic_table;
    Lib.magic_square_brackets_parse=magic_square_brackets_parse;
    Lib.ParseName=ParseName;
    Lib.Iscript=Iscript;
    Lib.IscriptLibrary=IscriptLibrary;
    Lib.indexOf_after_index=indexOf_after_index;
    Lib.indexOf_closing_parenthesis=indexOf_closing_parenthesis;
    Lib.isNextNumber=isNextNumber;
    Lib.replace_external=replace_external;
    Lib.isNextStr=isNextStr;
    Lib.Ifunction=Ifunction;
    return Lib;
}   

// *** Layout
function set_to_grid(div,parent,columns,rows){
	parent.appendChild(div);
	div.style.gridColumn=columns;
	div.style.gridRow=rows;
}
// *** istouch
function is_touch_device() {
 return (('ontouchstart' in window)
      || (navigator.MaxTouchPoints > 0)
      || (navigator.msMaxTouchPoints > 0));
}
// *** MouseOut
function DoOnMouseout(event) {
    //this is the original element the event handler was assigned to
    let e = event.toElement || event.relatedTarget;
    let ep=e;
    while(ep!=document.body){
        if(ep == this) {return}
        ep=ep.parentNode;
    }
    this.DoOnMouseout(event);
}
// *** remove item 
function array_remove_item(a,i){
    if(i>-1&&i<a.length){
        return a.slice(0,i).concat(a.slice(i+1))
    } else {return a}
}
// *** save and load
function download(filename, text) {
  var element = document.createElement('a');
  element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  element.setAttribute('download', filename);

  element.style.display = 'none';
  document.body.appendChild(element);

  element.click();

  document.body.removeChild(element);
}
function GetIfigure(){
    let contents=[];
    for(let l=0;l<ballab.ifigure_objects.length;l++){
        contents.push(ballab.ifigure_objects[l].save());
    }
    let ifigure={metadata:ballab.metadata,contents:contents};
    let ifigure_JSON=JSON.stringify(ifigure);
    if(ifigure_JSON.search('-->')>-1){throw {message:'cannot use "-->" in ballab anywhere, including comments'}}
    return ifigure;
}
function SaveAs(){
    let script="\<script\>";
    let scripte="\<\/script\>";
    let markup=ballab.document_markup;
    {// remove Weizmann website additions to the head
        let Wiz_s='<!-- End of head, anything else up to the </head> will be removed -->'
        let Wiz_n=markup.search(Wiz_s)+Wiz_s.length
        let head_n=markup.slice(Wiz_n).search('</head>')+Wiz_n
        markup=markup.slice(0,Wiz_n)+markup.slice(head_n)
    }// remove Weizmann website additions to the head
    let n_ifigure_s=markup.search('<!--ifigure')+'<!--ifigure'.length;
    let n_ifigure_o=magic.indexOf_after_index(markup,'{',n_ifigure_s);
    let n_ifigure_e=magic.indexOf_closing_parenthesis(markup,'{','}',n_ifigure_o);
    let ifigure_s=markup.slice(n_ifigure_o,n_ifigure_e+1);
    let n_ifigure_endcomment=markup.search('-->')+'-->'.length
    let oppening_string='<!DOCTYPE html>\n <html> \n <head> \n';
    let ballab_string=markup.slice(n_ifigure_endcomment);   
    let ifigure_JSON=JSON.stringify(GetIfigure());
	let ifigure_string="<!--ifigure\n"+ifigure_JSON+"\nifigure-->";
	filename=prompt('Save as:')+".ifig.html"
	download(filename,oppening_string+ifigure_string+ballab_string);
}
// *** help
function HelpFunctions(){
    let help_fun_container=document.createElement("div");
    help_fun_container.className="help-functions-container";
    var title = document.createElement("p");
    var node = document.createTextNode("ifigures Functions");
    title.appendChild(node);
    title.style.color='white'
    help_fun_container.appendChild(title)
    let help_fun_div=document.createElement("div");
    help_fun_div.className="help-functions"
    help_fun_container.appendChild(help_fun_div)
    document.body.appendChild(help_fun_container);
    let categories=['Figure','Math','Time']
    categories.map(cat=>{
        let a=document.createElement('a');
        a.style.color='white';  a.text=cat + " Category"; a.style.display="block"; a.style.fontWeight="bold"; a.style.font="inherit"
        help_fun_div.appendChild(a)
        let ifuns=ballab.Ifunctions.filter(ifun=>ifun.category==cat)
        let ifunnames=ifuns.map(ifun=>ifun.name).sort()
        ifunnames.map(name=>{
            let a=document.createElement('a');
            a.style.color='cyan'
            a.value=name
            a.text=name
            a.style.display="block"
            a.onclick=function(){
                let ifun=ballab.Ifunctions.find(obj=>obj.name==name)
                alert(ifun.name+':\n'+ifun.help)
            }
            help_fun_div.appendChild(a)
        })    
    })
    
    
    let help_close=document.createElement("BUTTON");
    help_close.className="help-functions-close-top"
    var t = document.createTextNode("Close");
    help_close.appendChild(t);
    help_close.onclick=function(){document.body.removeChild(help_fun_container)}
    help_fun_container.appendChild(help_close)
    
}
// *** load from file
function LoadIfigureFile(){
    let dropArea=document.createElement("div")
    dropArea.className="load-file-drop-area"
    let form=document.createElement("form")
    let para=document.createElement("p")
    let node = document.createTextNode("Upload an ifigure .html.ifig file by dragging and dropping it into the dashed region");
    para.appendChild(node);
    form.appendChild(para);
    let input=document.createElement("INPUT")
    input.type="file"; 
    form.appendChild(input)
    dropArea.appendChild(form)
    document.body.appendChild(dropArea)
    input.style.display="none"
    input.accept=".html,.txt"; 
    input.multiple=true;
    input.onchange="handleFiles(this.files)"; 
    let reader = new FileReader();
    reader.onload = function(e) {
      let text = reader.result;
      let ifigure_s=FileToIfigureString(text)
      print(ifigure_s);
      localStorage.ballabIfigureFile=ifigure_s;
      ReloadIfigureLocalStorageFile();
    }
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false)
    })

    function preventDefaults (e) {
      e.preventDefault()
      e.stopPropagation()
    }  
    ;['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false)
    })
    ;['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false)
    })
    function highlight(e) {
      dropArea.classList.add('highlight')
    }
    function unhighlight(e) {
      dropArea.classList.remove('highlight')
    }
    dropArea.addEventListener('drop', handleDrop, false)
    function handleDrop(e) {
      let dt = e.dataTransfer
      let files = dt.files
      console.log(files[0])

      handleFiles(files)
    }
    function handleFiles(files) {
      ([...files]).forEach(uploadFile)
    }
    function uploadFile(file) {
      reader.readAsText(file)
    } 
}
// *** save/load local storage
function SaveIfigureLocalStorage(){
    let ifigure=JSON.stringify(GetIfigure());
    localStorage.ballabIfigure=ifigure;
    print('ifigure saved')
}
function LoadURL(){
    if(location.search.length>0){
    let URLobjs=decodeURIComponent(location.search).slice(1);
    return JSON.parse(URLobjs);
    } else {return {}}
}
function LoadLocal(){
    let ifigure_s=FileToIfigureString(ballab.document_markup)
    ballab.ifigure0=JSON.parse(ifigure_s);
    ifigureSetup()
}
function FileToIfigureString(markup){
    let n_ifigure_s=markup.search('<!--ifigure')+'<!--ifigure'.length;
    let n_ifigure_o=magic.indexOf_after_index(markup,'{',n_ifigure_s);
    let n_ifigure_e=markup.search('ifigure-->');
    let ifigure_s=markup.slice(n_ifigure_o,n_ifigure_e);
    return ifigure_s
}
function LoadIfigureURL(){
    ballab.ifigure0=ballab.URLobj.ifigure;
    ifigureSetup()
}
function LoadIfigureLocalStorage(){
    if(localStorage.ballabIfigure!=undefined){
        ballab.ifigure0=JSON.parse(localStorage.ballabIfigure);
        ifigureSetup()
    }
    else{
        alert('There is no ifigure saved in this browser.')
    }
    
}
function LoadIfigureLocalStorageFile(){
    if(localStorage.ballabIfigureFile!=undefined){
        ballab.ifigure0=JSON.parse(localStorage.ballabIfigureFile);
        ifigureSetup()
    }
    else{
        alert('There is no ifigure saved in this browser.')
    }
    
}
function ReloadIfigureLocalStorage(){
    if(localStorage.ballabIfigure!=undefined){
        let URL = [location.protocol, '//', location.host, location.pathname].join('');
        let URLobj={options:{load:'LocalStorage'}};
        let URLquery='?'+encodeURIComponent(JSON.stringify(URLobj));
        window.location.href=URL+URLquery
    }
    else{
        alert('There is no ifigure saved in this browser.')
    }
}
function ReloadIfigureLocalStorageFile(){
    if(localStorage.ballabIfigureFile!=undefined){
        let URL = [location.protocol, '//', location.host, location.pathname].join('');
        let URLobj={options:{load:'LocalStorageFile'}};
        let URLquery='?'+encodeURIComponent(JSON.stringify(URLobj));
        window.location.href=URL+URLquery
    }
    else{
        alert('There is no ifigure saved in this browser.')
    }
}
function LoadIfigureFileURL(fileURL){
    let xhttp = new XMLHttpRequest()
    xhttp.onreadystatechange = function(){
      if (this.readyState == 4 && this.status == 200){
        let ifigure_s=FileToIfigureString(this.response)
        ballab.ifigure0=JSON.parse(ifigure_s);
        ifigureSetup()
      }
    };
    xhttp.open("GET", fileURL, true)
    xhttp.send()  
}

// * export URL    
function ExportCopyURL(){
    let URL=ExportToURL();
    print('URL length is '+URL.length)
    let message
    if(URL.length>2000){
        alert(
            'This ifigure is too large to be converted to an URL.'
        )
    }
    else{
        prompt(
            'The URL is provided below and can be copied using ctrl+c (Windows) or command+c (Mac)\n',
            ExportToURL()
        )
    }
}
function ExportToURL(){
    let ifigure=GetIfigure();
    let URLobj={options:{load:'URL'},ifigure:ifigure};
    let URLquery='?'+encodeURIComponent(JSON.stringify(URLobj));
    let Weizmann=ballab.metadata.URL;
    return Weizmann+URLquery
}
// *** instructions
function AlertInstructions(){
    if(ballab.instructions.contents!=""){alert(ballab.instructions.contents)}
    else{print("There are no instructions provided")}
}
function ChangeInstructions(){
    ballab.instructions.contents=prompt('Modify the instructions below',ballab.instructions.contents)
}
    
// *** about ifigures
function Aboutifigures(){
alert(
'ifigures version '+ballab.metadata.version +'\n\n'
+
`Technical help: Sagi Yaacobi, Uri Barenholtz, Shlomi Kotler, Andy Hubert, Amir Kedem, Gilad Katz. Other Support: Moshe Amar, Subo Dong, Daniel Katz, Ben Katz, Erez Rosenzweig, Liantong Luo, De-Shalit 11'th grade physics class at Schwartz/Reisman, Alon Shaham.

ifigures Copyright (c) 2018 Boaz Katz, Weizmann Institute of Science & Schwartz/Reisman Science Education Center, Rehovot, Israel. Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions: The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.`
)
}  
// *** Style
function setCSSClassStyle(class_name,prop,val){
    let Elems=document.getElementsByClassName(class_name);
        for(let i=0; i<Elems.length; i++) {
            Elems[i].style[prop]=val;
        }
}

// *** ifigure setup
function ifigureSetup(){
    {// *** sidebar setup
        ballab.sidebar=new cellLib.Sidebar();
        cellLib.main_window.appendChild(ballab.sidebar.div); 
        {//** outputs that are continoually evalued (every 0.1 sec)
            let exps=ballab.ifigure0.contents.filter(
                obj => {
                  return obj.type=='Conteval'
                })
            if(exps.length>0){
                for(let l=0;l<exps.length;l++){
                    let expr=new cellLib.Conteval(exps[l]);
                    ballab.sidebar.div.appendChild(expr.div)
                    ballab.ifigure_objects.push(expr);
                }
            }
        }//** outputs that are continoually evalued (every 0.1 sec)
        {//** terminal
            let terminal=new cellLib.Terminal();
            ballab.terminal=terminal;
            ballab.sidebar.div.appendChild(terminal.div)
            print=function(stuff){terminal.print(stuff)};
            clc=function(){terminal.clc()};
            ErrorPrint=function(err){terminal.ErrorPrint(err)};
        }//** terminal
    }// *** sidebar setup
    {// *** iscript setup    
        let isc_lib_cp=ballab.ifigure0.contents.find(obj=>(obj.type=='iscriptLibrary'))
        let iscriptLibrary=new magic.IscriptLibrary(isc_lib_cp)
        ballab.iscriptLibrary=iscriptLibrary;
        ballab.ifigure_objects.push(iscriptLibrary);
        deleteIscript=function(name){
            let codes=ballab.ifigure_objects.filter(v=>v.type=='Cell_code');
            let desplayedIscripts=codes.map(v=>v.iscript);
            let iscript=ballab.iscriptLibrary.getIscriptByName(name);
            if(desplayedIscripts.indexOf(iscript)>-1){throw({message:'this iscript is currently displayed and cannot be removed'})}
            iscript.RemoveMe();
            eval('delete ' + name)
            print('deleted iscript ' + name)
        }
    }// *** iscript setup
    {// *** figure setup
        is_this_touch_device=is_touch_device();

        let figure_c=ballab.ifigure0.contents.find(
            obj => {
              return obj.type=='Figure'
            })
        if(!(figure_c==undefined)){
        {//** set ballab figure
            ballab.figure_current=new figureLib.Figure(figure_c)
            ballab.figure_current.move_to(1,2);
            ballab.figures=[ballab.figure_current];
            ballab.ifigure_objects.push(ballab.figure_current);
        }//** set ballab figure
        }   
    }// *** figure setup
    {// *** cell_code setup
        {//** single run code cells
            let codes=ballab.ifigure0.contents.filter(
                obj => {
                  return obj.type=='Cell_code'
                })
            if(codes.length>0){
                for(let l=0;l<codes.length;l++){
                    let code=new cellLib.Cell_code(codes[l],ballab.iscriptLibrary);
                    code.move_to(1,1);
                    ballab.ifigure_objects.push(code);
                }
            }
        }//** single run code cells
        {//** repeat code cell
            let code_repeat_c=ballab.ifigure0.contents.find(
                obj => {
                  return obj.type=='Cell_code_repeat'
                })
            if(!(code_repeat_c==undefined)){
            let code_repeat=new cellLib.Cell_code_repeat(code_repeat_c);
            code_repeat.move_to(1,1);
            ballab.ifigure_objects.push(code_repeat);
            ballab.repeat_cell=code_repeat;
            Stop=function(){code_repeat.Stop()}
            Go=function(){code_repeat.Go()}
            }
        }//** repeat code cell
        {//** figure xlim and ylim
            ballab.figure_current.xlim(-5,5);
            ballab.figure_current.ylim(-5,5);
        }//** figure xlim and ylim
    }// *** cell_code setup
    {//*** instructions setup
        class Instructions{
            constructor(copy){
                this.type='Instructions'
                this.name=copy.name
                this.contents=copy.contents
            }
            save(){
                let copy={}
                copy.type='Instructions'
                copy.name=this.name
                copy.contents=this.contents
                return copy
            }
        }
        let inst=ballab.ifigure0.contents.find(obj=>(obj.type=='Instructions'))
        if(inst!=undefined){ballab.instructions=new Instructions(inst)}
        else{ballab.instructions=new Instructions({name:"Instructions",contents:""})}
        ballab.ifigure_objects.push(ballab.instructions);

    }// *** instructions setup
    if(ballab.iscriptLibrary.getIscriptByName('OnLoadIfigure')!=undefined){setTimeout(OnLoadIfigure,500)}
}
</script><!-- internal functions -->
<script>//<!-- ifigures setup -->
// consts:
const pi=Math.PI
const ii={Re:0,Im:1,isComplexNumber:true};
const xmlns = "http://www.w3.org/2000/svg";
{// *** ifigures setup
    {//*** initiate ballab global variable
        ballab={};
        let URL_dir="https://webhome.weizmann.ac.il/home/ifigures/";
        ballab.metadata={
            platform:"ifigures",
            version:"2023.1.4.1",
            previous_version:"2022.12.7.1",
            modifications:"Fixed bug: in previous versions, URL could not have queries without addressing the load setup. Now it can. To achieve this, the *** load ifigure setup cell and the LoadURL() function were modified. Queries still need to be given in a JASON format. The resulting parsed object is saved in ballab.URLobj as before. If no query is provided the ballab.URLobj is an empty (but defined) object",
            URL_dir:URL_dir,
            URL:URL_dir+"ifigure.ifig.html"
        }
        ballab.document_markup = document.documentElement.innerHTML;
        ballab.ifigure_objects=[];
    }// *** initiate ballab global variable    
    {// *** import libraries (from this file)
        cellLib=import_cellLib();
        figureLib=import_figureLib();
        magic=import_MagicSyntax();
        topMenuLib=import_topMenuLib();
    }// *** import libraries (from this file)
    {//** style
        document.body.style.background="#616161"
        ballab.SetCodeFontSize=function(){
            //let Elems=document.getElementsByClassName('codearea');
            let size=prompt('Set the font size of the code areas')
            setCSSClassStyle('codearea', 'fontSize', size+'px')
        }
    }// *** style
    {//*** math setup
        {// *** Array
            Array.prototype.at=function(inds){
                if(Array.isArray(inds)){return inds.map(i=>this[i])}
                else{return this[inds]}
            }
            Array.prototype.atTrue=function(flags){
                let arr=[]
                for(let l=0;l<Math.min(flags.length,this.length);l++){
                    if(flags[l]){arr.push(this[l])}
                }
                return arr;
            }
        }// *** Array
        {// *** Complex Numbers and functions 
        // Numbers are not Complex but have Im=0 and Re=number for calculations.
            Number.prototype.isComplexNumber=false;
            Number.prototype.Im=0;
            Object.defineProperty(Number.prototype,"Re",{get:function(){return this}});
            Object.prototype.isComplexNumber=false;
            ComplexNumber=function(Re,Im){
                if(isNaN(Re)||isNaN(Im)){return NaN}
                if(typeof Re=='undefined'||typeof Im=='undefined'){return undefined}
                if(Im==0){return Re}
                else{return {Re:Re,Im:Im,isComplexNumber:true}}
            }
            Object.prototype.toStringReg=Object.prototype.toString;
            Object.prototype.toString=function(){
                if(this.isComplexNumber){return this.Re+' + '+this.Im+ ' * ii'}
                else {return this.toStringReg}
            }
        }//// *** Complex Numbers
    }// *** math setup
    {// *** top menu
        let top_menu=new topMenuLib.TopMenu(document.body);
        ballab.top_menu=top_menu;
        let TopMenuList=topMenuLib.TopMenuList;
        let TopMenuItem=topMenuLib.TopMenuItem;
        
        let balla=new TopMenuList('ifigures',top_menu)
        new TopMenuItem('About ifigures',balla,Aboutifigures)
        new TopMenuItem('Set code font size',balla,ballab.SetCodeFontSize)
        let file=new TopMenuList('File',top_menu)
        new TopMenuItem('Download as .html file',file,SaveAs)
        new TopMenuItem('Save to browser',file,SaveIfigureLocalStorage)
        new TopMenuItem('Load last browser save',file,ReloadIfigureLocalStorage)
        new TopMenuItem('Load from file',file,LoadIfigureFile)
        let inst=new TopMenuList('Instructions',top_menu)
        new TopMenuItem('Read Instructions',inst,AlertInstructions)
        new TopMenuItem('Change Instructions',inst,ChangeInstructions)
        let help=new TopMenuList('Help',top_menu)
        new TopMenuItem('Functions',help,HelpFunctions)
        //new TopMenuItem('Instructions on loading...',file,HelpInstructionsOnload)
    }// *** top menu
    document.body.appendChild(cellLib.main_window);//  must be after top menu setup
    {// *** Ifunctions setup
        ballab.Ifunctions=[];
        Ifunction=function(copy){
            let ifun=new magic.Ifunction(copy)
            ballab.Ifunctions.push(ifun)
        }
        function ArrayFun1arg(zs,funs){
            if(!Array.isArray(zs)){
                if(typeof zs=='undefined'){return undefined}
                else{return funs(zs)}
            } else {return zs.map(z=>ArrayFun1arg(z,funs))}
        }
        function ArrayFun1arg1par(zs,p,funs){
                if(!Array.isArray(zs)){
                    if(typeof zs=='undefined'){return undefined}
                    else{return funs(zs,p)}
                } else {return zs.map(z=>ArrayFun1arg1par(z,p,funs))}
            }
        function ArrayFun2args(as,bs,funs){
            let aisA=Array.isArray(as),bisA=Array.isArray(bs);
            if(!aisA&&!bisA){
                if(typeof as=='undefined' || typeof bs=='undefined'){return undefined}
                else{return funs(as,bs)}
            }
            if(aisA&&!bisA){return as.map(a=>ArrayFun2args(a,bs,funs))}
            if(!aisA&&bisA){return bs.map(b=>ArrayFun2args(as,b,funs))}
            if(aisA&&bisA){
                if(as.length!=bs.length){throw {message:'array lengths must be the same'}}
                else {return as.map((a,i)=>ArrayFun2args(a,bs[i],funs))}
            }
        }
        IfunctionArray=function(copy){
            let fullcopy={
                name:copy.name,
                help:copy.help,
                category:'Math',
                fun:function(zs){return ArrayFun1arg(zs,copy.funs)}
            }
            Ifunction(fullcopy)
        }
        IfunctionArray1par=function(copy){
            let fullcopy={
                name:copy.name,
                help:copy.help,
                category:'Math',
                fun:function(zs,p){return ArrayFun1arg1par(zs,p,copy.funs)}
            }
            Ifunction(fullcopy)
        }
        IfunctionArray2args=function(copy){
            let fullcopy={
                name:copy.name,
                help:copy.help,
                category:'Math',
                fun:function(as,bs){return ArrayFun2args(as,bs,copy.funs)}
            }
            Ifunction(fullcopy)
        }
    }// *** Ifunctions setup
    {// *** ballab special functions
        {//** syntax
            magic_syntax=magic.magic_syntax;
        }//** syntax     
        {//** Timing setup
            ballab.Timer=(function(){
                let Timer={};
                let d=new Date();
                let timer_start_time_seconds=d/1000;
                Timer.restart=function(){let d= new Date(); timer_start_time_seconds=d/1000; return 0}
                Timer.now=function(){let d= new Date(); return d/1000-timer_start_time_seconds}
                return Timer;
            })()
        }//** Timing
        {// *** Youtube setup
            ballab.youtube={};
            ballab.youtube.API_set=false;
            ballab.youtube.current_videoId=null;
            ballab.youtube.player=null;
            ballab.youtube.ready=false;
            ballab.youtube.xmin=-5;
            ballab.youtube.xmax=5;
            ballab.youtube.ymin=-5;
            ballab.youtube.ymax=5;
            YoutubePlayerSet=function(xmin,xmax,ymin,ymax){
                if(!ballab.youtube.API_set){
                    YoutubeAPISet();
                } else if (ballab.youtube.player==null){
                    let image=ballab.figure_current.image;   
                    if(arguments.length>0){
                        image.xlim(xmin,xmax);
                        image.ylim(ymin,ymax);
                    }
                    let youtube_div=document.createElement("div");
                    youtube_div.id='youtube_div';
                    youtube_div.className='video';
                    image.stage.appendChild(youtube_div);
                    image.stage.style.visibility="visible";
                    ballab.youtube.div=youtube_div;
                    ballab.youtube.player = new YT.Player('youtube_div', {
                        height: '390',
                        width: '390',
                        videoId: ballab.youtube.current_videoId,
                        events: {
                            'onReady': function(){
                                print('Youtube player is ready')
                                ballab.youtube.ready=true;
                                YoutubePlay();
                            },
                            'onStateChange': function(event){event[0]},
                        }
                    });
                }
            }
            YoutubeAPISet=()=>{
                let youtube_tag = document.createElement('script');
                youtube_tag.src = "https://www.youtube.com/iframe_api";
                let firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(youtube_tag, firstScriptTag);
                print('Loading YoutubeAPI...');
                // 3. This function creates an <iframe> (and YouTube player)
                //    after the API code downloads.
            }
            onYouTubeIframeAPIReady=function(){
                print('YoutubeAPI is ready');
                ballab.youtube.API_set=true;
                YoutubePlayerSet();
            }
        }//** Youtube
    }// *** ballab special functions
    {// *** overwrite ctrl+save
        document.addEventListener("keydown", function(e) {
            if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
            e.preventDefault();
            SaveAs();
            }
        }, false);
    }// *** overwrite ctrl+save
}// *** ballab setup  
{// *** ballab functions
{//** figure functions
    {// ** plot
        Ifunction({//plot
            name:'plot',
            fun:function(xs,ys,type_str='b.'){
                return new figureLib.Curve(ballab.figure_current,xs,ys,type_str)},
            category:'Figure',
            help:`2D plot. Syntax: plot(x,y,s), x and y are arrays of real numbers and s is a string containing simbol and color. Can use less arguments with defaults: x=[],y=[],s="b.". Returns handle to the resulting curve using Syntax like h=plot(x,y,s). With handle can update data using h.set_data(x,y).  Examples: plot([1,2,3],[2,4,6],"b"); creates a scatter plot with blue dots. h=plot(); h.set_data([1,2,3],[6,7,8]).`
        })//plot
        Ifunction({//xlim
            name:'xlim',
            fun:function(xmin,xmax){ballab.figure_current.xlim(xmin,xmax)},
            category:'Figure',
            help:'Set limit of x-axis in the figure. Syntax: xlim(xmin,xmax)'
        })//xlim
        Ifunction({//ylim
            name:'ylim',
            fun:function(ymin,ymax){ballab.figure_current.ylim(ymin,ymax)},
            category:'Figure',
            help:'Set limit of y-axis in the figure. Syntax: xlim(xmin,xmax)'
        })//ylim
        Ifunction({//xlabel
            name:'xlabel',
            fun:function(str){ballab.figure_current.xlabel(str)},
            category:'Figure',
            help:'Set label of x-axis in the figure. Syntax: xlabel(label), where label is a string.'
        })//xlabel
        Ifunction({//ylabel
            name:'ylabel',
            fun:function(str){ballab.figure_current.ylabel(str)},
            category:'Figure',
            help:'Set label of y-axis in the figure. Syntax: ylabel(label), where label is a string.'
        })//ylabel
        Ifunction({//clf
            name:'clf',
            fun:function(){ballab.figure_current.clf()},
            category:'Figure',
            help:'Clear figure (equivalent to clicking the trash can button). Syntax: clf()'
        })//clf
    }//** plot
    {// ** Cross-hair pointings
        Ifunction({//PointingX
            name:'PointingX',
            fun:function(){return ballab.figure_current.crosshair_position.pos.x},
            category:'Figure',
            help:'Returns x-value of the cross-hair as long as the cross-hair button is down (and NaN otherwise). Syntax: x=PointingX()'
        })//PointingX
        Ifunction({//PointingY
            name:'PointingY',
            fun:function(){return ballab.figure_current.crosshair_position.pos.y},
            category:'Figure',
            help:'Returns the y-value of the cross-hair as long as the cross-hair button is down (and NaN otherwise). Syntax: y=PointingY()'
        })//PointingY
        Ifunction({//PointingsX
            name:'PointingsX',
            fun:function(){return ballab.figure_current.crosshair_position.pointings.x},
            category:'Figure',
            help:'Returns array of all x-values of pointings on the figure with the cross-hair. Syntax: x=PointingsX()'
        })//PointingsX
        Ifunction({//PointingsY
            name:'PointingsY',
            fun:function(){return ballab.figure_current.crosshair_position.pointings.y},
            category:'Figure',
            help:'Returns array of all y-values of pointings on the figure with the cross-hair. Syntax: y=PointingsY()'
        })//PointingsY
        Ifunction({//PointingsReset
            name:'PointingsReset',
            fun:function(){ballab.figure_current.crosshair_position.pointings.x=[]; ballab.figure_current.crosshair_position.pointings.y=[]},
            category:'Figure',
            help:'Empties memory of previous pointings on the figure with the cross-hair. Syntax: PointingsReset()'
        })//PointingsReset
    }//** Cross-hair pointings 
    {//** Shapes and Text
        Ifunction({//Circle
            name:'Circle',
            fun:function(x=0,y=0,r=1,color='blue'){
                if(typeof x!='number'){throw {message:'x must be a number'}}
                return new figureLib.Circle(ballab.figure_current,x,y,r,color)
            },
            category:'Figure',
            help:'Creates a filled Circle centered at x,y with radius r and given color. Syntax: Circle(x,y,r,color), x,y and r are real numbers (r>0) and color is a string with a color name like "b", "blue", "#0000FF". Can use less arguments with defaults: x=0, y=0, r=1, color="blue". Circle returns a handle to the resulting Circle allowing changes. Example: C=Circle(); C.x=2; C.color="green";'
        })//Circle
        Ifunction({//Point
            name:'Point',
            fun:function(x=0,y=0,color='blue',r=1.5){
                if(typeof x!='number'){throw {message:'x must be a number'}}
                return new figureLib.Point(ballab.figure_current,x,y,r,color)
            },
            category:'Figure',
            help:'Creates a filled Circle centered at x,y with fixed radius r in pixels and given color. Unlike Circle, when axis changes (e.g. zoom) the position will be updated but the shape and size will not be affected. Syntax: Point(x,y,color,r), x,y and r are real numbers (r>0) and color is a string with a color name like "b", "blue", "#0000FF". Can use less arguments with defaults: x=0, y=0, r=1.5, color="blue". Point returns a handle to the resulting Point allowing changes. Example: P=Point(); P.x=2; P.color="green"; P.r=5'
        })//Point
        Ifunction({//Rectangle
            name:'Rectangle',
            fun:function(xs=[-1,1],ys=[-1,1],color="blue"){
            return new figureLib.Rectangle(ballab.figure_current,xs,ys,color)},
            category:'Figure',
            help:'Creates a filled rectangle. Syntax: Rectangle(xrange,yrange,color), xrange and yrange are each an array of two real numbers specifying the range in the x-axis and y-axis (default for each is [-1,1]). color is a string with a color name like "b", "blue", or "#0000FF". Rectangle can use less arguments with defaults: xrange=[-1,1], yrange=[-1,1], color="blue". Rectangle returns a handle to the resulting rectangle allowing changes (e.g. R=Rectangle(); R.xrange=[-3,3]; R.color="red"). '
        })//Rectangle
        Ifunction({//Polygon
            name:'Polygon',
            fun:function(xs,ys,color="blue"){return new figureLib.Polygon(ballab.figure_current,xs,ys,color)},
            category:'Figure',
            help:'Creates a filled polygon with vertices coordinates given by arrays xs, ys. Syntax: Polygon(xs,ys,color), xs and ys must be arrays of real numbers with equal length (at least 3). color is a string with a color name like "b", "blue", or "#0000FF". color can be omitted with a default value col="blue". xs and ys must be provided. Polygon returns a handle to the resulting polygon allowing changes (e.g. P=Polygon([1,2,3],[0,1,0]); P.color="red"'
        })//Polygon
        Ifunction({//Line
            name:'Line',
            fun:function(xs,ys,type_str="blue",line_width=2){return new figureLib.Line(ballab.figure_current,xs,ys,type_str,line_width)},
            category:'Figure',
            help:`2D line or curve. Syntax: Line(x,y,s,line_width), x and y are arrays of real numbers of the points that define the line or curve (broken line if more than two points), s is a string containing simbol and color such as "red-" (red solid), "blue--" (blue dashed) etc. similar to plot, and line_width is a number that sets the line width in pixels. Can use less arguments with defaults: x=[],y=[],s="blue-",line_width=2. Returns handle to the resulting curve using Syntax like h=Line(x,y). With handle can update data using h.set_data(x,y). Can also update x and y separately using h.xs=x or h.ys=y (as long as length of new x or y is consistent with the length of the existing y or x, useful for moving: e.g. h.xs+=1). Can update color using h.color='red' and dashed property using h.dash='--' or h.dash=':'. Examples: Line([1,2],[2,4]) or  Line([1,2],[2,4],"b") create a straight blue solid line. h=Line([1,2,3],[1,1,4]); creates a broken blue solid line. If add h.set_data([1,2,3],[1,1,1]) the line will become horizontal. Line width can be accessed and changed using h.line_width, e.g. h.line_width=5. note that the line width is measured in pixels`
        })//Line
        Ifunction({//Ellipse
            name:'Ellipse',
            fun:function(x=0,y=0,rx=1,_ry,color="blue"){
                if(arguments.length>3){ry=_ry} else {ry=rx}
                return new figureLib.Ellipse(ballab.figure_current,x,y,rx,ry,color)
            },
            category:'Figure',
            help:'Creates a filled Ellipse centered at x,y with semi-width rx and semi-height ry. Syntax: Ellipse(x,y,rx,ry,color). x,y, rx and ry are real numbers (rx,ry >0) and color is a string with a color name like "b", "blue", or "#0000FF". Ellipse can use less arguments with defaults: x=0, y=0, rx=1, ry=rx, color="blue". Ellipse returns a handle to the resulting ellipse allowing changes e.g. E=Ellipse(); E.x=2; E.rx=4; E.ry=2; E.color="red". '

        })//Ellipse 
        Ifunction({//Text
            name:'Text',
            fun:function(value="",x=0,y=0,color="black"){
            return new figureLib.Text(ballab.figure_current,value,x,y,color)},
            category:'Figure',
            help:'Creates text at position x,y on the figure with given color. Syntax: Text(value,x,y,color), where value is the string with the required text and x and y are real numbers. Text can use less arguments with defaults: value="", x=0, y=0, color="black". Text returns a handle to the resulting text allowing changes e.g. T=Text("hellow"); T.x=2; T.color="red". To change text size can use T.style.fontSize, e.g. T.style.fontSize=20'
        })//Text
    }//** Shapes and Text
    {//** image
        Ifunction({//** ImageLoad
            name:'ImageLoad',
            fun:function(src,xmin,xmax,ymin,ymax) {
                let image=ballab.figure_current.image;
                if(image.stage.firstChild){image.clear()}
                let Im = document.createElement("IMG");
                Im.onload = function () {
                    let nW=this.naturalWidth;
                    let nH=this.naturalHeight;
                    let W=xmax-xmin;
                    let H=ymax-ymin;
                    let r=(nH/nW)/(H/W)
                    if(r<=1){
                        Im.setAttribute("width", 390);
                        Im.setAttribute("height", 390*r);
                        Im.pixels_per_unit=nW/W;
                    }
                    else {
                        Im.setAttribute("width", 390/r);
                        Im.setAttribute("height",390);
                        Im.pixels_per_unit=nH/H;
                    }
                }
                Im.setAttribute("src", src);
                image.stage.appendChild(Im);
                image.stage.style.visibility="visible";                
                image.xlim(xmin,xmax);
                image.ylim(ymin,ymax);
                return Im;
            },
            category:'Figure',
            help:'Load Image into figure. Syntax: ImageLoad(src,xmin,xmax,ymin,ymax), src is a string with a url pointing to an image on the internet, xmin,xmax,ymin,ymax set the size and location of the box within the figure where the image is shown.'
        })//** ImageLoad
        Ifunction({//** ImageClear
            name:'ImageClear',
            fun:function() {
                ballab.figure_current.image.clear();          
            },
            category:'Figure',
            help:'Clear image from figure. Syntax: ImageClear()'
        })//** ImageClear
    }//** Image
    {//** Youtube
        Ifunction({//** YoutubeLoad
            name:'YoutubeLoad',
            fun:function(videoId,xmin,xmax,ymin,ymax){
                if(arguments.length>1){
                    ballab.figure_current.image.xlim(xmin,xmax)
                    ballab.figure_current.image.ylim(ymin,ymax)
                }
                ballab.youtube.current_videoId=videoId;
                if(ballab.youtube.player==null){YoutubePlayerSet()}
                else if(ballab.youtube.div.parentNode==null){ballab.youtube.player=null;YoutubePlayerSet()}
                else{
                    print('Loading Video...')
                    ballab.youtube.player.loadVideoById(ballab.youtube.current_videoId)
                    ballab.figure_current.image.xlim(xmin,xmax);
                    ballab.figure_current.image.ylim(ymin,ymax);
                }
            },
            category:'Figure',
            help:'Load youtube video into the figure. Syntax: YoutubeLoad(videoId,xmin,xmax,ymin,ymax), where the id is the short youtube id (a sequence of about 11 letters and numbers), and xmin,xmax,ymin,ymax are the boundaries of the video in the figure. You have to wait until the message "Youtube player is ready" is printed in the terminal to use other commands line YoutubePlay() and YoutubePause().'
        })//** YoutubeLoad
        Ifunction({//** YoutubePlay
            name:'YoutubePlay',
            fun:function(){if(ballab.youtube.ready){ballab.youtube.player.playVideo()}},
            category:'Figure',
            help:'Play youtube video that is already loaded from current location. Syntax: YoutubePlay()',
        })//** YoutubePlay
        Ifunction({//** YoutubePause
            name:'YoutubePause',
            fun:function(){if(ballab.youtube.ready){ballab.youtube.player.pauseVideo()}},
            category:'Figure',
            help:'Pause a youtube video that is currently playing. Syntax: YoutubePause()',
        })//** YoutubePause
        Ifunction({//** YoutubeGoTo
            name:'YoutubeGoTo',
            fun:function(tseconds){if(ballab.youtube.ready){ballab.youtube.player.seekTo(tseconds)}},
            category:'Figure',
            help:'Go to a specific time in a loaded Youtube video. Syntax: YoutubeGoTo(time)  where time is in seconds from beggining of the video',
        })//** YoutubeGoTo
        Ifunction({//** YoutubeTime
            name:'YoutubeTime',
            fun:function(){if(ballab.youtube.ready){return ballab.youtube.player.getCurrentTime()}},
            category:'Figure',
            help:'Return current time within a loaded youtube video. Syntax t=YoutubeTime(), t will be in seconds from the beggining of the video and will change when the video is playing or when YoutubeGoTo is used.',
        })//** YoutubeTime
    }//** Youtube
}//** figure functions
{// ** Math functions 
    Ifunction({//random
        name:'random',
        fun:function(){return Math.random()},
        category:'Math',
        help:'Creates a random number uniformly distributed between 0 and 1. Syntax random()'
    })//random
    Ifunction({//hypot
        name:'hypot',
        fun:Math.hypot,
        category:'Math',
        help:'Returns the square root of the sum of squares of its arguments. Syntax: hypot(x1,x2,x3,...), where x1,x2,x3... are real numbers'
    })//hypot
    Ifunction({//arange
        name:'arange',
        fun:function(xi,xf,dx){
            let x=[];
            let N=Math.floor((xf-xi)/dx);
            if(xi+N*dx < xf){N++}
            for(let l=0;l<N;l++){
                x.push(xi+l*dx)
            }
            return x;
        },
        category:'Math',
        help:'Returns an array of real numbers with uniform intervals, set by an initial value xi, an interval value dx and a terminal value xf [xi,xi+dx,xi+2dx,...], stopping before xf (i.e. not including xf). Syntax: arange(xi,xf,dx), where xi,xf, dx are real numbers. Equivalent to syntax: [xi:dx:xf].  '
    })//arange
    Ifunction({//diff
        name:'diff',
        fun:function(x){
            let diffx=[];
            for(let l=0;l<x.length-1;l++){
                diffx.push( Operators.subtract.fun(x[l+1],x[l]) );
            }
            return diffx;
        },
        category:'Math',
        help:'Returns an array of differences of the values of x, with x[i+1]-x[i] in position i. The returned array is one element shorter than the input array x.'
    })//diff
    Ifunction({//findtrue
        name:'findtrue',
        fun:function(arr){
            return arr.reduce((inds,v,i)=>{if(v>0){inds.push(i)}; return inds},[])
        },
        category:'Math',
        help:'Returns an array of indexes i where arr(i)==true or arr(i)>0. syntax: inds=find(arr)'
    })//findtrue
    Ifunction({//linspace
        name:'linspace',
        fun:function(xi,xf,N){
            let x=[xi];
            let dx=(xf-xi)/(N-1);
            for(let l=1;l<(N-1);l++){
                x.push(xi+l*dx)
            }
            x.push(xf);
            return x;
        },
        category:'Math',
        help:'Returns an array of N real numbers with uniform intervals, set by an initial value xi and terminating at a given terminal value xf (including xf). Syntax: linspace(xi,xf,N), where xi,xf are real numbers and N is a positive integer' 
    })//linspace
    Ifunction({//max
        name:'max',
        fun:function(x){
            let maxx
            if(Array.isArray(x)){
            maxx=x[0];
            for(var l=1;l<x.length;l++){
                if(x[l]>maxx){maxx=x[l]}
            }
            } else {maxx=x}
            return maxx;
        },
        category:'Math',
        help:'Returns maximal number among an array of real numbers. Syntax: max(x), where x is an array of real numbers.'
    })//max
    Ifunction({//mid
        name:'mid',
        fun:function(x){
            let midx=[];
            for(let l=0;l<x.length-1;l++){
                midx.push( Operators.divide.fun( Operators.add.fun(x[l+1],x[l]) , 2.0 ) );
            }
            return midx;
        },
        category:'Math',
        help:'Returns an array of running averages of each pair values of x, with (x[i+1]+x[i])/2 in position i. The returned array is one element shorter than the input array x.'
    })//mid
    Ifunction({//min
        name:'min',
        fun:function(x){
            let minx
            if(Array.isArray(x)){
            minx=x[0];
            for(var l=1;l<x.length;l++){
                if(x[l]<minx){minx=x[l]}
            }
            } else {minx=x}
            return minx;
        },
        category:'Math',
        help:'Returns minimal number among an array of real numbers. Syntax: min(x), where x is an array of real numbers.'
    })//min
    Ifunction({//interp
        name:'interp',
        fun:function(xdata,ydata,x){
            // xdata and x need to be real and sorted
            let isxArray=Array.isArray(x);
            if(!isxArray){x=[x]}
            let y=x.map(v=>NaN);
            let ldata=0,Ndata=xdata.length;
            for(let i=0;i<x.length;i++){
                let xi=x[i];
                while(xdata[ldata+1]<xi){ldata++}
                let xd=xdata[ldata],xd1=xdata[ldata+1], yd=ydata[ldata], yd1=ydata[ldata+1];
                if(xi==xd){y[i]=yd}
                else if(xi>xd && xi<=xd1){
                    y[i]=Operators.divide.fun(Operators.add.fun(Operators.multiply.fun(xi-xd,yd1),Operators.multiply.fun(xd1-xi,yd)),xd1-xd)
                }
                else {throw {message:'out of range'}}
            }
            if(isxArray){return y}
            else{return y[0]}
        },
        category:'Math',
        help:'Linear interpolation. Syntax: interp(xdata,ydata,x), where xdata, ydata are arrays (with equal length) of sample points. xdata must contain real sorted numbers. x is a sorted array of real numbers (or one real number) within the range of xdata for which the interpolation of ydata is required.'
    })//interp
    Ifunction({//sort
        name:'sort',
        fun:function(x){let copy=x.map(v=>v); return copy.sort((v1,v2)=>v1-v2)},
        category:'Math',
        help:'Returns a sorted copy for a given array of real numbers x. Syntax sort(x). For other types of values consider the native javascript x.sort()'
    })//sort
    
    IfunctionArray({//conj
        name:'conj',
        funs:function(z){
            if(typeof z=='number'){return z}
            if(z.isComplexNumber){return ComplexNumber(z.Re,-z.Im)}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Complex conjugate. Syntax: conj(x)'
    })//conj
    IfunctionArray({//real
        name:'real',
        funs:function(z){
            if(typeof z=='number'){return z}
            if(z.isComplexNumber){return z.Re}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Real component of complex number. Syntax: real(x)'
    })//real
    IfunctionArray({//imag
        name:'imag',
        funs:function(z){
            if(typeof z=='number'){return 0}
            if(z.isComplexNumber){return z.Im}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Imaginary component of complex number. Syntax: imag(x)'
    })//imag
    IfunctionArray({//abs
        name:'abs',
        funs:function(z){
            if(typeof z=='number'){return Math.abs(z)}
            if(z.isComplexNumber){return Math.sqrt(z.Im**2+z.Re**2)}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Absolute value of number or complex number. Syntax: abs(x)'
    })//abs
    IfunctionArray({// exp
        name:'exp',
        funs:function(z){
            if(typeof z=='number'){return Math.exp(z)}
            if(z.isComplexNumber){
                    let A=Math.exp(z.Re);
                    return ComplexNumber(A*Math.cos(z.Im),A*Math.sin(z.Im));
            }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Exponential function. Syntax: exp(x)'
    })//exp
    IfunctionArray({//expm1
        name:'expm1',
        funs:function(z){
            if(typeof z=='number'){return Math.expm1(z)}
            if(z.isComplexNumber){
                throw {message:'Not implemented for Complex numbers'}
            }
            else {throw {message:'argument should be array, or real number'}}
        },
        help:'Exponential function minus 1 accurately (exp(x)-1). Currently implemented only for real numbers. Syntax: expm1(x)'
    })//expm1
    IfunctionArray({//log
        name:'log',
        funs:function(z){
            if(typeof z=='number' && (z>=0 || isNaN(z)) ){return Math.log(z)}
            if(z.isComplexNumber||z<0){
                    return ComplexNumber(
                        Math.log(Math.sqrt(z.Re**2+z.Im**2)),
                        Math.atan2(z.Im,z.Re)
                    )
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Natural Logarithm. Syntax: log(x)'
    })//log
    IfunctionArray({//sqrt
        name:'sqrt',
        funs:function(z){
            if( typeof z=='number' && (z>=0 || isNaN(z)) ){return Math.sqrt(z)}
            if(z.isComplexNumber||z<0){
                    return Operators.power.fun(z,0.5);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Square root. Syntax: sqrt(x)'
        })//sqrt
    IfunctionArray({//cos
        name:'cos',
        funs:function(z){
            if(typeof z=='number'){return Math.cos(z)}
            if(z.isComplexNumber){
                    let iz=ComplexNumber(-z.Im,z.Re);
                    let miz=ComplexNumber(z.Im,-z.Re);
                    let numerator=Operators.add.fun(exp(iz),exp(miz));
                    return ComplexNumber(numerator.Re/2,numerator.Im/2);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Cosine of argument in radians, Syntax: cos(x)'
    })//cos
    IfunctionArray({//sin
        name:'sin',
        funs:function(z){
            if(typeof z=='number'){return Math.sin(z)}
            if(z.isComplexNumber){
                    let iz=ComplexNumber(-z.Im,z.Re);
                    let miz=ComplexNumber(z.Im,-z.Re);
                    let numerator=Operators.subtract.fun(exp(iz),exp(miz));
                    return ComplexNumber(numerator.Im/2,-numerator.Re/2);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Sine of argument in radians. Syntax: sin(x)'
    })//sin
    IfunctionArray({//tan
        name:'tan',
        funs:function(z){
            if(typeof z=='number'){return Math.tan(z)}
            if(z.isComplexNumber){
                    return Operators.divide.fun(sin(z),cos(z))
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Tangent of argument in radians. Syntax: tan(x)'
    })//tan
    IfunctionArray({//acos
        name:'acos',
        funs:function(z){
            if(typeof z=='number' && ( (z<=1 && z>=-1) || isNaN(z)) ){return Math.acos(z)}
            if(z.isComplexNumber || z>1 || z<-1){
                    let s_one_m_z2=sqrt(
                        ComplexNumber(
                            1-(z.Re**2-z.Im**2),
                            -2*z.Re*z.Im)
                    );
                    let log_iz_plus_s=log(
                        ComplexNumber(-z.Im+s_one_m_z2.Re,
                                      z.Re+s_one_m_z2.Im)
                    );
                    return ComplexNumber(0.5*pi-log_iz_plus_s.Im,log_iz_plus_s.Re);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Inverse cosine in radians. Syntax: acos(x)'
    })//acos
    IfunctionArray({//asin
        name:'asin',
        funs:function(z){
            if(typeof z=='number' && ( (z <=1 && z>=-1) || isNaN(z) ) ){return Math.asin(z)}
            if(z.isComplexNumber  || z>1 || z<-1){
                    let s_one_m_z2=sqrt(ComplexNumber(1-(z.Re**2-z.Im**2),-2*z.Re*z.Im));
                    let log_iz_plus_s=log(ComplexNumber(-z.Im+s_one_m_z2.Re,z.Re+s_one_m_z2.Im));
                    return ComplexNumber(log_iz_plus_s.Im,-log_iz_plus_s.Re);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Inverse sine in radians. Syntax: asin(x)'
    })//asin
    IfunctionArray({//atan
        name:'atan',
        funs:function(z){
            if(typeof z=='number'){return Math.atan(z)}
            if(z.isComplexNumber){
                    let log_one_m_iz=log(ComplexNumber(1+z.Im,-z.Re));
                    let log_one_p_iz=log(ComplexNumber(1-z.Im,z.Re));
                    return ComplexNumber(
                        -0.5*(log_one_m_iz.Im-log_one_p_iz.Im),
                        0.5*(log_one_m_iz.Re-log_one_p_iz.Re)    
                    );
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Inverse tangent in radians. Syntax: atan(x)'
    })//atan 
    IfunctionArray2args({//atan2
        name:'atan2',
        funs:function(y,x){
            if(typeof y=='number' && typeof x=='number'){return Math.atan2(y,x)}
            else {throw {message:'arguments should be arrays or real numbers'}}
        },
        help:'Polar angle in radians given real cartezian coordinates x,y (Four-quadrant inverse tangent). Syntax: atan2(y,x)'
    })//atan2
    Ifunction({//cosd
        name:'cosd',
        fun:function(x){return cos(Operators.multiply.fun(x,pi/180))},
        category:'Math',
        help:'Cosine of argument in degrees. Syntax: cosd(x)'
    })//cosd
    Ifunction({//sind
        name:'sind',
        fun:function(x){return sin(Operators.multiply.fun(x,pi/180))},
        category:'Math',
        help:'Sine of argument in degrees. Syntax: sind(x)'
    })//sind
    Ifunction({//tand
        name:'tand',
        fun:function(x){return tan(Operators.multiply.fun(x,pi/180))},
        category:'Math',
        help:'Tangent of argument in degrees. Syntax: tand(x)'
    })//tand
    Ifunction({//acosd
        name:'acosd',
        fun:function(x){return Operators.multiply.fun(acos(x),180/pi)},
        category:'Math',
        help:'Inverse cosine in degrees. Syntax: acosd(x)'
    })//acosd
    Ifunction({//asind
        name:'asind',
        fun:function(x){return Operators.multiply.fun(asin(x),180/pi)},
        category:'Math',
        help:'Inverse sine in degrees. Syntax: asind(x)'
    })//asind 
    Ifunction({//atand
        name:'atand',
        fun:function(x){return Operators.multiply.fun(atan(x),180/pi)},
        category:'Math',
        help:'Inverse Tangent in degrees. Syntax: atand(x)'
    })//atand
    Ifunction({//atan2d
        name:'atan2d',
        fun:function(y,x){return Operators.multiply.fun(atan2(y,x),180/pi)},
        category:'Math',
        help:'Polar angle in degrees given cartezian coordinates x,y. Syntax: atan2d(y,x)'
    })//atan2d
    IfunctionArray({//cosh
        name:'cosh',
        funs:function(z){
            if(typeof z=='number'){return Math.cosh(z)}
            if(z.isComplexNumber){
                    let mz=ComplexNumber(-z.Re,-z.Im);
                    let numerator=Operators.add.fun(exp(z),exp(mz));
                    return ComplexNumber(numerator.Re/2,numerator.Im/2);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Hyperbolic cosine. Syntax: cosh(x)'
    })//cosh
    IfunctionArray({//sinh
        name:'sinh',
        funs:function(z){
            if(typeof z=='number'){return Math.sinh(z)}
            if(z.isComplexNumber){
                    let mz=ComplexNumber(-z.Re,-z.Im);
                    let numerator=Operators.subtract.fun(exp(z),exp(mz));
                    return ComplexNumber(numerator.Re/2,numerator.Im/2);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Hyperbolic sine. Syntax: sinh(x)'
    })//sinh
    IfunctionArray({//tanh
        name:'tanh',
        funs:function(z){
            if(typeof z=='number'){return Math.tanh(z)}
            if(z.isComplexNumber){
                    return Operators.divide.fun(sinh(z),cosh(z));
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Hyperbolic Tangent. Syntax: tanh(x)'
    })//tanh
    IfunctionArray({//acosh
            name:'acosh',
            funs:function(z){
                if(typeof z=='number' && (z>0 || isNaN(z) ) ){return Math.acosh(z)}
                if(z.isComplexNumber || z<=0){
                        let acosz=acos(z);
                        return ComplexNumber(-acosz.Im,acosz.Re);
                    }
                else {throw {message:'argument should be array, number or complex number'}}
            },
            help:'Inverse hyperbolic cosine. Syntax: acosh(x)'
    })//acosh
    IfunctionArray({//asinh
        name:'asinh',
        funs:function(z){
            if(typeof z=='number'){return Math.asinh(z)}
            if(z.isComplexNumber){
                    let miz=ComplexNumber(z.Im,-z.Re);
                    let asinmiz=asin(miz);
                    return ComplexNumber(-asinmiz.Im,asinmiz.Re);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Inverse hyperbolic sine. Syntax: asinh(x)'
    })//asinh
    IfunctionArray({//atanh
        name:'atanh',
        funs:function(z){
            if(typeof z=='number' && ( (z>-1 && z<1) || isNaN(z) ) ){return Math.atanh(z)}
            if(z.isComplexNumber || z>1 || z<-1){
                    let miz=ComplexNumber(z.Im,-z.Re);
                    let atanmiz=atan(miz);
                    return ComplexNumber(-atanmiz.Im,atanmiz.Re);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Inverse hyperbolic tangent. Syntax: atanh(x)'
    })//atanh
    IfunctionArray({//log10
        name:'log10',
        funs:function(z){
            if(typeof z=='number'){return Math.log10(z)}
            if(z.isComplexNumber){
                    let ln10=2.302585092994046;
                    let logz=log(z);
                    return ComplexNumber(logz.Re/ln10,logz.Im/ln10);
                }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Logarithm in base 10. Syntax: log10(x)'
    })//log10 
    IfunctionArray1par({//round
        name:'round',
        funs:function(z, decimals=0){
            if(decimals==0 && typeof z=='number'){return Math.round(z)}
            if(typeof z=='number'){return Number(z.toFixed(decimals))}
            if(z.isComplexNumber){return ComplexNumber(
                Number(z.Re.toFixed(decimals)),
                Number(z.Im.toFixed(decimals))
            )}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Round number to specified decimal point (default integer). Syntax: round(x) or round(x,decimalplace) where decimalplace is an integer equal or larger than 0. round(x) is equivalent to round(x,0)'})//round
    IfunctionArray1par({//roundSignificant
        name:'roundSignificant',
        funs:function(z,n){
            if(typeof z=='number'){
                return Number(z.toPrecision(n));
            }
            if(z.isComplexNumber){return ComplexNumber(Number(z.Re.toPrecision(n)),Number(z.Im.toPrecision(n)))}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Round number to n significant digits. Syntax: roundSignificant(x,n)'})//roundSignificant
    IfunctionArray({//floor
        name:'floor',
        funs:function(z){
            if(typeof z=='number'){return Math.floor(z)}
            if(z.isComplexNumber){return ComplexNumber(Math.floor(z.Re),Math.floor(z.Im))}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Round down to closest smaller integer. For negative numbers floor results in a more negative number. Syntax: floor(x)'
    })//floor
    IfunctionArray({//ceil
        name:'ceil',
        funs:function(z){
            if(typeof z=='number'){return Math.ceil(z)}
            if(z.isComplexNumber){return ComplexNumber(Math.ceil(z.Re),Math.ceil(z.Im))}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Rounds to closest larger integer. For negative numbers result is a less negative number. Syntax: ceil(x)'})//ceil
    IfunctionArray({//trunc
        name:'trunc',
        funs:function(z){
            if(typeof z=='number'){return Math.trunc(z)}
            if(z.isComplexNumber){return ComplexNumber(Math.trunc(z.Re),Math.trunc(z.Im))}
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Returns the intiger part of a number by truncating any fractional digits. For negative numbers result is a less negative number. Syntax: trunc(x)'
    })//trunc
    IfunctionArray({//sign
        name:'sign',
        funs:function(z){
            if(typeof z=='number'){return Math.sign(z)}
            if(z.isComplexNumber){
                let te=Math.atan2(z.Im,z.Re)
                return ComplexNumber(Math.cos(te),Math.sin(te))
            }
            else {throw {message:'argument should be array, number or complex number'}}
        },
        help:'Sign of number. For real numbers returns either -1 or +1 depending on sign. For Complex numbers returns a complex number with the same polar angle and with magnitude 1. Syntax: sign(x)'})//sign
    Ifunction({//sum
        name:'sum',
        fun:function(x){
            let s;
            if(Array.isArray(x)){
                if(x.length>0){
                    s=x[0]
                    for(let l=1;l<x.length;l++){
                        s=Operators.add.fun(s,x[l]);
                    }
                } else {s=0};
            } else {s=x}
            return s;
        },
        category:'Math',
        help:'Sum of array. Syntax sum(x)'
    })//sum
}//** Math functions
{//** Timing
    Ifunction({
        name:'tic',
        fun:ballab.Timer.restart,
        category:'Time',
        help:'Start stopwatch. Syntax: tic(). Can read time of stopwatch using t=toc().'
    })
    Ifunction({
        name:'toc',
        fun:function(){return ballab.Timer.now()},
        category:'Time',
        help:'Returns time of stopwatch. Syntax: t=toc(), returns to t the time since stopwatch was started. Stopwatch is started when the ifigure is loaded and can be restarted using tic().'
    })
    Ifunction({
        name:'RepeatGo',
        fun:function(){ballab.repeat_cell.Go()},
        category:'Time',
        help:'Starts the "Repeat every ___ seconds" loop. \n Syntax: RepeatGo()'
    })
    Ifunction({
        name:'RepeatStop',
        fun:function(){ballab.repeat_cell.Stop()},
        category:'Time',
        help:'Stops the "Repeat every ___ seconds" loop.\n Syntax: RepeatStop()'
    })
}//** Timing
}// *** ballab functions
{// *** load ifigure
 ballab.URLobj=LoadURL()
    if(ballab.URLobj.options){
        switch(ballab.URLobj.options.load){
            case 'URL':
                LoadIfigureURL();
            break;
            case 'LocalStorage':
                LoadIfigureLocalStorage();
            break
            case 'LocalStorageFile':
                LoadIfigureLocalStorageFile();
            break
            case 'FileURL':
                ballab.ifigure0=LoadIfigureFileURL(URLobj.ifigureFileURL);
            break
            case 'Self':
                LoadLocal()
            break
            default:
                LoadLocal()
        }
    }  else {LoadLocal()} 
}// *** load ifigure

</script></body>